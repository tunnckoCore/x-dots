/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2017 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

*/
function momoInit(){return!0}function validateEmail(e){var t=/[^@]+@[^@]+\.[^@]+/;return t.test(e)}function getQueryParameter(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))}function getActiveDateString(){var e=new Date;return activeDateStringForDate(e)}function activeDateStringForDate(e){var t=new Date(e);t.getHours()<5&&(t=new Date(t.getTime()-864e5));var i=t.getFullYear().toString()+"-"+twoDigit(t.getMonth()+1)+"-"+twoDigit(t.getDate());return i}function twoDigit(e){var t=parseInt(e),i=t>=10?t:"0"+t.toString();return i.toString()}function submitStats(e){}function setMomentumAuthHeader(e){if(localStorage.token&&e.setRequestHeader("Authorization","Bearer "+localStorage.token),localStorage.client_uuid&&e.setRequestHeader("X-Momentum-ClientId",localStorage.client_uuid),e.setRequestHeader("X-Momentum-Version",m.globals.version),e.setRequestHeader("X-Momentum-ClientDate",getActiveDateString()),m.conditionalFeatures.featureEnabled("allowoptions")){var t=localStorage.getItem("X-Momentum-Options");t&&e.setRequestHeader("X-Momentum-Options",t)}localStorage.activeTags&&e.setRequestHeader("X-Momentum-Tags",localStorage.activeTags)}function isDateInFuture(e){return Date.parse(e)>Date.parse(new Date)}function setEndOfContenteditable(e){var t,i;document.createRange&&(t=document.createRange(),t.selectNodeContents(e),t.collapse(!1),i=window.getSelection(),i.removeAllRanges(),i.addRange(t))}window.m=_.extend({$window:$(window),appView:"",globals:{},models:{},collect:{},views:{},react:{mixins:{}},addins:{},utils:{},bootstrappers:{},commands:{},templates:{},widgets:[]},Backbone.Events),Backbone.View=function(e){return e.extend({constructor:function(t){this.options=t||{},e.apply(this,arguments)}})}(Backbone.View);var backboneSync=Backbone.sync;Backbone.sync=function(e,t,i){i.beforeSend=function(e){setMomentumAuthHeader(e)},backboneSync(e,t,i)},m.templates=m.templates||{},m.templates.background=m.templates.background||{},m.templates.background["background-info"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="background-info-title">'+(null!=(s=null!=(s=t.title||(null!=e?e.title:e))?s:a,o=typeof s===l?s.call(e,{name:"title",hash:{},data:n}):s)?o:"")+'<i class="icon-angle-right"></i></span>\n<span class="background-info-source">\n    <span class="background-info-source-link" data-url="'+r((s=null!=(s=t.sourceUrl||(null!=e?e.sourceUrl:e))?s:a,typeof s===l?s.call(e,{name:"sourceUrl",hash:{},data:n}):s))+'">'+(null!=(s=null!=(s=t.attribution||(null!=e?e.attribution:e))?s:a,o=typeof s===l?s.call(e,{name:"attribution",hash:{},data:n}):s)?o:"")+'</span><span class="control control-heart '+r((s=null!=(s=t.fav_class||(null!=e?e.fav_class:e))?s:a,typeof s===l?s.call(e,{name:"fav_class",hash:{},data:n}):s))+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.centerclock=m.templates.centerclock||{},m.templates.centerclock.clock=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h1 class="time">'+l((o=null!=(o=t.time||(null!=e?e.time:e))?o:s,typeof o===a?o.call(e,{name:"time",hash:{},data:n}):o))+'</h1>\n<span class="format">'+l((o=null!=(o=t.format||(null!=e?e.format:e))?o:s,typeof o===a?o.call(e,{name:"format",hash:{},data:n}):o))+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.focus=m.templates.focus||{},m.templates.focus["focus-prompt-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<h3>What is your main focus for today?</h3>\n<input type="text">'},useData:!0}),m.templates.focus["focus-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return"<h3>"+l((o=null!=(o=t.day||(null!=e?e.day:e))?o:s,typeof o===a?o.call(e,{name:"day",hash:{},data:n}):o))+'</h3>\n<span class="control checkbox"><i class="icon icon-checkbox-empty focus-open"></i><i class="icon icon-checkbox focus-done"></i></span><p class="todays-focus">'+l((o=null!=(o=t.focus||(null!=e?e.focus:e))?o:s,typeof o===a?o.call(e,{name:"focus",hash:{},data:n}):o))+'</p><span class="control delete"><i>✕</i></span>\n'},useData:!0}),m.templates.focus["focuses-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<ol></ol>\n<div class="message focus-message">\n    <i class="loading-icon"></i>Loading...</span>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.greeting=m.templates.greeting||{},m.templates.greeting["greeting-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h2>Good <span class="period">'+l((o=null!=(o=t.period||(null!=e?e.period:e))?o:s,typeof o===a?o.call(e,{name:"period",hash:{},data:n}):o))+'</span>, <span class="name" spellcheck="false">'+l((o=null!=(o=t.name||(null!=e?e.name:e))?o:s,typeof o===a?o.call(e,{name:"name",hash:{},data:n}):o))+"</span>.</h2>"},useData:!0}),m.templates=m.templates||{},m.templates.introduction=m.templates.introduction||{},m.templates.introduction["introduction-button-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<button class="button">'+this.escapeExpression((o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"value",hash:{},data:n}):o))+"</button>"},useData:!0}),m.templates.introduction["introduction-content-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<div class="prompt">\n    <div id="introduction-question">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:n}):o))+'</div>\n    <input id="introduction-input" type="text">\n    <div class="tip"></div>\n</div>\n<div class="buttons"></div>'},useData:!0}),m.templates.introduction["introduction-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<p class="logo"><img src="img/logo-white.svg"></p>\n<p class=content></p>\n'},useData:!0}),m.templates.introduction["introduction-tip-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return"<div>"+this.escapeExpression((o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"value",hash:{},data:n}):o))+"</div>"},useData:!0}),m.templates=m.templates||{},m.templates.metric=m.templates.metric||{},m.templates.metric.widget=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div><span class="metric-stat">'+l((o=null!=(o=t.statvalue||(null!=e?e.statvalue:e))?o:s,typeof o===a?o.call(e,{name:"statvalue",hash:{},data:n}):o))+'</span></div><span class="metric-label">'+l((o=null!=(o=t.statlabel||(null!=e?e.statlabel:e))?o:s,typeof o===a?o.call(e,{name:"statlabel",hash:{},data:n}):o))+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.notification=m.templates.notification||{},m.templates.notification.notification=Handlebars.template({1:function(e,t,i,n){var o,s;return'<div class="notification-title">'+(null!=(o=t["if"].call(e,null!=e?e.icon_url:e,{name:"if",hash:{},fn:this.program(2,n,0),inverse:this.noop,data:n}))?o:"")+" "+this.escapeExpression((s=null!=(s=t.title||(null!=e?e.title:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"title",hash:{},data:n}):s))+"</div>"},2:function(e,t,i,n){var o;return'<img src="'+this.escapeExpression((o=null!=(o=t.icon_url||(null!=e?e.icon_url:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"icon_url",hash:{},data:n}):o))+'" style="height: 20px">'},4:function(e,t,i,n){var o;return'<button class="notification-button">'+this.escapeExpression((o=null!=(o=t.cta_text||(null!=e?e.cta_text:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"cta_text",hash:{},data:n}):o))+"</button>"},6:function(e,t,i,n){var o;return'<span class="button-text secondary-text">'+this.escapeExpression((o=null!=(o=t.secondary_text||(null!=e?e.secondary_text:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"secondary_text",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return'<div class="pane widget-pop nipple-bottom-left notification">\n    <span class="hide notification-hide">✕</span>\n    '+(null!=(o=t["if"].call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'\n    <div class="notification-description">'+this.escapeExpression((s=null!=(s=t.message||(null!=e?e.message:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"message",hash:{},data:n}):s))+"</div>\n    "+(null!=(o=t["if"].call(e,null!=e?e.cta_cmd:e,{name:"if",hash:{},fn:this.program(4,n,0),inverse:this.noop,data:n}))?o:"")+(null!=(o=t["if"].call(e,null!=e?e.secondary_cmd:e,{name:"if",hash:{},fn:this.program(6,n,0),inverse:this.noop,data:n}))?o:"")+"\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.quicklinks=m.templates.quicklinks||{},m.templates.quicklinks["quicklinks-item-template"]=Handlebars.template({1:function(e,t,i,n){return' class="local"'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div draggable="true" class="view '+r((s=null!=(s=t.classes||(null!=e?e.classes:e))?s:a,typeof s===l?s.call(e,{name:"classes",hash:{},data:n}):s))+'">\n    <a draggable="false" href="'+r((s=null!=(s=t.url||(null!=e?e.url:e))?s:a,typeof s===l?s.call(e,{name:"url",hash:{},data:n}):s))+'"'+(null!=(o=t["if"].call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'><img src="'+r((s=null!=(s=t.favicon_url||(null!=e?e.favicon_url:e))?s:a,typeof s===l?s.call(e,{name:"favicon_url",hash:{},data:n}):s))+'"> '+r((s=null!=(s=t.title||(null!=e?e.title:e))?s:a,typeof s===l?s.call(e,{name:"title",hash:{},data:n}):s))+'</a>\n    <span draggable="false" class="control destroy">✕</span>\n</div>\n'},useData:!0}),m.templates.quicklinks["quicklinks-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pane-container quicklinks-wrapper nipple-top-left">\n    <div class="pane quicklinks-pane">\n        <ol>\n            <li><a href="chrome-search://local-ntp/local-ntp.html" class="local"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozNUExQ0NERUQxMjIxMUU0QThCQkIwMDhCNEE2NDg4MyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozNUExQ0NERkQxMjIxMUU0QThCQkIwMDhCNEE2NDg4MyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjM1QTFDQ0RDRDEyMjExRTRBOEJCQjAwOEI0QTY0ODgzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjM1QTFDQ0RERDEyMjExRTRBOEJCQjAwOEI0QTY0ODgzIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+9GSZXwAAAItJREFUeNrslLEOgCAMRKkOfrmDiT8MamoxlElxKmW4JhdCbuBI+o6YOXjOFJwHARBgiACrKIq4o2J5N5D0wCnn7PD5JFpyAM8moiF24HJ6O2mATS8d5xDtuoTogbceqJxa+60eeDgVmfp/PUAlsZnfwlDJMPW/MKyYWPtDYAgKQAEoQAAEcJ1bgAEAiqqzy70omloAAAAASUVORK5CYII=" class="icon-chrome-tab" > Chrome Tab</a></li>\n            <li><a href="chrome://apps" id="app-return" class="local"><i class="icon icon-th"></i> Apps</a></li>\n        </ol>\n        <div class="message connection-message"><i class="loading-icon"></i>Loading...</div>\n        <div class="error-message">Connection required to add link</div>\n        <span class="control add">+</span>\n        <ul class="message link-hint">\n            <li class="empty">\n                <span class="empty-title">Add your favorite links</span>\n                <span class="empty-description">Use the <strong><span class="icon">+</span> button</strong> above</span>\n                <span class="hide">✕</span>\n            </li>\n        </ul>\n        <div class="quicklinks-new">\n            <input id="quicklinks-new-title" class="title-input" type="text" placeholder="Title">\n            <input id="quicklinks-new-url" class="address-input" type="text" placeholder="Address">\n        </div>\n    </div>\n</div>\n<span class="quicklinks-show top-nav toggle" href="">Links</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.quote=m.templates.quote||{},m.templates.quote.quote=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<p class="quote-body">\n\t<span class="quote-body-text">&ldquo;'+l((o=null!=(o=t.body||(null!=e?e.body:e))?o:s,typeof o===a?o.call(e,{name:"body",hash:{},data:n}):o))+'&rdquo;</span><i class="icon-angle-right"></i>\n\t<span class="quote-source"><span class="quote-source-text">'+l((o=null!=(o=t.source||(null!=e?e.source:e))?o:s,typeof o===a?o.call(e,{name:"source",hash:{},data:n}):o))+'</span><span class="control control-heart '+l((o=null!=(o=t.fav_class||(null!=e?e.fav_class:e))?o:s,typeof o===a?o.call(e,{name:"fav_class",hash:{},data:n}):o))+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span><span data-url="'+l((o=null!=(o=t.twitterIntentUrl||(null!=e?e.twitterIntentUrl:e))?o:s,typeof o===a?o.call(e,{name:"twitterIntentUrl",hash:{},data:n}):o))+'" class="control control-twitter"><i class="icon icon-twitter"></i></span></span>\n</p>'},useData:!0}),m.templates=m.templates||{},m.templates.settings=m.templates.settings||{},m.templates.settings.about=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<div class="pop-body settings-about">\n\t<img src="icon-512.png" class="about-logo about-logo-light">\n\t<h3>Momentum</h3>\n\t<p class="made">Personal Dashboard <span id="momo-version">v'+this.escapeExpression((o=null!=(o=t.version||(null!=e?e.version:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"version",hash:{},data:n}):o))+'</span></p>\n\t<p class="thanks">Thank you for your support!</p>\n\t<p class="links">\n\t\t<a href="http://momentumdash.com/help" target="_blank">Feedback</a>\n\t\t<a href="http://momentumdash.com" target="_blank">Website</a>\n\t\t<a href="https://www.facebook.com/momentumdash" target="_blank">Facebook</a>\n\t\t<a href="https://twitter.com/momentumdash" target="_blank">Twitter</a>\n\t</p>\n\t<p class="footer">\n\t\tMade with &#9829; in beautiful BC, Canada\n\t</p>\n</div>\n'},useData:!0}),m.templates.settings["color-picker-popup"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="cp-color-picker nipple-bottom-right">\n    <div class="cp-xy-slider">\n        <div class="cp-white"></div>\n        <div class="cp-xy-cursor"></div>\n    </div>\n    <div class="cp-z-slider">\n        <div class="cp-z-cursor"></div>\n    </div>\n    <div class="cp-alpha-container">\n        <div class="cp-alpha">\n            <div class="cp-alpha-cursor"></div>\n        </div>\n    </div>\n</div>'},useData:!0}),m.templates.settings["color-picker"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="swatch-container"><div class="swatch" style="background: #222;"></div></div>'},useData:!0}),m.templates.settings.connect=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="back action action-back"><i class="icon icon-angle-left"></i></span>\n\n<section class="provider">\n\t<div class="provider-logo-box">\n\t\t<img src="'+l((o=null!=(o=t.large_icon_url||(null!=e?e.large_icon_url:e))?o:s,typeof o===a?o.call(e,{name:"large_icon_url",hash:{},data:n}):o))+'" class="provider-logo">\n\t</div>\n\t<h2 class="provider-title">Connect to '+l((o=null!=(o=t.provider_title||(null!=e?e.provider_title:e))?o:s,typeof o===a?o.call(e,{name:"provider_title",hash:{},data:n}):o))+'</h2>\n</section>\n<!--<section class="extra-info">-->\n\t<!--<label for="blah">Please enter your account name</label>-->\n\t<!--<input type="text" name="blah" id="blah" class="input">-->\n<!--</section>-->\n<p class="description">A secure window will open.</p>\n<section class="button-group">\n\t<span id="connect-button" class="button">Connect</span>\n\t<p class="description">Momentum won\'t ever have access to your login information.</p>\n</section>\n'},useData:!0}),m.templates.settings["general-toggle-options"]=Handlebars.template({1:function(e,t,i,n){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,n,o,s){var a;return null!=(a=t.unless.call(e,n&&n.last,{name:"unless",hash:{},fn:this.program(4,n,0,o,s),inverse:this.program(9,n,0,o,s),data:n}))?a:""},4:function(e,t,i,n,o,s){var a,l,r=this.lambda,d=this.escapeExpression,c=t.helperMissing,h="function";return'                <span class="toggle-option '+d(r(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+d(r(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+d((l=null!=(l=t.value||(null!=e?e.value:e))?l:c,typeof l===h?l.call(e,{name:"value",hash:{},data:n}):l))+'><div class="sub-view"></div>'+d((l=null!=(l=t.label||(null!=e?e.label:e))?l:c,typeof l===h?l.call(e,{name:"label",hash:{},data:n}):l))+"</span>"+(null!=(a=t["if"].call(e,null!=e?e.breakafter:e,{name:"if",hash:{},fn:this.program(5,n,0,o,s),inverse:this.program(7,n,0,o,s),data:n}))?a:"")+"\n"},5:function(e,t,i,n){return"<br>"},7:function(e,t,i,n){return' <span class="toggle-divider">|</span> '},9:function(e,t,i,n,o,s){var a,l=this.lambda,r=this.escapeExpression,d=t.helperMissing,c="function";return'                <span class="toggle-option '+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+r((a=null!=(a=t.value||(null!=e?e.value:e))?a:d,typeof a===c?a.call(e,{name:"value",hash:{},data:n}):a))+'><div class="sub-view"></div>'+r((a=null!=(a=t.label||(null!=e?e.label:e))?a:d,typeof a===c?a.call(e,{name:"label",hash:{},data:n}):a))+"</span>\n"},11:function(e,t,i,n){var o;return'<span class="option-message">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n,o,s){var a,l,r=t.helperMissing,d="function",c=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+c((l=null!=(l=t.widget||(null!=e?e.widget:e))?l:r,typeof l===d?l.call(e,{name:"widget",hash:{},data:n}):l))+'">\n    <span class="setting-name">'+c((l=null!=(l=t.name||(null!=e?e.name:e))?l:r,typeof l===d?l.call(e,{name:"name",hash:{},data:n}):l))+"</span>\n    "+(null!=(a=t["if"].call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,n,0,o,s),inverse:this.noop,data:n}))?a:"")+'\n\t<span class="toggle-options">\n'+(null!=(a=t.each.call(e,null!=e?e.options:e,{name:"each",hash:{},fn:this.program(3,n,0,o,s),inverse:this.noop,data:n}))?a:"")+"    </span>\n    "+(null!=(a=t["if"].call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(11,n,0,o,s),inverse:this.noop,data:n}))?a:"")+'\n    <div class="option-clear"></div>\n</li>\n'},useData:!0,useDepths:!0}),m.templates.settings["general-toggle-slider"]=Handlebars.template({1:function(e,t,i,n){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,n){return'<span class="badge beta-badge">Preview</span>'},5:function(e,t,i,n){var o;return'<span class="option-message">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+r((s=null!=(s=t.widget||(null!=e?e.widget:e))?s:a,typeof s===l?s.call(e,{name:"widget",hash:{},data:n}):s))+'">\n\t<input type="checkbox"></input>\n\t<span class="setting-name">'+r((s=null!=(s=t.name||(null!=e?e.name:e))?s:a,typeof s===l?s.call(e,{name:"name",hash:{},data:n}):s))+"</span>\n\t"+(null!=(o=t["if"].call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+"\n\t"+(null!=(o=t["if"].call(e,null!=e?e.beta:e,{name:"if",hash:{},fn:this.program(3,n,0),inverse:this.noop,data:n}))?o:"")+'\n\t<span class="toggle-slider"><span class="toggle-switch"></span></span>\n\t'+(null!=(o=t["if"].call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(5,n,0),inverse:this.noop,data:n}))?o:"")+"\n</li>\n"},useData:!0}),m.templates.settings.general=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <div class="user">\n            <nav class="user-actions">\n                <span class="action plan">Account</span><span class="action action-logout">Logout</span>\n            </nav>\n            <div class="user-avatar">\n                <div class="user-gravatar">\n                    <img src="">\n                </div>\n                <span class="badge plus-badge">PLUS</span>\n            </div>\n            <span class="name">'+l((o=null!=(o=t.displayname||(null!=e?e.displayname:e))?o:s,typeof o===a?o.call(e,{name:"displayname",hash:{},data:n}):o))+'</span><br>\n            <span class="email">'+l((o=null!=(o=t.email||(null!=e?e.email:e))?o:s,typeof o===a?o.call(e,{name:"email",hash:{},data:n}):o))+"</span>\n        </div>\n"},3:function(e,t,i,n){return'        <div class="user login">\n            <span class="name">Login</span>\n            <span class="action">Sync account and more!</span>\n        </div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return'<div class="pop-body">\n'+(null!=(o=t["if"].call(e,null!=e?e.loggedIn:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.program(3,n,0),data:n}))?o:"")+'\n\n    <h4>Show</h4>\n    <ul id="widgets-list" class="settings-list options-list"></ul>\n\n\n    <h4>Customize</h4>\n    <ul id="customize-list" class="settings-list options-list"></ul>\n\n\n    <h4>Options</h4>\n    <ul id="misc-list" class="settings-list options-list"></ul>\n\n\n    <h4>Account Sync</h4>\n    <ul class="settings-list options-list">\n        <li class="slide-toggle sync-option">\n            <input class="sync-check" type="checkbox"></input>\n            <span class="sync-caption setting-name">Account Sync</span>\n            <span class="toggle-slider"><span class="toggle-switch"></span></span>\n            <span class="option-message">'+this.escapeExpression((s=null!=(s=t.syncMessage||(null!=e?e.syncMessage:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"syncMessage",hash:{},data:n}):s))+'</span>\n        </li>\n    </ul>\n\n\n    <h5>Tip</h5>\n    <p class="no-top-margin">Many items in Momentum can be edited by double clicking on them, including: <strong>your name</strong>, <strong>location</strong>, <strong>clock</strong>, <strong>temperature</strong>, and <strong>todos</strong>.\n    </p>\n</div>\n'},useData:!0}),m.templates.settings.help=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-help">\n\t<h3>Help</h3>\n\t<p class="description"></p>\n\n\t<h5>Tips</h5>\n\t<p>To change your name, toggle the temperature between C and F, change your location, or toggle the clock between 12 and 24 hour, <strong>double click</strong> on the setting you wish to change.</p>\n\n\t<h5>Hotkeys</h5>\n\t<p class="hotkeys">\n\t\t<span class="col">\n\t\t\t<strong class="hotkey">T</strong>Todo<br>\n\t\t\t<strong class="hotkey">F</strong>Focus<br>\n\t\t\t<strong class="hotkey">,</strong>Settings<br>\n\t\t\t<strong class="hotkey">ESC</strong>Cancel, close\n\t\t</span><span class="col">\n\t\t\t<strong class="hotkey">L</strong>Links<br>\n\t\t\t<strong class="hotkey">S</strong>Search<br>\n\t\t\t<strong class="hotkey">C</strong>Chrome Tab<br>\n\t\t\t<strong class="hotkey">SPACE</strong>Hold to admire photo<br>\n\t\t</span>\n\t</p>\n\t<p>\n\t\tPress <strong class="hotkey" style="margin: 0 2px;">TAB</strong> to focus Momentum when opening a new tab to be able to use hotkeys. You may need to press tab more than once.\n\t</p>\n\n\t<h5>Need more help?</h5>\n\t<p>\n\t\tCheck out our Help Center<br>\n\t\t<a href="http://momentumdash.com/help" class="button button-inline" target="_blank">Go to Help Center</a>\n\t</p>\n</div>\n'},useData:!0}),m.templates.settings.loading=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-loading">\n    <p class="settings-loading-loading-message"><i class="loading-icon"></i>Loading...</span></p>\n    <p class="settings-loading-error-message">We\'re having trouble loading these settings.</p>\n    <span class="button button-retry">Retry</span>\n</div>'},useData:!0}),m.templates.settings.main=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pane pane-container widget-pop settings nipple-bottom-left">\n    <ul id="nav-menu" class="settings-nav border-right"></ul>\n    <div class="subpanel-container upsell-parent"></div>\n</div>\n'},useData:!0}),m.templates.settings.navmenu=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'    <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:n}):o))+'" class="main-nav-item">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+"</li>\n"},3:function(e,t,i,n){var o;return null!=(o=t["if"].call(e,n&&n.first,{name:"if",hash:{},fn:this.program(4,n,0),inverse:this.program(6,n,0),data:n}))?o:""},4:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:n}):o))+'" class="main-nav-item secondary secondary-first">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+"</li>\n"},6:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:n}):o))+'" class="main-nav-item secondary">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+"</li>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return(null!=(o=t.each.call(e,null!=e?e.navItems:e,{name:"each",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+(null!=(o=t.each.call(e,null!=e?e.secondaryNavItems:e,{name:"each",hash:{},fn:this.program(3,n,0),inverse:this.noop,data:n}))?o:"")},useData:!0}),m.templates.settings.upgrade=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<div class="hero upgrade-hero">\n\t<style type="text/css">\n\t\t.upgrade-hero { padding-bottom: 30px; border-bottom: 1px solid #444; }\n\t\t.upgrade-hero h3 { margin-bottom: 6px; }\n\t\t.upgrade-hero .description { margin-bottom: 15px; opacity: 0.8; }\n\t\t.settings-upgrade .button { padding: 12px 30px; font-size: 95%; font-weight: 500; text-transform: uppercase; }\n\t</style>\n\n\t<h3>Momentum Plus is Here!</h3>\n\t<p class="description" style="margin-bottom: 15px; opacity: 0.8;" ">Level up your focus with customization, integrations, and new widgets.</p>\n\n\t<div class="login-needed">\n\t\t<span class="login-needed-title">Please log in</span>\n\t\t<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n\t</div>\n\n\t<span class="button button-upgrade">Get Momentum Plus</span>\n\t<span class="special">Launch Special!<strong style="margin-left: 5px;"><i class="fa fa-sun-o"></i> 33% Off</strong></span>\n\t<span class="price-line"><span class="price">$1.99/month</span> or <span class="price">$19.99/year</span> (equal to 2 months free!)<br></span>\n</div>\n\n\n\n<div class="feature-list">\n\t<style type="text/css">\n\t\t.feature-list { margin-top: 30px; }\n\t\t.feature-list h4 { margin-bottom: 15px; font-size: 95%; opacity: 0.8; text-transform: uppercase; }\n\t\t.feature-list-icon { width: 40px; margin-top: -2px; float: left; font-size: 120%; text-align: center; }\n\t\t.feature-list-info { margin-left: 40px; margin-bottom: 20px; }\n\t\t.feature-list-info h5 { margin: 0 0 4px; font-size: 92%; opacity: 1; }\n\t\t.feature-list-info p { margin-top: 5px; font-size: 13px; line-height: 135%; opacity: 0.7; }\n\t</style>\n\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Todo Integrations</h5>\n\t\t<p>Momentum Plus connects with your favorite task management services! See, update, and create new tasks from Trello, Todoist, Wunderlist, and Google Tasks.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Custom Background Photos</h5>\n\t\t<p>Light up your day every time you open a new tab. Add your own photos or choose from your favorites or past photos in Momentum.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Personalize Font and Color</h5>\n\t\t<p>Make Momentum your own by choosing a font and color that suits your personality. Incorporate your own style to motivate, inspire, and bring focus to your day.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Custom Quotes</h5>\n\t\t<p>Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Skip Photo/Quote</h5>\n\t\t<p>Not feeling the photo or quote of the day? No problem; a new one is just a refresh away. Cycle between five photos and five quotes per day.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Autofocus Mode</h5>\n\t\t<p>Set your priorities at the start of the day and Momentum will show you the one thing you need to focus on at a time. Check it off, and the next up todo becomes your focus.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Inbox, Today, and Done Lists</h5>\n\t\t<p>Keep your todo list clutter free with the Inbox list. Know exactly what you need to do for the day with the Today list. Follow up on what you’ve completed with the Done list.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Priority Support</h5>\n\t\t<p>Plus subscribers can be assured that their messages, suggestions and requests will be answered promptly by a real human. Your satisfaction is of the utmost importance to us.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Early Access</h5>\n\t\t<p>Get exclusive early access to exciting new Momentum features. Have a say in the direction of the product. Next early release feature: Notes.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Support Momentum</h5>\n\t\t<p>Your subscription helps Momentum  Plus subscriptions help sustain Momentum and enable the addition of more features. Thank you for your support — we are incredibly grateful!</p>\n\t</div>\n</div>\n\n\n\n<div class="cta">\n\t<style type="text/css">\n\t\t.settings-upgrade .cta { margin: 50px 0 70px; padding: 25px 10px 10px; border-top: 1px solid #444; border-bottom: 1px solid #444; text-align: center; }\n\t\t.settings-upgrade .cta .pitch { margin: 0 0 19px; font-size: 125%; line-height: 135%; }\n\t\t.settings-upgrade .cta .button { margin-bottom: 0; }\n\t\t.settings-upgrade .link { margin: 3px 0 0; padding: 8px; display: inline-block; background: none !important; cursor: pointer; opacity: 0.5; text-decoration: none; -webkit-transition: all 0.1s ease; }\n\t\t.settings-upgrade .link:hover { opacity: 0.7; }\n\t</style>\n\n\t<p class="pitch">Upgrade to Momentum Plus today and turn<br>your potential into progress.</p>\n\n\t<div class="login-needed">\n\t\t<span class="login-needed-title">Please log in</span>\n\t\t<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n\t</div>\n\n\t<span class="button button-upgrade">Get Momentum Plus</span><br>\n\t<a href="https://momentumdash.com/plus?'+this.escapeExpression((o=null!=(o=t.campaignDetails||(null!=e?e.campaignDetails:e))?o:t.helperMissing,
"function"==typeof o?o.call(e,{name:"campaignDetails",hash:{},data:n}):o))+'" class="link">Learn More</a>\n</div>\n\n\n\n<div class="faq">\n\t<style type="text/css">\n\t\t.settings-upgrade .faq { margin-top: 0; padding: 0 75px; font-size: 90%; opacity: 1; }\n\t\t.settings-upgrade .faq:first-child { margin-top: 0; }\n\t\t.settings-upgrade .faq:last-child { margin-bottom: 10px !important; }\n\n\t\t.settings-upgrade .faq-question { opacity: 0.9; }\n\t\t.settings-upgrade .faq-answer { opacity: 0.7; }\n\t</style>\n\t<p>\n\t\t<span class="faq-question">What are the available integrations?</span>\n\t\t<span class="faq-answer">Currently we integrate with Wunderlist, Google Tasks, Todoist, and Fitbit. Coming soon: Trello and Asana.<!--Github, Google Analytics, Uservoice, Harvest.--></span>\n\t</p>\n\n\t<p>\n\t\t<span class="faq-question">I thought Momentum was free?</span>\n\t\t<span class="faq-answer">Momentum Free will always be free. We created Momentum Plus to bring more control and functionality to those who desire it, while still keeping the experience simple and focused.</span>\n\t</p>\n</div>'},useData:!0}),m.templates.settings.upsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="right">\n\t<span class="button upsell-action">'+l((o=null!=(o=t.buttonText||(null!=e?e.buttonText:e))?o:s,typeof o===a?o.call(e,{name:"buttonText",hash:{},data:n}):o))+'</span>\n\t<span class="hide upsell-hide">✕</span>\n</div>\n<div class="available">Available on Plus</div>\n<div class="title">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'</div>\n<div class="description">'+l((o=null!=(o=t.description||(null!=e?e.description:e))?o:s,typeof o===a?o.call(e,{name:"description",hash:{},data:n}):o))+"</div>\n"},useData:!0}),m.templates.settings.whatsnew=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-detail whatsnew">\n\t<div class="settings-detail-header">\n\t\t<h3>What\'s New</h3>\n\t\t<p class="description">Updates from the Momentum Team</p>\n\t</div>\n\n\t<div class="whatsnew-body">\n\t\t<h4>October 17</h4>\n\t\t<p>\n\t\t\t- "Last seen" now shows on the Favorites and History detail pages.\n\t\t</p>\n\n\n\t\t<h4>October 7</h4>\n\t\t<p>\n\t\t\t<strong>Favorites and History are here!</strong><br>\n\t\t<p>One of the most popular suggestions that we’ve received has been the ability to view past Momentum backgrounds. With this week’s update, this is now possible.</p>\n\n\t\t<p>On the Favorites page, you can view the backgrounds that you’ve favorited (aka “hearted”). On the History page, you can view all of the past backgrounds that have displayed on your Momentum dashboard.</p>\n\n\t\t<p>Explore your Favorites and History pages by clicking <strong>Settings → Backgrounds</strong>.</p>\n\n\t\t<p>Plus users can also make any favorite or past photo into their current background just as they would a custom background.</p>\n\n\t\t<p>To learn more check out the help articles: <a href="http://help.momentumdash.com/knowledgebase/articles/1083655-backgrounds-favorites">Favorites Help</a> • <a href="http://help.momentumdash.com/knowledgebase/articles/1083682-backgrounds-history">History Help</a>.</p>\n\n\n\n\t\t<h4>October 3</h4>\n\t\t<p>\n\t\t\t<strong>Account page, now with fewer infinite loops</strong><br>\n\t\t\tThe account page has gotten an overhaul and added functionality. You can now:<br>\n\t\t\t- Change your personal details<br>\n\t\t\t- Add multiple emails to your account<br>\n\t\t\t- Manage your Plus account much more easily<br>\n\t\t\t<br>\n\t\t\tFind Account in Settings → General by your name, or go to <a href="http://account.momentumdash.com">http://account.momentumdash.com</a>.</p>\n\n\n\n\t\t<h4>August 26</h4>\n\t\t<p>\n\t\t\t- Added Custom Backgrounds (Plus)<br>\n\t\t\t- Disconnect integration now possible!<br>\n\t\t\t- Drag and drop an image onto Momentum to add to Custom Backgrounds<br>\n\t\t\t- Ongoing work with the drag and drop to reorder todo<br>\n\t\t\t- Settings panels now loaded on the fly<br>\n\t\t\t- Many improvements to the Settings widget\n\t\t</p>\n\n\n\n\t\t<h4>July 13</h4>\n\t\t<p>\n\t\t\t<strong>New on Plus: Custom Backgrounds</strong><br>\n\t\t\tCurate your own quote collection. Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.<br>\n\t\t</p>\n\n\n\n\t\t<h4>July 6</h4>\n\t\t<p>\n\t\t\t<strong>New on Plus: Trello!</strong><br>\n\t\t\tWe\'re super excited to announce the new Trello integration! Add any Trello boards you\'d like to see in the Momentum Todo. See all the cards in each list and check off a card to move it to the next list.  To switch between lists, use the list dropdown (or left/right arrow keys). To switch quickly between boards, hold shift and use the left and right arrow keys.\n\t\t</p>\n\n\n\n\t\t<h4>June 3</h4>\n\t\t<p>\n\t\t\t<strong>0.90.1 Update</strong><br>\n\t\t\tWe continue to work toward expanding the Plus offering. With this latest update we put one more plumbing style feature in place for the Trello integration. We will launch a beta of it soon which people can join.</p>\n\n\t\t<p>\n\t\t\t- Plus signs will now work in email addresses.<br>\n\t\t\t- Getting one more plumbing feature in place for the Trello integration.<br>\n\t\t\t- Cleanups and bug fixes.\n\t\t</p>\n\n\n\t\t<h4>May 23</h4>\n\t\t<h5 style="margin: 0; font-size: 130%; opacity: 1;">Make Momentum your own</h5>\n\t\t<p style="margin: 2px 0; line-height: 130%; opacity: 0.6;">Favorites, Custom Themes, Skip Photo/Quote, Trello Integration, and more! (v0.90 Update)</p>\n\n\t\t<h5 style="margin-top: 1em">Summary</h5>\n\n\t\t<p>This exciting new update is loaded with features that enable endless personalization possibilities. <strong>Customize</strong> your dashboard with new <strong>fonts</strong> and widget <strong>colors</strong>. Save your favorite background photos and inspiring quotes with the new Favorite feature, and pass by the ones you dislike with the new <strong>Skip</strong> feature. Also, introducing our newest integration — <strong>Trello </strong> — coming next. Thank you everyone for the support!</p>\n\n\t\tNew features:<br>\n\t\t- Favorite photos/quotes<br>\n\t\t- Custom font and color (Plus)<br>\n\t\t- Skip photo/quote (Plus)<br>\n\t\t- Trello integration (Plus)<br>\n\t\t- Many bug fixes and improvements<br>\n\t\t- New look to notifications<br>\n\t\t- Next focus: Two new widgets!<br>\n\n\n\t\t<h5>A message to the Momentum Community</h5>\n\n\t\t<p>We are super excited to announce our latest update to Momentum (v. 0.90). The Momentum team has been really busy for the past couple months bringing this update to light, and late last night (May 22) we finally got it ready to launch and began the release process.</p>\n\n\t\t<p>One of our main focuses right now is building out the value of our Plus offering to deliver more value to our existing subscribers and build out the appeal to potential subscribers. Momentum Plus represents our path to sustainability so we can continue to build out the product without sacrificing the vision to profit incentives of investors. We are approaching an official launch for Plus with a few more major things to come. We\'re very grateful to those of you who have signed up for Plus. It supports the Momentum team and continued development of the product!</p>\n\n\n\t\t<h5>Favorite Photos and Quotes</h5>\n\n\t\t<p>Like the background or quote of the day? Highlight the location or quote and click the heart to favorite it. In the future we will have a way to browse your favorites to see a nice collection of your tastes.</p>\n\n\n\t\t<h5>Personalize the look and feel of Momentum! (Plus)</h5>\n\n\t\t<p>Make Momentum your own by choosing a font and color theme for Momentum’s widgets. Our favorite font is Modern but we\'ve added quite a few options to suit a variety of different tastes: Modern, Startup, Retro, Warehouse, and Quirky. Head over to Customize in General settings and try them out!</p>\n\n\t\t<p>Additionally, you can significantly change the look of your dashboard by switching your widget theme color! This new feature literally provides you with the ability to let your true colors shine through your dashboard. Our lead developer Jason is in to the new Light theme, but our community manager Ben is digging the dark green. The choice is yours! :)</p>\n\n\t\t<p>These features started as a way of freshening up Momentum internally with a new font (Modern on Mac) and a light mode. We quickly realized it was a fun way to personalize and freshen things up for everyone, so we added more fonts and the ability to set any color. We have more in mind for personalization, including a photo match mode.</p>\n\n\n\t\t<h5>Skip Photo/Quote (Plus)</h5>\n\n\t\t<p>Ever have those days where you\'re not quite feeling the photo or quote? Us too. With this new feature you can change the photo or quote by simply hovering your mouse over the background location or quote and then click the "Next" arrow to get a new one!\n\t\t</p>\n\n\t\t<p>We still love the idea of putting a limit on the number of images to prevent binge behavior and support focus, so we\'ve set a limit of 5 images per day. When skipping the last image it will cycle back to the first image of the day, so you can set it to the one you like the most and switch it up throughout the day.</p>\n\n\n\t\t<h5>Trello integration (Plus)</h5>\n\n\t\t<p>We\'re heavy Trello users here at Momentum, so this one is pretty exciting for us. Hook up your Trello boards and sync your cards right into Momentum. Choose the boards you want to appear in Momentum and quickly switch between them with shift+left/right arrow. Switch between lists with the left/right arrow keys. There\'s also an option to show only cards assigned to you, to quickly cut through the clutter.</p>\n\n\t\t<p>Trello will be rolling out later this week or early next week as we complete some of the back end functionality.</p>\n\n\t\t<h5>Many, many Todo improvements</h5>\n\n\t\t<p>Ah yes, the classic "bug fixes and performance improvements". We\'ve done a pile of fixes, including a lot of stuff to the Todo. We also fixed the What\'s New which was stuck on an update from last month.</p>\n\n\n\t\t<h5>New look to notifications</h5>\n\n\t\t<p>When Momentum first launched we needed a way to tell people we were rolling out updates, and as we added things like user accounts we used that same widget to notify about new account, logging out, etc. As often happens in software, it stuck around because we were too busy with other projects. With this recent update, your notifications will now be displayed at the bottom left corner of your dashboard and will mirror your customized theming. It\'s a lot prettier than the old one. :)</p>\n\n\n\t\t<h5>A new product</h5>\n\n\t\t<p>With all these updates, Momentum really feels like a new product to us. And we\'re really excited for what\'s on the horizon. We couldn\'t do it without you, so thank you for your support. In our next update we will be announcing two new widgets! Stay tuned for more on those.</p>\n\n\t\t<p>Also, if any of you are interested in a new visualization mode for the clock, message in and we\'ll send you instructions on how to enable it. It\'s in an early testing mode right now and we\'d love to get your feedback.</p>\n\n\t\t<p>We\'d love to hear your feedback on the new update and any suggestions for the future, so please <a href="https://momentumdash.com/contact">get in touch</a>!</p>\n\n\n\n\t\t<h4>May 18</h4>\n\n\t\t<p>All pending account sync requests have been activated. Also, account sync will now automatically activate when enabled. Yay to instant and automatic.</p>\n\n\t\t<p>We are putting the finishing touches on our next release which adds a lot of control and customization to the Momentum Plus experience. If you\'ve ever found yourself not too enthused about the image of the day, you can now skip it. Same for the quote. We are also adding more fonts and color themes to freshen things up and add more personalization. Oh, and this release also includes the much anticipated Trello integration!</p>\n\n\t\t<p>Both Momentum Plus and Free will also be getting Favorite background/quote. This will open the door to a Favorites page to see your favourite backgrounds and quotes anytime!</p>\n\n\t\t<h5>Join the Momentum Kiva team</h5>\n\t\t<p>Did you know we have a Momentum Kiva team? <a href="https://www.kiva.org/invitedto/momentum_dash/by/levibe">Join today</a> and empower people in challenging circumstances to improve their lives!</p>\n\n\n\t\t<h4>April 29</h4>\n\n\t\t<h5>Todoist</h5>\n\t\t<p>Sorting of todos now works a lot better, especially those with nested todos. Nested todos will show properly indented in the next release.</p>\n\n\t\t<p>Delete todo is now working for Google Tasks and Wunderlist. Todoist delete still needs some work.</p>\n\n\n\t\t<h4>April 26</h4>\n\n\t\t<p>After much confusion, we discovered that many of the messages from our website contact form weren\'t coming through. Fixed! However, if you already sent a message and haven\'t heard a response, then we likely lost your message. :( Please reach out again and we\'ll be very happy to hear from you.</p>\n\n\n\t\t<h4>April 25</h4>\n\t\t<h5>Wunderlist</h5>\n\t\t<p>Default ordering of the todos will now be the same in Momentum as in Wunderlist.</p>\n\n\t\t<h5>Todoist</h5>\n\t\t<p>You can now choose separate Todoist lists instead of todos all being lumped into Today.</p>\n\n\n\t\t<h4>April 19</h4>\n\t\t<p>Google search now goes directly to the results page on Google.com. We were using a custom feed through Google and they shut it down.</p>\n\n\n\t\t<h4>April 15</h4>\n\t\t<h5>Todoist & Wunderlist</h5>\n\t\t<p>Wunderlist, Todoist, and Google Tasks now work with our autofocus/set to focus features. Sorting on Todoist needs a bit more work, due to nested tasks. More to come on that in an upcoming release.</p>\n\n\t\t<h4>April 14</h4>\n\t\t<p>Plus users! We have a major release for the Todo widget to announcing including an exciting new feature that has been in the works for quite some time: <strong>automatically set your todos as your main focus</strong>.</p>\n\n\t\t<h5>Autofocus Mode</h5>\n\t\t<p>You can now have Momentum automatically set your top ordered todo as your main focus. To enable Autofocus mode, go into Settings or click the loop icon near the settings icon in the Todo list.</p>\n\n\t\t<p>In the morning, set up your todo list in order of priority, then throughout the day you can simply check off your Focus and your next task will fill in as your main focus. Magic! Combine autofocus with integrations and you can have end to end integration from your other todo source right into your main focus.</p>\n\n\t\t<p>You can also manually set a todo to your focus by clicking the <span class="hotkey">•••</span> dropdown and going to "Set to focus".</p>\n\n\t\t<h5>Hotkeys to switch between lists and todo sources (integrations)</h5>\n\t\t<p>\n\t\t\t- Use <span class="hotkey">←</span> and <span class="hotkey">→</span> keys to move between lists (e.g. Inbox to Today)<br>\n\t\t\t- Use <span class="hotkey">shift</span> + <span class="hotkey">←</span> and <span class="hotkey">→</span> keys to switch between sources/integrations (e.g. Momentum Todo to Todoist)</p>\n\n\t\t<h5>Todo completely rebuilt</h5>\n\t\t<p>We completely revamped the Todo widget to perform much better and fix a bunch of bugs. Sorting todos (by dragging and dropping) and moving todos between lists should now work properly. The Done list will also now show headings for the days todos were completed.</p>\n\n\t\t<h5>Did you know?</h5>\n\t\t<p>You can quickly move a todo between your Inbox and Today lists by hovering over the todo with your mouse and pressing <span class="hotkey">space</span>? We encourage keeping your Today list short and focused, and this is a way to help you do that!</p>\n\n\t\t<h5>Momentum Free & Plus Updates</h5>\n\t\t<p>\n\t\t\t- Responsive styling added so Momentum will shrink down better on smaller screens<br>\n\t\t\t- Setting a manual weather location (double click on location) will stay set again<br>\n\t\t\t- Bug where weather will sometimes show a super high temperature has been fixed<br>\n\t\t\t- Many bug fixes and improvements\n\t\t</p>\n\n\t\t<h4>Feb 17-18</h4>\n\t\t<p>Wunderlist and Google Tasks Todos were broken when it came to editing and checking off. Fixed!</p>\n\n\t\t<h4>Feb 12</h4>\n\t\t<p>So, we had a pretty bad bug that we had trouble tracking down where the focus disappeared for some people after they saved it. Well, we finally found it and fixed it! It turns out it was happening for heavy focus users, who are the people for whom we want the focus to work the best! Sorry :(</p>\n\n\t\t<h4>Feb 10</h4>\n\t\t<p>Hello from the Momentum team! We have added this section to share real time updates on what we have been up to at Momentum, like a changelog. Keep checking back!</p>\n\n\t\t<h4>Feb 8</h4>\n\t\t<p>\n\t\t\t- Todoist integration will now show just Today tasks instead of a firehose of all tasks. Project lists coming soon!<br>\n\t\t\t- "Awaiting authorization" no longer shows when an integration is already authorized.<br>\n\t\t\t- Fixed a bug on the Contact form on the website where emails wouldn\'t send if the person had a plugin that added an extra field into the form.\n\t\t</p>\n\t</div>\n</div>'},useData:!0}),m.templates=m.templates||{},m.templates.todos=m.templates.todos||{},m.templates.todos.addtodolist=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div id="add-label" class="todo-list-add-button"><i class="icon icon-plus"></i> Add List</div>\n<input id="list-new" class="todo-input todo-list-add-input" type="text" placeholder="New List" />\n<span class="loading new-list-loading"><i class="loading-icon"></i> <span >Loading...</span></span>\n'},useData:!0}),m.templates.todos.dropdownmenu=Handlebars.template({1:function(e,t,i,n){var o;return'<i class="control control-dropdown icon '+this.escapeExpression((o=null!=(o=t.iClassName||(null!=e?e.iClassName:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"iClassName",hash:{},data:n}):o))+'"></i>\n'},3:function(e,t,i,n){return'<span class="control control-dropdown"><svg class="icon icon-gear" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z"/></svg></span>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return"\n"+(null!=(o=t["if"].call(e,null!=e?e.iClassName:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.program(3,n,0),data:n}))?o:"")+'<div class="dropdown '+this.escapeExpression((s=null!=(s=t.dropdownClassName||(null!=e?e.dropdownClassName:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"dropdownClassName",hash:{},data:n}):s))+'">\n<ul class="dropdown-list"></ul>\n<ul class="dropdown-detail"></ul>\n</div>\n'},useData:!0}),m.templates.todos["legacy-todo-complete"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="metric-stat">'+l((o=null!=(o=t.done||(null!=e?e.done:e))?o:s,typeof o===a?o.call(e,{name:"done",hash:{},data:n}):o))+'</span>\n<span class="metric-label">'+l((o=null!=(o=t.item||(null!=e?e.item:e))?o:s,typeof o===a?o.call(e,{name:"item",hash:{},data:n}):o))+" complete</span>"},useData:!0}),m.templates.todos["legacy-todo-item"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<i class="control destroy">✕</i>\n<i class="loading-icon"></i>\n<i class="control error-icon">!</i>\n<label><input class="todo-item-checkbox" type="checkbox"></label><span class="todo-item-title" >'+this.escapeExpression((o=null!=(o=t.title||(null!=e?e.title:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"title",hash:{},data:n}):o))+"</span>\n"},useData:!0}),m.templates.todos["legacy-todo"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pane-container todo-pane-container nipple-bottom-right">\n    <div class="pane todo-pane todo-pane-legacy">\n        <div class="todo-header">\n            <ul>\n                <li><span class="todo-count"><i class="loading-icon"></i>Loading...</span></li>\n            </ul>\n            <div class="error-message">Connection required to add Todo</div>\n        </div>\n        <div class="empty empty-todo">\n            <div class="content">\n                <div class="graphic">☺</div>\n                <div class="title">Nothing to do</div>\n                <div class="description">One step at a time...</div>\n            </div>\n            <div class="action"><span class="show-completed">Completed today</span></div>\n        </div>\n        <ol class="todo-list"></ol>\n        <input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n    </div>\n</div>\n<span id="todo-remaining"></span>\n<span class="toggle todo-toggle">Todo</span>'},useData:!0}),m.templates.todos["todo-list-empty-state"]=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="empty-link" data-target-list-id="'+l((o=null!=(o=t.targetListId||(null!=e?e.targetListId:e))?o:s,typeof o===a?o.call(e,{name:"targetListId",hash:{},data:n}):o))+'" data-use-command="'+l((o=null!=(o=t.use_command||(null!=e?e.use_command:e))?o:s,typeof o===a?o.call(e,{name:"use_command",hash:{},data:n}):o))+'">'+l((o=null!=(o=t.submessage||(null!=e?e.submessage:e))?o:s,typeof o===a?o.call(e,{name:"submessage",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return'<li class="empty">\n    <div><span class="empty-title">'+this.escapeExpression((s=null!=(s=t.message||(null!=e?e.message:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"message",hash:{},data:n}):s))+"</span>\n    "+(null!=(o=t["if"].call(e,null!=e?e.submessage:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+"\n    </div>\n</li>"},useData:!0}),m.templates.todos.todoitem=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<span class="todo-item-wrapper">\n\t<div class="dropdown-container">\n\t</div>\n\n\t<i class="loading-icon"></i>\n\t<i class="control error-icon" title="Error saving click to retry">!</i>\n\n\t<label><input class="todo-item-checkbox" type="checkbox"></label>\n\t<span class="todo-item-title" >'+this.escapeExpression((o=null!=(o=t.title||(null!=e?e.title:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"title",hash:{},data:n}):o))+"</span>\n</span>\n"},useData:!0}),m.templates.todos.todolistactive=Handlebars.template({1:function(e,t,i,n){var o;return'<img class="todo-list-icon" src="'+this.escapeExpression((o=null!=(o=t.providerLogo||(null!=e?e.providerLogo:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"providerLogo",hash:{},data:n}):o))+'">'},3:function(e,t,i,n){var o;return'<div class="message todo-message"><span class="message-title">'+this.escapeExpression((o=null!=(o=t.statusMessage||(null!=e?e.statusMessage:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"statusMessage",hash:{},data:n}):o))+"</span>"},5:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="message-action" id="status-action" data-action="'+l((o=null!=(o=t.action||(null!=e?e.action:e))?o:s,typeof o===a?o.call(e,{name:"action",hash:{},data:n}):o))+'">'+l((o=null!=(o=t.actionMessage||(null!=e?e.actionMessage:e))?o:s,typeof o===a?o.call(e,{name:"actionMessage",hash:{},data:n}):o))+"</span></div>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li>\n\t<div class="todo-list-color" style="background-color: '+r((s=null!=(s=t.color||(null!=e?e.color:e))?s:a,typeof s===l?s.call(e,{name:"color",hash:{},data:n}):s))+'">&nbsp;</div>\n\t'+(null!=(o=t["if"].call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'<!--\n\t--><span class="todo-list-name">'+r((s=null!=(s=t.listTitle||(null!=e?e.listTitle:e))?s:a,typeof s===l?s.call(e,{name:"listTitle",hash:{},data:n}):s))+'</span><i class="icon icon-angle-down"></i><!--\n\t--><span class="todo-count active-todo-count">'+r((s=null!=(s=t.remaining||(null!=e?e.remaining:e))?s:a,typeof s===l?s.call(e,{name:"remaining",hash:{},data:n}):s))+'</span><!--\n\t--><div class="todo-controls">\n\t\t<span class="control control-autofocus" title="Automatically set top todo as focus">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="124.512" height="124.512" viewBox="0 0 124.512 124.512" class="icon icon-autofocus"><path d="M113.956 57.006l-97.4-56.2c-4-2.3-9 .6-9 5.2v112.5c0 4.6 5 7.5 9 5.2l97.4-56.2c4-2.401 4-8.2 0-10.5z"/></svg>\n\t\t</span><!--\n\t\t--><div class="dropdown-container" id="todo-top-menu"></div><!--\n\t--></div>\n</li>\n'+(null!=(o=t["if"].call(e,null!=e?e.statusMessage:e,{name:"if",hash:{},fn:this.program(3,n,0),inverse:this.noop,data:n}))?o:"")+"\n"+(null!=(o=t["if"].call(e,null!=e?e.actionMessage:e,{name:"if",hash:{},fn:this.program(5,n,0),inverse:this.noop,data:n}))?o:"")+"\n"},useData:!0}),m.templates.todos.todolistchoice=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<li class="todo-list-choice '+l((o=null!=(o=t["class"]||(null!=e?e["class"]:e))?o:s,typeof o===a?o.call(e,{name:"class",hash:{},data:n}):o))+'" data-list-id="'+l((o=null!=(o=t.listId||(null!=e?e.listId:e))?o:s,typeof o===a?o.call(e,{name:"listId",hash:{},data:n}):o))+'">\n    <div class="todo-list-color" style="background-color: '+l((o=null!=(o=t.color||(null!=e?e.color:e))?o:s,typeof o===a?o.call(e,{name:"color",hash:{},data:n}):o))+'">&nbsp;</div>\n    <span class="todo-list-name">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'</span>\n    <span class="todo-count">'+l((o=null!=(o=t.count||(null!=e?e.count:e))?o:s,typeof o===a?o.call(e,{name:"count",hash:{},data:n}):o))+"</span>\n</li>\n"},useData:!0}),m.templates.todos.todopane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pane-container todo-pane-container nipple-bottom-right">\n\t<div class="pane todo-pane">\n\t\t<div class="todo-header">\n\t\t\t<ul class="todo-list-chooser todo-list-active">\n\t\t\t\t<li><span class="todo-list-name"></span><span class="todo-count active-todo-count"></span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t\t<ul class="todo-list-chooser todo-list-chooser-dropdown" style="display: none"></ul>\n\t\t</div>\n        \t\t<div class="todo-list-wrapper">\n\t\t\t<ol class="todo-list animating"></ol>\n\t\t</div>\n\t\t<input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo"/>\n\n\t</div>\n</div>\n<span class="toggle todo-toggle">Todo</span></div>\n'},useData:!0}),m.templates.todos.upsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="hide upsell-hide">✕</span>\n<div class="available">Available on Plus</div>\n<div class="title">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'</div>\n<div class="description">'+l((o=null!=(o=t.description||(null!=e?e.description:e))?o:s,typeof o===a?o.call(e,{name:"description",hash:{},data:n}):o))+'</div>\n<a href="" class="button upsell-action">'+l((o=null!=(o=t.buttonText||(null!=e?e.buttonText:e))?o:s,typeof o===a?o.call(e,{name:"buttonText",hash:{},data:n}):o))+"</a>\n"},useData:!0}),m.templates=m.templates||{},m.templates.weather=m.templates.weather||{},m.templates.weather.weather=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <span class="icon icon-weather" data-icon="'+l((o=null!=(o=t.code||(null!=e?e.code:e))?o:s,typeof o===a?o.call(e,{name:"code",hash:{},data:n}):o))+'" title="'+l((o=null!=(o=t.condition||(null!=e?e.condition:e))?o:s,typeof o===a?o.call(e,{name:"condition",hash:{},data:n}):o))+'"></span><span class="metric-stat-number">'+l((o=null!=(o=t.temperature||(null!=e?e.temperature:e))?o:s,typeof o===a?o.call(e,{name:"temperature",hash:{},data:n}):o))+'</span><span class="weather-degree">&deg;</span><span class="unit '+l((o=null!=(o=t.unitClass||(null!=e?e.unitClass:e))?o:s,typeof o===a?o.call(e,{name:"unitClass",hash:{},data:n}):o))+'">'+l((o=null!=(o=t.unit||(null!=e?e.unit:e))?o:s,typeof o===a?o.call(e,{name:"unit",hash:{},data:n}):o))+"</span>\n"},3:function(e,t,i,n){return"        N/A\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div class="metric-stat">\n'+(null!=(o=t["if"].call(e,null!=e?e.temperature:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.program(3,n,0),data:n}))?o:"")+'</div>\n<span class="location metric-label data">'+r((s=null!=(s=t.location||(null!=e?e.location:e))?s:a,typeof s===l?s.call(e,{name:"location",hash:{},data:n}):s))+'</span>\n<span class="metric-message">'+r((s=null!=(s=t.message||(null!=e?e.message:e))?s:a,typeof s===l?s.call(e,{name:"message",hash:{},data:n}):s))+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.widgetmanager=m.templates.widgetmanager||{},m.templates.widgetmanager.metric=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n\t<div class="primary">\n\t\t<div class="metric-stat">\n\t\t\t<span class="metric-stat-number">'+l((o=null!=(o=t.metricValue||(null!=e?e.metricValue:e))?o:s,typeof o===a?o.call(e,{name:"metricValue",hash:{},data:n}):o))+'</span><span class="metric-stat-unit">'+l((o=null!=(o=t.metricUnit||(null!=e?e.metricUnit:e))?o:s,typeof o===a?o.call(e,{name:"metricUnit",hash:{},data:n}):o))+'</span>\n\t\t</div>\n\t\t<span class="metric-label">'+l((o=null!=(o=t.metricLabel||(null!=e?e.metricLabel:e))?o:s,typeof o===a?o.call(e,{name:"metricLabel",hash:{},data:n}):o))+'</span>\n\t</div>\n\t<span class="metric-message"></span>\n</div>'},useData:!0}),m.templates.widgetmanager.pane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="pane-container pane-placeholder">\n\t<div class="pane pane-placeholder-loading"><i class="loading-icon"></i>Loading...</div>\n</div>\n<span class="toggle '+l((o=null!=(o=t.label||(null!=e?e.label:e))?o:s,typeof o===a?o.call(e,{name:"label",hash:{},data:n}):o))+'-toggle">'+l((o=null!=(o=t.label||(null!=e?e.label:e))?o:s,typeof o===a?o.call(e,{name:"label",hash:{},
data:n}):o))+"</span>"},useData:!0});var c=console;m.globals.version="0.95.3",m.globals.platform="chrome",m.globals.googleAnalyticsCode="UA-44319322-10",m.globals.urlRoot="https://api.momentumdash.com/",m.globals.urlRootApi="https://api.momentumdash.com/",m.globals.urlRootLogin="https://login.momentumdash.com/",m.globals.urlRootStats="https://stats.momentumdash.com/",m.globals.urlRootIntegration="https://integration.momentumdash.com/",m.sendEvent=function(e,t,i){e&&t&&i?ga("send","event",e,t,i):e&&t?ga("send","event",e,t):e&&ga("send","event",e)},m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1,lazy:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManager=Backbone.Model.extend({initialize:function(){var e=this;this.addinCollection=new m.collect.AddinCollection,setTimeout(function(){e.loadFromAddinObject(!0)},50)},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var t=this;_.each(m.addins,function(e,i){var n=t.addinCollection.findWhere({id:i});n||t.loadEvaluatedAddin(i,e)}),e&&this.processPending()},registerAddinLocalSource:function(e,t){this.addinCollection.findWhere({id:e})||this.addinCollection.add({id:e,path:t})},ensureAddinLoaded:function(id,success,loading,error){var addin=this.addinCollection.get(id);if(addin&&addin.get("loaded"))return void(success&&success(addin));if(loading)try{loading()}catch(e){}if(addin||(addin=this.addinCollection.add({id:id,evaluated:!1,processed:!0,lazy:!0})),!addin.get("loading")){addin.set("loading",!0);var dataType="text",url=m.globals.urlRootApi+"scripts/"+id;$.ajax({url:url,cache:!0,beforeSend:m.utils.setMomentumAuthHeader,dataType:dataType,success:function(text){try{"text"==dataType&&eval(text),addin.set({evaluated:!0,rawCode:text,loaded:!0,loading:!1})}catch(e){if(addin.set("loading",!1),error)return void error(e)}success&&success(addin)},error:function(e){addin.set("loading",!1),error&&error(e)}})}},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1,lazy:!1}),function(e){try{var t=e.get("addInCode");t&&(e.set({processed:!0}),t(m,$))}catch(i){console.log(i)}})},evaluatePending:function(){_.each(this.addinCollection.where({evaluated:!1,lazy:!1}),function(addin){try{var rawCode=addin.get("rawCode");if(rawCode){addin.set({evaluated:!0});var addIn=eval(rawCode);addin.set({addInCode:addIn})}}catch(e){console.log(e)}})}}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0}}),m.CommandManager=Backbone.Collection.extend({model:m.models.Command,initialize:function(){var e=this;this.commandSources=new Backbone.Collection,m.commands&&_.mapObject(m.commands,function(t){e.registerCommandModel(t,!1)})},registerCommandModel:function(e,t){var i=new e;if(i&&i.id&&(t||!this.get(i.id))){var n=this.get(i.id);n&&this.remove(n),this.add(i)}},registerCommandSources:function(e){e&&e.length>0&&_.each(e,this.registerCommandSource,this)},registerCommandSource:function(e){if(!e.id)throw new Error("An id property is required in cmdSrc");if(!e.addin)throw new Error("An addin property is required in cmdSrc");this.commandSources.findWhere({id:e.id})||this.commandSources.add({id:e.id,addin:e.addin})},registerCommand:function(e,t,i,n){var o={defaults:{id:e},execute:t};i&&(o.canExecute=i);var s=m.models.Command.extend(o);this.registerCommandModel(s,n)},getCommand:function(e){return e?this.get(e):null},ensureCommandLoaded:function(e,t,i,n){var o=this,s=this.get(e);if(s)return void(t&&t(s));if(i)try{i()}catch(a){}var l=this.commandSources.get(e);l?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),t&&t(s)},i,function(e){l.set("loading",!1),n&&n(e)})):(url=m.globals.urlRootApi+"commands/"+encodeURIComponent(e),$.ajax({url:url,beforeSend:m.utils.setMomentumAuthHeader,success:function(a){a&&(o.registerCommandSource(a),l=o.commandSources.get(e),l?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),t&&t(s)},i,function(e){l.set("loading",!1),n&&n(e)})):n&&n("no command with that id is registered"))},error:function(e){n&&n("no command with that id is registered")}}))},execute:function(e){var t=this.getCommand(e);if(t)return t.execute.apply(t,[].slice.call(arguments,1))},canExecute:function(e){var t=this.getCommand(e);return!t||t.canExecute.apply(t,[].slice.call(arguments,1))},getProperties:function(e){var t=this.getCommand(e);return!t||!t.getProperties||t.getProperties.apply(t,[].slice.call(arguments,1))}}),m.models.SettingsManager=Backbone.Model.extend({initialize:function(){this.listenTo(m,"settings:register:nav",this.registerNavItem),this.listenTo(m,"settings:register:subnav",this.registerSubNavItem),this.listenTo(m,"settings:register:panel",this.registerPanel),window.addEventListener("storage",function(e){"loggedOut"!=e.key&&"loggedIn"!=e.key||window.location.reload()}),this.registerStockCommandSources()},stockNavItems:null,navItems:[],secondaryNavItems:[],panelItems:[],registerNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),!this.addOrReplaceIfOverride(this.navItems,e)&&(!this.addOrReplaceIfOverride(this.stockNavItems.navItems,e)&&(this.navItems.push(e),!0))},registerPanel:function(e){return!this.addOrReplaceIfOverride(this.panelItems,e)&&(this.panelItems.push(e),!0)},registerSubNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),!this.addOrReplaceIfOverride(this.secondaryNavItems,e)&&(!this.addOrReplaceIfOverride(this.stockNavItems.secondaryNavItems,e)&&(this.secondaryNavItems.push(e),!0))},addOrReplaceIfOverride:function(e,t,i){var n=i||{id:t.id},o=_.findWhere(e,n);return!!o&&(!t.override||(e.splice(e.indexOf(o),1),e.push(t),!0))},registerNavItems:function(e){var t=this,i=!1;e&&(e.nav&&_.each(e.nav,function(e){t.registerNavItem(e)&&(i=!0)}),e.subNav&&_.each(e.subNav,function(e){t.registerSubNavItem(e)&&(i=!0)}),e.panels&&_.each(e.panels,function(e){t.registerPanel(e)}),i&&this.trigger("navItemsChanged"))},getNavItems:function(){this.populateStockNavItems();var e=_.chain(this.stockNavItems.navItems).union(this.navItems).sortBy("position").value(),t=_.chain(this.stockNavItems.secondaryNavItems).union(this.secondaryNavItems).sortBy("position").value();return{navItems:e,secondaryNavItems:t}},getPanelItems:function(){return this.panelItems},registerStockCommandSources:function(){m.commandManager.registerCommandSources([{id:"settings.panels.quotes",addin:"DD106F35-669C-4079-A9E3-82DDC5244D0B"},{id:"settings.panels.backgrounds",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"settings.panels.todo",addin:"270AAED6-337F-433F-9D02-A471B435EADA"},{id:"settings.panels.balance",addin:"1E373FA7-A454-4652-8D77-1A4FCC88C069"},{id:"settings.panels.metrics",addin:"DB0B33AA-8ED6-4FFC-B0E0-732A9FF3391D"},{id:"background.custom.uploadfiles",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"tour.plus.show",addin:"E38E9785-27CE-4CAB-8497-8B34AB56B6A1"},{id:"settings.panels.trello.config",addin:"C61B7775-7AB8-443A-A6B7-C8C8DE6FC755"}]),this.registerPanel({id:"trello",section:"todo",cmd:"settings.panels.trello.config"})},populateStockNavItems:function(){if(!this.stockNavItems){var e=[],t=[];m.conditionalFeatures.featureEnabled("plus")?(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",cmd:"settings.panels.todo",position:20},{id:"metrics",title:"Metrics",cmd:"settings.panels.metrics",position:30},{id:"background-settings",title:"Backgrounds",cmd:"settings.panels.backgrounds",position:36},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40},{id:"balance",title:"Balance",cmd:"settings.panels.balance",position:50}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What's New",position:20},{id:"about",title:"About",position:30}]):(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",cmd:"settings.panels.todo",position:20},{id:"background-settings",title:"Backgrounds",cmd:"settings.panels.backgrounds",position:36},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40},{id:"balance",title:"Balance",cmd:"settings.panels.balance",position:50}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What's New",position:20},{id:"about",title:"About",position:30},{id:"upgrade",title:"Go Plus",cmd:"upsell.website",cmdonly:!0,options:{source:"nav-upgrade-plus"},position:40}]),this.stockNavItems={navItems:e,secondaryNavItems:t}}},infinispin:function(){var e=localStorage.getItem("infinispin");return e=!!e&&JSON.parse(e)},toggleInfinispin:function(){var e=!this.infinispin();return localStorage.setItem("infinispin",e),e}}),m.models.ThemeManager=Backbone.Model.extend({initialize:function(){},defaultFontFamily:'"Helvetica Neue",Helvetica,Arial,sans-serif',initializeThemes:function(){this.listenTo(m.models.customization,"change:themeColour",this.setThemeColour),this.listenTo(m.models.customization,"change:themeFont",this.setThemeFont),this.listenTo(m,"user:successfulLogin user:successfulLogout",this.onLoginEvent),this.loadAllThemeValues()},loadAllThemeValues:function(){this.loadThemeColour(),this.setThemeColour(),this.setThemeFont()},setColorValues:function(e,t){this.colors=t,this.setThemeColour()},saveThemeColour:function(){this.colors&&m.models.customization.set("themeColourCustom",this.toRgbA(this.colors))},loadThemeColour:function(){try{if(m.models.customization.has("themeColourCustom")){var e=m.models.customization.get("themeColourCustom");e&&(this.colors=new Colors({color:e}).colors)}}catch(t){}},getThemeColour:function(){return this.colors},getThemeColourRGBA:function(){return this.colors?this.toRgbA(this.colors):null},setThemeColour:function(){if(m.conditionalFeatures.featureEnabled("plus")){var e=m.models.customization.get("themeColour");if("light"==e)$("body").addClass("light"),this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null);else if("dark"==e)$("body").removeClass("light"),this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null);else if("custom"==e)if(this.colors){var t=".pane { background-color: "+this.toRgbA(this.colors)+" !important; }";t=t+".dropdown, .todo-list-chooser-dropdown, .todo-list-chooser.choosing { background-color: #"+this.colors.HEX+" !important; }",t=t+".nipple-bottom-left:before, .nipple-bottom-right:before { border-top-color: "+this.toRgbA(this.colors)+" !important}",t=t+".nipple-top-left:before, .nipple-top-right:before { border-bottom-color: "+this.toRgbA(this.colors)+" !important}",this.$themeColourCustom?$(this.$themeColourCustom).html(t):($("head").append('<style type="text/css" id="themeColourCustom">'+t+"</style>"),this.$themeColourCustom=$("head").find("#themeColourCustom").first()),this.colors.RGBLuminance>.5?$("body").addClass("light"):$("body").removeClass("light")}else $("body").removeClass("light")}else $("body").removeClass("light"),this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null)},toRgbA:function(e){return"rgba("+Math.round(255*e.rgb.r)+","+Math.round(255*e.rgb.g)+","+Math.round(255*e.rgb.b)+","+e.alpha+")"},getAvailableFonts:function(){return[{label:"Classic",value:"default"},{label:"Modern",value:"modern"},{label:"Startup",value:"startup",breakafter:!0},{label:"Retro",value:"retro"},{label:"Warehouse",value:"warehouse"},{label:"Quirky",value:"quirky"}]},setThemeFont:function(){var e=this,t=m.models.customization.get("themeFont")||"default";if(m.conditionalFeatures.featureEnabled("plus")){var i=this.defaultFontFamily;if(t&&"default"!=t){var n=null,o=localStorage.getItem("font-"+t);if(o)n=JSON.parse(o),i=this.setFontFromInfo(n)||this.defaultFontFamily,this.setActiveFont(i,t);else try{$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"fonts/"+t}).done(function(n){n&&(localStorage.setItem("font-"+t,JSON.stringify(n)),i=e.setFontFromInfo(n)||e.defaultFontFamily)}).fail(function(e,t){}).always(function(){e.setActiveFont(i,t)})}catch(s){}}else this.setActiveFont(i,t)}else this.setActiveFont(this.defaultFontFamily,t)},setFontFromInfo:function(e){var t=null;if(e){if(!e.builtin){var i=$("head"),n=i.find("#font-"+e.font).first();if(!n||0==n.length){var o=null;e.fontInline?(o=$('<style type="text/css"></style>'),o.html(e.fontInline)):e.fontUrl&&(o=$('<link rel="stylesheet" type="text/css">'),o.attr("href",e.fontUrl)),o&&(o.attr("id","font-"+e.font),i.append(o))}}t=e.exclude_default?e.fontFamily:e.fontFamily+","+this.defaultFontFamily}return t},setActiveFont:function(e,t){var i="body, input, select, textarea, button",n=i+" {font-family: "+e+"; !important}",o=document.createElement("style"),s=$(o);s.attr("type","text/css"),document.head.appendChild(o);var a=o.sheet;a.insertRule(n,0),s.attr("id","font-override");var l=$("body");_.each(this.getAvailableFonts(),function(e){e.value==t?l.addClass("f--"+e.value):l.removeClass("f--"+e.value)})},onLoginEvent:function(){this.listenToOnce(m,"sync:settings:complete",this.loadAllThemeValues)}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"client:id_created",this.onClientIdCreated),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange()},onUserLogin:function(e){this.doDownload(),this.syncSettings(e)},doDownload:function(e){try{var t=this;if(!localStorage.client_uuid)return;var i=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(e){var n=[];e.indexOf("quote")>-1&&(n[n.length]="quote",localStorage.removeItem(t.ddlQuoteString())),e.indexOf("background")>-1&&(n[n.length]="background",localStorage.removeItem(t.ddlBackgroundString())),i+=n.length>0?n.join(","):"all"}else i+="all",localStorage.removeItem(t.ddlBackgroundString()),localStorage.removeItem(t.ddlQuoteString());if(i=i+"&localDate="+getActiveDateString(),!localStorage.firstSynchronized){var o=m.models.activeBackground.activeBackgroundUuid();if(!o){var s=m.collect.legacyBackgrounds.getCurrentLocalBackground();s&&(o=s.backgroundUuid())}o&&(i=i+"&legacyBackground="+o)}$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(e){e.quotes&&e.quotes.length>0&&(m.collect.quotes.reset(e.quotes),m.collect.quotes.invoke("save"),localStorage.shortquote&&localStorage.removeItem("shortquote"),localStorage.setItem(t.ddlQuoteString(),Date.now()),e.ts_quotes&&localStorage.setItem("ts_quotes",JSON.stringify(e.ts_quotes))),e.backgrounds&&e.backgrounds.length>0&&(m.collect.backgrounds.reset(e.backgrounds),m.collect.backgrounds.invoke("save"),localStorage.background&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds")),localStorage.setItem(t.ddlBackgroundString(),Date.now()),e.ts_backgrounds&&localStorage.setItem("ts_backgrounds",JSON.stringify(e.ts_backgrounds))),localStorage.setItem("firstSynchronized",Date.now())}).fail(function(e,i){if(e.status>0){var n=m.models.backgroundManager.latestBackgroundDate();n&&n>Date.parse(getActiveDateString())&&localStorage.setItem(t.ddlBackgroundString(),Date.now());var o=m.models.quoteManager.latestQuoteDate();o&&o>Date.parse(getActiveDateString())&&localStorage.setItem(t.ddlQuoteString(),Date.now())}else m.trigger("sync:error")})}catch(a){}},doDownloadIfNeeded:function(e){var t=!1,i=!1;if(e){if(e.ts_backgrounds){var n=localStorage.getItem("ts_backgrounds");n?e.ts_backgrounds>JSON.parse(n)&&(t=!0):t=!0}if(e.ts_quotes){var o=localStorage.getItem("ts_quotes");o?e.ts_quotes>JSON.parse(o)&&(i=!0):i=!0}}t||localStorage[this.ddlBackgroundString()]||(t=!0),i||localStorage[this.ddlQuoteString()]||(i=!0),t&&i?this.doDownload():t?this.doDownload("background"):i&&this.doDownload("quote")},pingApi:function(e,t){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(t){e&&e()}).fail(function(e,i){t&&t()})},ddlBackgroundString:function(){return"ddl-bg-"+getActiveDateString()},ddlQuoteString:function(){return"ddl-qt-"+getActiveDateString()},onClientIdCreated:function(){this.doDownload(),this.syncSettings()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");t&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e){if(!this.syncSettingsInProgress&&!m.models.customization.fetching&&m.conditionalFeatures.featureEnabled("serversettings")){if(e){var t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization.getPersistentSettings()),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(e,t){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,i){var n={feature:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(n),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/featurerequest"}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},syncSettings:function(e){if(localStorage.client_uuid){this.syncSettingsInProgress=!0;var t=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){if(e){e.greetings&&(localStorage.greetings=e.greetings),e.features&&m.conditionalFeatures.setFeatures(e.features,!0),e.customization&&m.models.customization.save(e.customization),e.lists&&e.lists.length>0&&m.models.todoListManager&&m.models.todoListManager.mergeLists(e.lists),m.commandManager.execute("addins.load",e.addIns),m.commandManager.registerCommandSources(e.cmd),m.settingsManager.registerNavItems(e.nav),e.download&&m.trigger("sync:download",e.download),e.ts_notifications&&m.trigger("notifications:timestamp",e.ts_notifications);var t=null;e.ts_backgrounds&&(t=t||{},t.ts_backgrounds=e.ts_backgrounds),e.ts_quotes&&(t=t||{},t.ts_quotes=e.ts_quotes),t&&m.trigger("sync:downloadIfNeeded",t)}}).fail(function(e,t){}).always(function(){t.syncSettingsInProgress=!1,m.trigger("sync:settings:complete"),e&&e()})}}}),m.models.ConditionalFeatures=Backbone.Model.extend({initialize:function(e){this.customization=e.customization||m.models.customization;try{localStorage.f3t6b23d?this.featureList=JSON.parse(atob(localStorage.f3t6b23d)):this.featureList=[]}catch(t){this.featureList=[]}},featureEnabled:function(e){return _.contains(this.featureList,e)},setFeatures:function(e,t){var i=_.contains(this.featureList,"servertodos");if(localStorage.f3t6b23d!==e)return localStorage.f3t6b23d=e,this.featureList=JSON.parse(atob(e)),t&&!i&&_.contains(this.featureList,"servertodos")?void window.location.reload():void m.trigger("feature:changed")},clearFeatures:function(){this.featureList=[],localStorage.removeItem("f3t6b23d")},checkFeatureAndMigrateData:function(e,t,i,n,o,s){var a=null,l=this;if(this.featureEnabled(e)){for(var r=!1,d=0;d<localStorage.length;d++)if(keyName=localStorage.key(d),0===keyName.indexOf(i+"-")){var r=!0;break}if(r)try{for(var c=new Date,h=c.getFullYear().toString()+"-"+twoDigit(c.getMonth()+1)+"-"+twoDigit(c.getDate())+"-"+twoDigit(c.getHours())+":"+twoDigit(c.getMinutes())+":"+twoDigit(c.getSeconds()),u="migrated-"+i+"-"+h,g=[],p=[],d=0;d<localStorage.length;d++)if(keyName=localStorage.key(d),0===keyName.indexOf(i+"-")){p.push(keyName);var f=localStorage.getItem(keyName);if(f){var v=JSON.parse(f);g.push(v)}}var w={items:g},y=JSON.stringify(w);$.ajax({type:"POST",contentType:"application/json",data:y,beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"migrate/"+i}).done(function(e,o,s){localStorage.setItem(u,y);for(var a in p)localStorage.removeItem(p[a]);localStorage.removeItem(i),m.trigger("sync:customization"),t&&!l.customization.getComputedSetting(t)||n()}).fail(function(e,i){t&&!l.customization.getComputedSetting(t)||o()})}catch(b){console.log(b)}else a=n}else a=o;a&&(!t||this.customization.getComputedSetting(t)?a():s?s(a):this.setPreferenceChangeListener(t,a))},setPreferenceChangeListener:function(e,t){var i=this;m.listenToOnce(this.customization,"change:"+e,function(){i.customization.getComputedSetting(e)?t():i.setPreferenceChangeListener(e,t)})},checkPreferenceForRender:function(e,t,i){t&&(!e||this.customization.getComputedSetting(e)?t():i&&i(t))}}),m.models.Widget=Backbone.Model.extend({}),m.collect.Widgets=Backbone.Collection.extend({model:m.models.Widget}),m.views.BasePlaceholder=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=this.model.get("region"),t=(this.model.get("order")||"append")+"To";return this.$el[t]("#"+e).fadeTo(0,0).html(this.template(model.toJSON())).fadeTo(500,1),this},attributes:function(){return{id:this.model.get("id"),"class":this.model.get("class")}},detach:function(){this.unbind(),this.stopListening(),this.undelegateEvents()}}),m.views.PanePlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.pane,open:!1,events:{"click .toggle":"toggleShow"},initialize:function(){var e=this;this.region=this.model.get("region"),this.visibleStateKey=this.model.get("visibleState"),this.render(),this.model.get("closeOnEsc")&&this.listenTo(m,"globalEvent:esc",this.handleGlobalEsc),this.model.get("toggleEvent")&&this.listenTo(m,this.model.get("toggleEvent"),this.toggleShow),this.model.get("hideEvents")&&_.each(this.model.get("hideEvents"),function(t){e.listenTo(m,t,e.onHideEvent)});var t=this.model.get("visibleSetting");t&&this.listenTo(m.models.customization,"change:"+t,this.visibleChanged),this.shouldShowPane()&&this.showPane()},attributes:function(){return{id:this.model.get("id")+"-wrapper","class":"widget-"+this.model.get("region")}},render:function(){var e=this.model.get("label"),t=(this.model.get("order")||"append")+"To";if(!this.renderedOnce){this.$el[t]("#"+this.region).fadeTo(0,0).html(this.template({label:e})).fadeTo(500,1),this.$pane=this.$(".pane");var i=this.model.get("width")+"px",n="200px";if(this.model.has("height"))n=this.model.get("height")+"px";else{var o=this.storedPaneHeight();o&&(n=o+"px")}this.$pane.css({width:i,height:n}),this.$el.find(".pane-container").addClass("nipple-"+this.region),this.renderedOnce=!0}return this},storedPaneHeight:function(){if(this.model.has("storedHeight")){var e=this.model.get("storedHeight"),t=localStorage[e];if(t)return JSON.parse(t)}return null},toggleShow:function(e){e&&e.stopPropagation&&e.stopPropagation(),e&&e.preventDefault&&e.preventDefault(),this.open?this.hidePane():this.showPane()},showPane:function(){if(!this.open){if(this.open=!0,localStorage.setItem(this.visibleStateKey,this.open),this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),this.realView)this.realView.onShowPane&&this.realView.onShowPane();else{if(this.loading)return;if(!this.model.has("addin"))return;this.loading=!0,m.addinManager.ensureAddinLoaded(this.model.get("addin"))}m.trigger("globalEvent:toggle:"+this.region,this),m.trigger("globalEvent:toggle",this)}},hidePane:function(){var e=this;this.open&&(this.open=!1,localStorage.setItem(this.visibleStateKey,this.open),this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(t){e.$el.removeClass("show")}),this.realView&&this.realView.onHidePane&&this.realView.onHidePane())},shouldShowPane:function(){if(this.model.has("visibleState")){var e=localStorage[this.visibleStateKey];if(e)return JSON.parse(e)}return!1},addRealView:function(e){this.realView=e,this.open&&this.realView.onShowPane&&this.realView.onShowPane()},handleGlobalEsc:function(e){!this.open||this.realView&&this.realView.preventCloseOnEsc&&this.realView.preventCloseOnEsc()||this.toggleShow(e)},onHideEvent:function(e){e!=this&&this.hidePane()},visibleChanged:function(e){var t=this.model.get("visibleSetting"),i=m.models.customization.getComputedSetting(t);i?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)}}),m.views.MetricPlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.metric,initialize:function(){var e=this;this.render(),setTimeout(function(){m.addinManager.ensureAddinLoaded(e.model.get("addin"))},25)},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;var e={},t=this.model.get("cachedKey");t&&(e=JSON.parse(localStorage.getItem(t)));var i=this.model.get("region"),n=(this.model.get("order")||"append")+"To";this.$el[n]("#"+i).fadeTo(0,0).html(this.template(e)).fadeTo(500,1)}return this},addRealView:function(e){this.realView=e}}),m.models.WidgetManager=Backbone.Model.extend({skippedPlaceholders:[],initialize:function(){var e=this;m.models.customization.initialized?e.setup():this.listenToOnce(m.models.customization,"initialized",function(){e.setup()})},setup:function(){this.widgets=m.collect.widgets=new m.collect.Widgets,this.listenTo(this.widgets,"add",this.onAdd),this.listenTo(m,"user:successfulLogin",this.onSuccessfulLogin),this.populatePlaceholders()},populatePlaceholders:function(){this.widgets.add({id:"notes",label:"Notes",type:"pane",region:"bottom-right",order:"prepend",storedHeight:"notes-pane-height",visibleState:"showNotes",width:450,height:450,addin:"23c67761-9831-415e-b358-c6844eb6c244",requiredFeature:"notes",toggleEvent:"globalEvent:key:N",hideEvents:["globalEvent:toggle:bottom-left","globalEvent:toggle:bottom-right","globalEvent:toggle:top-right"],closeOnEsc:!0,visibleSetting:"notesVisible"}),this.widgets.add({type:"metric",id:"countdown","class":"metric countdown add-shadow",region:"top-right",order:"prepend",cachedKey:"current-countdown",addin:"fb230b62-96ce-44b5-87c5-4a563553038b",requiredFeature:"countdown",visibleSetting:"countdownVisible"})},onAdd:function(e){this.addWidget(e)},onSuccessfulLogin:function(){var e=this,t=this.skippedPlaceholders;this.skippedPlaceholders=[],_.each(t,function(t){e.addWidget(t)})},addWidget:function(e,t){var i=this;if(t=t||!1,e.has("requiredFeature")&&!m.conditionalFeatures.featureEnabled(e.get("requiredFeature")))return void this.skippedPlaceholders.push(e);if(!t&&e.has("visibleSetting")){var n=e.get("visibleSetting");if(!m.models.customization.getComputedSetting(n))return void this.listenToOnce(m.models.customization,"change:"+n,function(){var t=!!m.models.customization.getComputedSetting(n);i.addWidget(e,t)})}var o=null;o="metric"==e.get("type")?new m.views.MetricPlaceholder({model:e}):new m.views.PanePlaceholder({model:e}),e.placeholder=o},handover:function(e,t,i){var i=i||{},n=this.widgets.find({id:e});if(n){var o=n.placeholder;if(!o)return void console.log("error: no placeholder");var s=n.get("type");"pane"==s?i.el=o.$pane:"metric"==s&&(i.el=o.el);var a=new t(i);return o.addRealView(a),n.realview=a,a}return new t(i)}}),m.models.BackgroundBase=Backbone.Model.extend({backgroundUuid:function(){var e=this.get("_id");if(e)return e;var t=this.get("filename");if(0===t.indexOf("http"))return null;var i=t.split("/");if(2==i.length){var i=i[1].split(".");if(2==i.length)return i[0]}return null}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){e.backgrounds.length>0&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var e=this.fallbackKey(),t=localStorage.getItem(e),i=null,n=this;t?this.legacyBackgrounds.getBackground(t,function(t){t||(t=n.legacyBackgrounds.getCurrentLocalBackground(),t&&localStorage.setItem(e,t.backgroundUuid())),t&&(n.usingFallback=!0,n.setActiveBackground(t))}):i||(i=n.legacyBackgrounds.getCurrentLocalBackground(),i&&(localStorage.setItem(e,i.backgroundUuid()),n.usingFallback=!0,n.setActiveBackground(i)))},collectionReady:function(){this.usingFallback||this.checkActiveBackground()},fallbackKey:function(){return"fallback-"+getActiveDateString()},legacyCollectionReady:function(){if(this.backgrounds.length>0){var e=this.backgrounds.get(getActiveDateString());e||this.checkActiveBackground()}else this.checkActiveBackground()},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e=null;return this.backgrounds&&this.backgrounds.length>0&&(e=this.backgrounds.getActiveBackground())?void this.setActiveBackground(e):void this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem),this.preCacheFutureBackgroundImages()},setActiveBackground:function(e){e&&this.lastBgId!=e.get("_id")&&(this.lastBgId=e.get("_id"),this.backgroundItem&&this.backgroundItem.cid==e.cid||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activechanged",e)))},generateUUID:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)});return t},preCacheFutureBackgroundImages:function(){var e=this,t=Date.parse(getActiveDateString());this.backgrounds&&this.backgrounds.length>0&&this.backgrounds.map(function(i){var n=Date.parse(i.get("forDate"));n>t&&e.preCacheBackgroundImage(i)})},preCacheBackgroundImage:function(e){if(e){var t=e.get("filename");if(t&&0===t.indexOf("http"))try{var i=new Image;i.addEventListener("load",function(e){i.removeEventListener("load",arguments.callee,!1)},!1),i.src=t}catch(n){}}}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t=e.id;if(!t){var i=e.filename,n=i.split("/");if(2==n.length){var n=n[1].split(".");2==n.length&&(t=n[0])}}this.set({id:t,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(e){return filtered=this.filter(function(t){return t.get("fallbackDate")<e}),new m.collect.Fallbacks(filtered)}}),m.collect.Backgrounds=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-background"),model:m.models.Background,getActiveBackground:function(){if(this.length>0){var e=getActiveDateString();return this.get(e)}}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){this.initialized=!1,this.listenTo(this,"reset",function(){this.initialized=!0}),localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getBackground:function(e,t){if(this.initialized)return void t(this.get(e));var i=this;setTimeout(function(){i.getBackground(e,t)},10)},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),i=localStorage.getItem(t);if(i&&(e=this.get(i)),!e){if(!this.parseRecentFallbacks())return null;
var n=Math.floor(.75*this.models.length),o=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),s=_.first(o,n),a=_.map(s,function(e){return e.get("backgroundGuid")}),l=this.pluck("id");if(m.collect.backgrounds){var r=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))});n=Math.floor(.25*this.models.length);var d=_.first(r,n),c=_.map(d,function(e){return e.get("_id")});a=_.union(a,c)}var h=_.difference(l,a);if(h.length>0){var u=_.sample(h);e=this.get(u)}else e=this.sample()}return e},parseRecentFallbacks:function(){if(this.fallbacks)return!0;this.fallbacks=new m.collect.Fallbacks;var e=this;return $.each(localStorage,function(t,i){if(0===t.indexOf("fallback-")){var n=t.slice(9),o=Date.parse(n),s=new Backbone.Model({fallbackDate:o,backgroundGuid:i});e.fallbacks.add(s)}}),!0}}),m.models.BackgroundManager=Backbone.Model.extend({initialize:function(e,t){m.collect.backgrounds=new m.collect.Backgrounds,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds})},firstFetch:function(){m.collect.backgrounds.fetch({reset:!0}),m.collect.legacyBackgrounds.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new background. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},skipBackground:function(e){var t=this,i=m.globals.urlRootApi+"backgrounds",n=m.models.activeBackground.activeBackgroundUuid(),o={operation:"skip",active_uuid:n};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(o),url:i}).done(function(e){if(e&&e.success&&m.trigger("sync:download","background"),e&&e.notification){if("max_skips"==e.notification.type){if(localStorage.displayedMaxSkips)return;localStorage.displayedMaxSkips=!0}m.commandManager.execute("notification.show.enhanced",e.notification)}}).fail(function(i,n){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()})}catch(s){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()}},toggleFavorite:function(e,t){var i=this,n=m.globals.urlRootApi+"backgrounds/favorites",o=m.models.activeBackground.activeBackgroundUuid(),s={operation:"favorite",active_uuid:o,is_favorite:e};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(s),url:n}).done(function(e){e&&e.success&&(m.trigger("sync:download","background"),m.trigger("background:favorite",{id:s.active_uuid,is_favorite:s.is_favorite}))}).fail(function(e,n){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()})}catch(a){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()}},latestBackgroundDate:function(){var e=null;return m.collect.backgrounds.models.forEach(function(t){var i=Date.parse(t.id);(!e||i>e)&&(e=i)}),e}}),m.views.Background=Backbone.View.extend({tagName:"li",attributes:{},events:{click:"closeTrays"},isBackgroundLoaded:!1,initialize:function(){this.model=m.models.backgroundManager,this.listenTo(m.models.activeBackground,"background:activechanged",this.setBackground)},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(e){var t=this,i=4e3,n=!1;t.isBackgroundLoaded&&(n=!0);var o=e.get("filename"),s=e.backgroundUuid(),a=(e.get("title"),e.get("source"),e.get("sourceUrl"),(this.options.order||"append")+"To");$("#background").css("background-image",$("#background").find("li").css("background-image")),this.lastId=s,this.loadCompleted=!1,"true"==localStorage.getItem("failed:"+o)&&(t.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback")),$("<img/>").on("load",function(){var i=!1,n=e.get("height"),l=e.get("width");if(n&&l)this.height==n&&this.width==l||(i=!0);else{var r=e.get("skip_check");r||(this.height<750||this.width<1e3)&&(i=!0)}if(i)return m.models.activeBackground.trigger("background:fallback"),localStorage.setItem("failed:"+o,"true"),void(t.loadCompleted=!0);var d="fadein";t.isBackgroundLoaded&&(d="fadein-slow"),t.loadCompleted=!0,m.models.activeBackground.successfullyLoaded(s),t.isBackgroundLoaded=!0,s===t.lastId&&(t.$el[a]("#"+t.options.region).css("background-image","url("+o+")").addClass(d),$(this).remove(),$(".widgets").addClass("fadein")),setTimeout(function(){$(".background-overlay").addClass("show")},5),setTimeout(function(){m.trigger("background:loadSuccessful",s)},200)}).on("error",function(e){t.loadCompleted=!0,t.isBackgroundLoaded?m.trigger("background:error",s):m.models.activeBackground.trigger("background:fallback")}).attr("src",o),n||window.setTimeout(function(){t.loadCompleted||(t.loadCompleted=!0,console.log("image fallback via timer"),m.models.activeBackground.trigger("background:fallback"))},i)},closeTrays:function(e){$(".show").each(function(){removeClass("show")})}}),m.views.BackgroundInfo=Backbone.View.extend({tagName:"div",attributes:{id:"background-info","class":"background-info"},template:m.templates.background["background-info"],events:{mouseenter:"handleHoverOn",mouseleave:"handleHoverOff",click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .background-info-source-link":"clickSource","click .source-url":"trackClick","click .control-heart":"toggleFavorite","click .control-refresh":"skipBackground"},initialize:function(){this.listenTo(m.models.activeBackground,"background:successfullyLoaded",this.activeBackgroundReady),this.listenTo(m.models.activeBackground,"background:error",this.skipFailed),this.listenTo(m,"sync:error",this.skipFailed),this.listenTo(m,"globalEvent:windowBlur",this.unfocusBg)},parentReady:function(e){this.isParentReady=!0,(this.isBackgroundReady||e)&&this.render()},activeBackgroundReady:function(){this.isBackgroundReady=!0,this.isParentReady&&this.render()},render:function(){m.models.activeBackground&&m.models.activeBackground.backgroundItem&&this.setBackground(m.models.activeBackground.backgroundItem),this.$bgOverlay=$(".background-overlay")},setBackground:function(e){var t=this,i="",n=null,o="",s="",a="",l="",r=!1,d=!1;e&&(i=e.get("title"),s=e.get("sourceUrl"),a=e.get("detail_url"),n=e.get("attribution"),o=e.get("source"),n||(n="Photo by "+o),e.get("is_favorite")&&(r=!0,l="active")),this.activeBackground?this.activeBackground.backgroundUuid()!=e.backgroundUuid()?d=!0:i==this.activeBackground.get("title")&&n==this.activeBackground.get("attribution")||(d=!0):d=!0,d&&(this.activeBackground=e),a&&a.length>0?(this.detail_url=a,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link"));var c={title:i,source:o,sourceUrl:s,attribution:n,fav_class:l};if(this.renderedOnce)d&&this.$el.fadeTo(500,0,function(){t.$background_info_title.html(i+'<i class="icon-angle-right"></i>'),t.$background_info_source_link.text(n),t.$el.fadeTo(500,1)});else{var h=(this.options.order||"append")+"To";this.$el[h]("#"+this.options.region).fadeTo(0,0).html(this.template(c)).fadeTo(500,1),this.$background_info_source_link=this.$el.find(".background-info-source-link").first(),this.$background_info_title=this.$el.find(".background-info-title").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.renderedOnce=!0}return s&&s.length>0?(this.$background_info_source_link.data("url",s),this.$background_info_source_link.removeClass("no-link")):(this.$background_info_source_link.data("url",null),this.$background_info_source_link.addClass("no-link")),this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1),m.conditionalFeatures.featureEnabled("skip-bg")?this.$control_refresh.show():this.$control_refresh.hide(),this.$control_heart.show(),r?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),this},handleHoverOn:function(){this.hovering=!0;var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":1})},300),setTimeout(function(){e.hovering&&e.focusOnBg()},4e3)},focusOnBg:function(){if(!this.focusing&&!this.unfocusing){this.focusing=!0;var e=this;setTimeout(function(){e.focusing=!1},1e3),$(".widgets").first().children().each(function(e,t){"bottom-left"==t.id?$(t).addClass("show-photo"):$(t).stop(!0).fadeOut(1e3)}),this.$bgOverlay.addClass("slow"),setTimeout(function(){e.$bgOverlay.removeClass("show")},5),$(".add-shadow").stop(!0).fadeOut(1e3)}},unfocusBg:function(){if(this.unfocusing=!0,this.$bgOverlay){var e=this;setTimeout(function(){e.unfocusing=!1},1e3),$(".widgets").first().children().each(function(e,t){"bottom-left"==t.id?$(t).removeClass("show-photo"):$(t).stop(!0).fadeIn(1e3)}),this.$bgOverlay.addClass("show"),setTimeout(function(){e.$bgOverlay.removeClass("slow")},1e3),$(".add-shadow").stop(!0).fadeIn(1e3)}},handleHoverOff:function(){this.hovering=!1;var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":2}),e.unfocusBg()},300)},clickWidget:function(e){this.detail_url&&this.detail_url.length>0&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&this.detail_url.length>0&&$(this.$el).addClass("has-link")},clickSource:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("url");t&&window.open(t,"_blank")},trackClick:function(){m.sendEvent("BackgroundInfo","Click",localStorage.background)},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.backgroundManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Background",t?"Favourite":"Unfavourite")},skipFailed:function(){this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1)},skipBackground:function(e){var t=this;e.stopPropagation(),this.skipInProgress||(this.skipInProgress=!0,$(e.currentTarget).addClass("active"),m.models.backgroundManager.skipBackground(function(){t.skipFailed()}),m.sendEvent("Background","Skip"))}}),m.views.Search=Backbone.View.extend({id:"search",className:"search top-widget",events:{"focusin .search-input":"handleFocusIn","focusout .search-input":"handleFocusOut","keyup .search-input":"checkForEscape","submit .search-form":"doSearch"},initialize:function(){this.renderedOnce=!1,this.listenTo(m,"globalEvent:click",this.hideResults),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleSearch",this.toggleShow),this.listenTo(m.models.customization,"change:searchVisible",this.visibleChanged),this.render()},render:function(){var e='<form class="search-form"><span class="search-underline"></span><i class="icon-search"></i><input type="text" id="search-input" class="search-input" autocomplete="off"></form><iframe src="" class="search-results"></iframe>',t=(this.options.order||"append")+"To";return this.$el[t]("#"+this.options.region).fadeTo(0,0).html($.trim(e)).fadeTo(500,1),this.$input=this.$el.find("input"),this.renderedOnce=!0,this},visibleChanged:function(e){var t=m.models.customization.get("searchVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doSearch:function(e){e.preventDefault();var t=this.$el.find(".search-input")[0].value;if(t.length>0){var i=m.globals.urlRootApi+"search";if(!localStorage.token){var n=m.models.customization.get("searchProvider");n||(n="google"),i=i+"?provider="+n}$.ajax({type:"GET",beforeSend:m.utils.setMomentumAuthHeader,url:i}).done(function(e,i,n){if(e&&e.searchUrl){var o=e.searchUrl+encodeURIComponent(t);e.searchOutput&&"redirect"==e.searchOutput?window.location.href=o:$(".search-results").attr("src",o).attr("target","_top").addClass("fadein").css("display","block")}}).fail(function(e,i){var n="https://search.momentumdash.com/?q="+encodeURIComponent(t);$(".search-results").attr("src",n).attr("target","_top").addClass("fadein").css("display","block")}),m.sendEvent("Search","Searched")}},handleFocusIn:function(){$(".search").addClass("active"),m.sendEvent("Search","Focused")},handleFocusOut:function(){$(".search").removeClass("active")},hideResults:function(e){(!$.contains(this.el,e.target)&&$(".search-results").hasClass("fadein")||1==e.hide)&&$(".search-results").removeClass("fadein").css("display","none")},checkForEscape:function(e){27==e.keyCode&&this.hideResults({hide:"true"})},toggleShow:function(e){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.bootstrappers.RenderSearch=function(e,t){e.conditionalFeatures.checkPreferenceForRender("searchVisible",function(){e.views.search=new e.views.Search({region:"top-left",order:"append"}),e.widgets.push(e.views.search)},function(t){e.listenToOnce(e.models.customization,"change:searchVisible",t)})},m.models.GenericMetric=Backbone.Model.extend({defaults:{id:null,label:"",value:"",link:null},initialize:function(){this.listenTo(this,"change:metric",this.metricChanged),this.loadData()},loadData:function(){var e=this,t="";this.set("label",t);var i=m.globals.urlRootIntegration+"services/random";try{$.ajax({type:"GET",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:i}).done(function(t,i,n){if(t.metricInfo)e.set("id",t.metricInfo.metricId),e.set("value",t.metricInfo.metricValue),e.set("label",t.metricInfo.metricLabel),t.metricInfo.metricLink?e.set("link",t.metricInfo.metricLink):e.set("link",null);else if(t.status&&"authRequired"==t.status&&t.authorizationUrl&&e.authAttempts<2){e.authAttempts++;var o=t.winWidth?t.winWidth:600,s=t.winHeight?t.winHeight:510,a=t.windowFeatures?t.windowFeatures:"titlebar,resizable,toolbar,status",l=window.screen.width/2-o/2,r=window.screen.height/2-s/2,d=window.open(t.authorizationUrl,"MomentumAuthWindow",a+",left="+l+",top="+r+",width="+o+",height="+s),c=setInterval(function(){d.closed&&(clearInterval(c),e.metricChanged())},250)}}).fail(function(e,t){console.log("failed")})}catch(n){}},clickMetric:function(){this.get("link")}}),m.views.GenericMetric=Backbone.View.extend({attributes:{id:"generic-stats","class":"metric"},template:m.templates.metric.widget,events:{click:"clickMetric",mouseenter:"mouseEnter",mouseleave:"mouseLeave"},initialize:function(){this.renderedOnce=!1,this.render(),this.listenTo(this.model,"change:value",this.render),this.listenTo(this.model,"change:label",this.render)},render:function(){var e=this.model.get("label"),t=this.model.get("value");if(t){var i={statvalue:t,statlabel:e};if(this.renderedOnce)this.$el.html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format");else{var n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template(i)).fadeTo(500,1),this.$time=this.$(".time"),this.$format=this.$(".format"),this.renderedOnce=!0}}},clickMetric:function(e){this.model.clickMetric()}}),m.models.Quote=Backbone.Model.extend({idAttribute:"forDate"}),m.collect.Quotes=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-quote"),model:m.models.Quote,getActiveQuote:function(){if(this.length>0){var e=getActiveDateString();return this.get(e)}}}),m.models.QuoteManager=Backbone.Model.extend({initialize:function(e,t){m.collect.quotes=new m.collect.Quotes},firstFetch:function(){m.collect.quotes.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new quote. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},getActiveQuote:function(){var e=this;if(m.collect.quotes){var t=m.collect.quotes.getActiveQuote();if(!t)return null;var i=!1;if(this.currentQuote&&this.currentQuote.get("_id")==t.get("_id")){var n=this.currentQuote;n.get("body")==t.get("body")&&n.get("source")==t.get("source")&&n.get("twitter")==t.get("twitter")&&n.get("twitterIntentUrl")==t.get("twitterIntentUrl")||(this.currentQuote=t,i=!0)}else this.currentQuote=t,i=!0;return i&&setTimeout(function(){m.trigger("quote:active_changed",e.currentQuote.get("_id"))},50),t}return null},skipQuote:function(e){var t=this,i=m.globals.urlRootApi+"quotes",n=this.getActiveQuote(),o=n.get("_id"),s=n.get("is_custom"),a={operation:"skip",active_uuid:o,is_custom:s};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(a),url:i}).done(function(e){e&&e.success&&m.trigger("sync:download","quote"),e&&e.notification&&m.commandManager.execute("notification.show.enhanced",e.notification)}).fail(function(i,n){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()})}catch(l){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()}},toggleFavorite:function(e,t){var i=this,n=m.globals.urlRootApi+"quotes/favorites",o=this.getActiveQuote(),s=o.get("_id"),a=o.get("is_custom"),l={operation:"favorite",active_uuid:s,is_favorite:e,is_custom:a};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(l),url:n}).done(function(e){e&&e.success&&(m.trigger("sync:download","quote"),m.trigger("quote:favorite",{id:l.active_uuid,is_favorite:l.is_favorite}))}).fail(function(e,n){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()})}catch(r){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()}},latestQuoteDate:function(){var e=null;return m.collect.quotes.models.forEach(function(t){var i=Date.parse(t.id);(!e||i>e)&&(e=i)}),e}}),m.views.Quote=Backbone.View.extend({tagName:"blockquote",attributes:{"class":"quote",id:"shortquote"},template:m.templates.quote.quote,events:{click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .control-twitter":"shareTwitter","click .control-heart":"toggleFavorite","click .control-refresh":"skipQuote"},currentlyActiveQuote:null,initialize:function(){this.renderedOnce=!1;var e=this;this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this.collection,"reset",this.collectionReady),this.listenTo(m.models.customization,"change:quoteVisible",this.visibleChanged),$(window).on("resize",function(){var t=e.$quote_body_text.css("lineHeight"),i=parseInt(t.substring(0,t.length-2)),n=(e.$quote_body_text.height(),e.$quote_body_text.clone());n.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),n.css("position","absolute"),n.css("width","100%"),n.css("top","0"),n.css("left","0"),n.css("margin","0"),n.css("padding","0"),n.appendTo(e.$quote_body_text);var o=n.height();(o<1.75*i||o>2.75*i)&&e.$quote_body_text.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),e.render(),n.remove()})},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){e.collection.length>0&&(e.render(),clearInterval(e.intervalId))},50)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){m.trigger("quote:downloaded"),this.isCollectionReady=!0,this.isParentReady&&this.render()},visibleChanged:function(e){var t=m.models.customization.get("quoteVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},render:function(e){if(0===this.collection.length)return void m.trigger("sync:downloadIfNeeded");var t=m.models.quoteManager.getActiveQuote();if(!t)return void m.trigger("sync:downloadIfNeeded");var i=!1;if(this.currentlyActiveQuote&&this.currentlyActiveQuote.get("_id")==t.get("_id")){var n=this.currentlyActiveQuote;n.get("body")==t.get("body")&&n.get("source")==t.get("source")&&n.get("twitter")==t.get("twitter")&&n.get("twitterIntentUrl")==t.get("twitterIntentUrl")||(this.currentlyActiveQuote=t,i=!0)}else this.currentlyActiveQuote=t,i=!0;var o=this,s=t.get("body"),a=t.get("source"),l=t.get("detail_url"),r=t.get("twitter"),d=t.get("twitterIntentUrl"),c=!1,h="";if(t.get("is_favorite")&&(c=!0,h="active"),!d){var u="";u=r?'"'+s+'" —@'+r:'"'+s+'" —'+a,d="https://twitter.com/intent/tweet?text="+encodeURIComponent(u)+"&via=momentumdash&related=momentumdash,levibucsis,jaywaterman"}var g=0;if(i&&this.renderedOnce&&(g=650),this.renderedOnce)i&&this.$el.fadeTo(500,0,function(){o.$quote_body_text.html("&ldquo;"+s+"&rdquo;"),o.$quote_source_text.html(a),o.$control_twitter.data("url",d),o.$el.fadeTo(500,1)});else{var p={body:s,source:a,twitterIntentUrl:d,fav_class:h},f=(this.options.order||"append")+"To";e?this.$el[f]("#"+o.options.region).html(o.template(p)).fadeTo(500,1):this.$el[f]("#"+o.options.region).fadeTo(0,0).html(o.template(p)).fadeTo(500,1),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.$quote_body_text=this.$el.find(".quote-body-text").first(),this.$quote_source_text=this.$el.find(".quote-source-text").first(),this.$control_twitter=this.$el.find(".control-twitter").first(),this.renderedOnce=!0}l&&l.length>0?(this.detail_url=l,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link")),this.$control_refresh.removeClass("active"),m.conditionalFeatures.featureEnabled("skip-qt")?this.$el.find(".control-refresh").show():this.$el.find(".control-refresh").hide(),this.$control_heart.show(),c?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),setTimeout(function(){var e=o.$quote_body_text.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=o.$quote_body_text.height(),n=!1;if(i>1.75*t&&i<2.75*t){var a,l,r="",d=s.split(" ");for(a=0;a<d.length;a++)l=d[a],r+=l,!n&&r.length>(s.length+5)/2?(r+="<br>",n=!0):a!=d.length-1&&(r+=" ");o.$quote_body_text.html("&ldquo;"+r+"&rdquo;"),i=o.$quote_body_text.height(),i>2.75*t&&o.$quote_body_text.html("&ldquo;"+s+"&rdquo;")}},g)},clickWidget:function(e){this.detail_url&&this.detail_url.length>0&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&this.detail_url.length>0&&$(this.$el).addClass("has-link")},shareTwitter:function(e){e.stopPropagation();var t=screen.width/2-272.5,i=screen.height/2-210;window.open($(e.currentTarget).data("url"),"share","left="+t+",top="+i+",width=545,height=420,resizeable=0")},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.quoteManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Quote",t?"Favourite":"Unfavourite")},skipQuote:function(e){e.stopPropagation(),this.$control_refresh.hasClass("active")||($(e.currentTarget).addClass("active"),m.models.quoteManager.skipQuote(function(){$(e.currentTarget).removeClass("active")}),m.sendEvent("Quote","Skip"))}}),m.bootstrappers.InitializeQuote=function(e,t){e.models.quoteManager=new e.models.QuoteManager},m.bootstrappers.RenderQuote=function(e,t,i){e.conditionalFeatures.checkPreferenceForRender("quoteVisible",function(){e.views.quote=new e.views.Quote({collection:e.collect.quotes,model:e.models.date,region:"bottom"}),e.models.quoteManager.firstFetch(),e.views.quote.parentReady(i),e.widgets.push(e.views.quote)},function(t){e.listenToOnce(e.models.customization,"change:quoteVisible",t)})},m.models.FocusBase=Backbone.Model.extend({defaults:{focus:"",day:"",forDate:null,archived:!1,createdDate:new Date,archivedDate:null,completed:!1,completedDate:null,cached:!1},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{}},archive:function(){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())},toggleCompleted:function(){var e=this.saveOptions(),t=!this.get("completed");return this.save({completed:t,completedDate:this.get("completed")?null:new Date},e),t}}),m.models.Focus=m.models.FocusBase.extend({urlRoot:function(){return this.collection?null:m.globals.urlRoot+"focus"},toggleCompleted:function(){var e=this,t=this.saveOptions(),i=!this.get("completed");if(m.conditionalFeatures.featureEnabled("pinfocus")){var n=e.get("todoId");t.success=function(){m.trigger("focus:toggled",i);var t=e.get("refreshTodo");t&&n&&m.trigger("todo:refresh",n)},t.error=function(t,o,s){if(200==o.status){m.trigger("focus:toggled",i);var a=e.get("refreshTodo");a&&n&&m.trigger("todo:refresh",n)}};var o={completed:i,completedDate:this.get("completed")?new Date:null};this.id.startsWith("todo-")&&(o.todoId=this.get("todoId"),o.focus=this.get("focus")),this.save(o,t),m.trigger("todo:set:done",n,i)}else this.save({completed:i,completedDate:this.get("completed")?null:new Date},t);return i},archive:function(){if(!this.id.startsWith("todo-")){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())}m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&m.models.customization.set("autoFocus",!1)},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{patch:!0}}}),m.collect.FocusesBase=Backbone.Collection.extend({saveOptions:{},attributes:{},successfulLoad:!1,loadingFromServer:!0,fetchedOnce:!1,initialize:function(){this.on("reset",this.onReset,this),this.on("add",this.onAdd,this),this.on("change",this.onModelChanged,this)},fetch:function(e){this.fetchedOnce=!0;var t={};return e=_.extend(e||{},t),Backbone.Collection.prototype.fetch.call(this,e)},onReset:function(){this.successfulLoad=!0,this.loadingFromServer=!1,this.trigger("loadingFromServerChanged")},onModelChanged:function(e){var t=e.changedAttributes(),i=_.keys(t),n=_.without(i,"archived","archivedDate");n.length>0&&this.saveCachedFocus(e)},comparator:function(e){var t=e.get("completedDate");return t||(t=e.get("createdDate"))?-Date.parse(t):0},activeFocus:function(){return this.activeFocusBase()},activeFocusBase:function(){if(this.loadingFromServer)return this.fetchedOnce||this.fetch({reset:!0}),this.cachedFocus();if(0===this.length)return localStorage.removeItem("cachedFocus"),null;var e=null,t=getActiveDateString(),i=this.where({completed:!1,archived:!1,forDate:t});if(1===i.length)e=i[0];else if(0===i.length)if(i=this.where({completed:!0,archived:!1,forDate:t}),1===i.length)e=i[0];else if(0===i.length)return localStorage.removeItem("cachedFocus"),null;return null==e&&_.each(i,function(t){if(null==e)e=t;else{var i=t.get("completedDate"),n=e.get("completedDate");i>n&&(e=t)}}),e?this.saveCachedFocus(e):localStorage.removeItem("cachedFocus"),e},saveCachedFocus:function(e){localStorage.cachedFocus=JSON.stringify(e)},cachedFocus:function(){if(localStorage.cachedFocus){var e=JSON.parse(localStorage.cachedFocus),t=getActiveDateString();if(e&&e.forDate===t)return e.cached=!0,new this.model(e)}return null}}),m.collect.Focuses=m.collect.FocusesBase.extend({model:m.models.Focus,url:m.globals.urlRoot+"focus",saveOptions:{patch:!0},activeFocus:function(){if(!m.conditionalFeatures.featureEnabled("pinfocus")||!m.models.customization.get("autoFocus"))return this.activeFocusBase();if(m.models.todoListManager&&m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedList){var e=m.models.todoListManager.activeProvider.selectedList();if(e&&e.itemCollection&&(e.itemCollection.length>0||!e.itemCollection.loadingFromServer)){var t=null;if(m.views.todoPane&&m.views.todoPane.todoList&&m.views.todoPane.todoList.reordered){var i=m.views.todoPane.todoList.getTopActiveTodoId();i&&(t=e.itemCollection.get(i))}else{var n=_(e.itemCollection.activeToday()).chain().filter(function(e){return!e.get("done")}).value();n&&n.length>0&&(t=n[0])}if(t){var o={};o.id="todo-"+t.id,o.focus=t.get("title"),o.day="today",o.todoId=t.id,o.forDate=getActiveDateString();var s=new m.models.Focus(o);return this.saveCachedFocus(s),s}return this.fetchedOnce?this.successfulLoad?this.activeFocusBase():this.cachedFocus():(this.fetch({reset:!0}),this.cachedFocus())}return e&&e.itemCollection&&e.itemCollection.doFetchIfNeeded(),this.cachedFocus()}return this.cachedFocus()},triggerCollectionReset:function(){this.trigger("reset")},selectedListCacheKey:function(){return localStorage.activeTodoProvider?"activeTodoListId-"+localStorage.activeTodoProvider:null}}),m.collect.FocusesLegacy=m.collect.FocusesBase.extend({model:m.models.FocusBase,localStorage:new Backbone.LocalStorage("momentum-focus"),saveOptions:{},onReset:function(){this.loadingFromServer=!1,this.fixNullForDate(),this.trigger("loadingFromServerChanged")},fixNullForDate:function(){var e=this.where({archived:!1,forDate:null});e&&e.length>0&&_.each(e,function(e){var t=e.get("createdDate");if(t){var i=Date.parse(t),n=activeDateStringForDate(i),o=getActiveDateString();n!=o&&e.archive()}else e.archive()},focus)}}),m.views.Focus=Backbone.View.extend({tagName:"li",attributes:{"class":"focus"},template:m.templates.focus["focus-template"],events:{"click .delete":"destroy","click .checkbox":"toggleCompleted"},initialize:function(){this.render(),this.listenTo(this.model,"change",this.render),m.conditionalFeatures.featureEnabled("pinfocus")&&(this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m,"todo:changing",this.todoChanging),this.listenTo(m,"focus:toggled",this.focusToggled),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged))},todoChanged:function(e,t){e==this.model.get("todoId")&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&m.collect.focuses&&t.hasOwnProperty("done")&&m.collect.focuses.fetch({reset:!0})},todoChanging:function(e,t){e==this.model.get("todoId")&&(t.hasOwnProperty("done")&&this.model.set("completed",t.done),t.hasOwnProperty("title")&&this.model.set("focus",t.title),t.hasOwnProperty("done")&&this.displayAutoPinMessage(t.done))},render:function(){var e=m.utils.captionFormatter(this.model.get("focus")),t={focus:e,day:"Today"};return this.$el.html(this.template(t)),this.model.changed.hasOwnProperty("completed")?this.$el.toggleClass("complete",this.model.changed.completed):this.$el.toggleClass("complete",this.model.get("completed")),this.$el.toggleClass("cached",this.model.get("cached")),this},displayAutoPinMessage:function(e){m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&m.views.focuses.displayLoadingMessage(e)},focusToggled:function(e){e&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&(this.displayAutoPinMessage(e),m.collect.focuses&&m.collect.focuses.fetch({reset:!0}))},destroy:function(){if(this.$el.hasClass("complete"))m.sendEvent("Focus","Add New"),m.trigger("setNewFocus");else{m.sendEvent("Focus","Delete");var e=this;this.$el.fadeTo(500,0,function(){e.destroyed=!0,e.model.archive(),e.remove()})}},autoFocusChanged:function(){this.destroyed&&m.conditionalFeatures.featureEnabled("pinfocus")&&!m.models.customization.get("autoFocus")&&m.trigger("setNewFocus")},removeView:function(){this.remove(),this.unbind()},toggleCompleted:function(){var e=this.model.toggleCompleted();m.views.focuses.displayLoadingMessage(e),m.conditionalFeatures.featureEnabled("serverfocus")||setTimeout(function(){m.views.focuses.dismissConnectionMessage()},3e3),this.$el.toggleClass("complete",e),m.sendEvent("Focus","Done")}}),m.views.FocusPrompt=Backbone.View.extend({attributes:{"class":"prompt"},template:m.templates.focus["focus-prompt-template"],events:{click:"focusInput","focus input":"handleFocus","keypress input":"handleInput","keyup input":"handleKeyup","blur input":"handleBlur"},initialize:function(){this.focusedOnce=!1,this.listenTo(m,"globalEvent:toggleFocus",this.toggleShow),this.listenTo(m,"globalEvent:esc",this.hide),
this.render()},render:function(){return this.$el.html(this.template()),this.$input=this.$el.find("input"),this.collection.loadingFromServer||this.$input.focus(),this},focusInput:function(){this.$input.focus()},handleFocus:function(e){this.focusedOnce=!0,m.views.focuses.promptFocused()},handleBlur:function(){this.focusedOnce=!1,this.$el.removeClass("loading")},handleInput:function(e){this.collection.loadingFromServer&&e.preventDefault(),this.clearHelpTimeout(),13==e.keyCode?this.save():this.startHelpTimeout()},handleKeyup:function(){0==this.getInput().length&&m.views.focuses.dismissConnectionMessage()},getInput:function(){return this.$input.val().trim()},inputTimeout:"",startHelpTimeout:function(){var e=this;this.inputTimeout=setTimeout(function(){e.displayHelpMessage()},5e3)},clearHelpTimeout:function(){this.inputTimeout>0&&clearTimeout(this.inputTimeout)},displayHelpMessage:function(){this.getInput().length>0&&m.views.focuses.displayConnectingText("Press enter to set your focus",!0)},save:function(){var e=this.getInput();if(e){var t=this;m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var i=getActiveDateString();m.collect.focuses.create({focus:e,day:"today",forDate:i},{wait:!0,success:function(){m.views.focuses.successfulConnection(),t.$el.fadeTo(500,0,function(){t.remove(),m.views.focuses.successfullyCreatedNewFocus()})},error:function(e,i,n){t.$input.addClass("pulse"),m.views.focuses.failedConnection(!0)}})}},toggleShow:function(){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.views.Focuses=Backbone.View.extend({attributes:{id:"focuses"},template:m.templates.focus["focuses-template"],events:{"mouseover .todays-focus":"onMouseOver","click .todays-focus":"onClickFocus","click .prompt":"onClickFocus","click .retry":"retryConnection"},offline:!0,loading:!1,clickedOnce:!1,retrying:!0,initialize:function(){var e=["Great work!","Good job!","Nice.","Way to go!"];this.loadingMessage=e[Math.floor(Math.random()*e.length)],this.listenTo(m,"newDay",this.changeDay,this),this.listenTo(m,"setNewFocus",this.setNewFocus,this),this.listenTo(m,"todo:loadingStateChange",this.todoLoadingStateChanged),this.listenTo(m,"todo:managerReady",this.todoLoadingStateChanged),this.listenTo(m,"todo:globalChange",this.todoLoadingStateChanged),this.listenTo(m.collect.focuses,"change:archived",this.todayArchived),this.listenTo(m.collect.focuses,"reset",this.collectionReady),this.listenTo(m.collect.focuses,"sync",this.successfulConnection),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:focusVisible",this.visibleChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.renderedOnce=!1,this.lastStateFocused=!1,this.focusStateChanged=!0,this.render()},onMouseOver:function(){this.loading&&this.displayConnectingText(null,!0)},onClickFocus:function(){this.offline&&this.displayConnectingText(null,!0),this.clickedOnce=!0},visibleChanged:function(e){var t=m.models.customization.getComputedSetting("focusVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},collectionRequest:function(){this.loading=!0,this.clickedOnce||this.connectingTextOverride},promptFocused:function(){this.loadedOnce||this.displayConnectingText()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$message.html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$message.addClass("loading"),this.$message.is(":visible")||this.$message.fadeIn(500)},displayLoadingMessage:function(e){e?this.displayConnectingText('<i class="loading-icon"></i>'+this.loadingMessage,!0):this.displayConnectingText('<i class="loading-icon"></i> Loading...',!0)},todoLoadingStateChanged:function(e){e||this.render()},collectionError:function(e,t,i){return 200===t.status?void this.successfulConnection():void this.failedConnection()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.displayConnectingText('<i class="loading-icon"></i>Loading...',!0),this.retrying=!0;var t=this;m.views.focusPrompt?m.syncCoordinator.pingApi(function(){t.successfulConnection(),m.views.focusPrompt&&m.views.focusPrompt.focusInput()},function(){t.failedConnection(!0)}):this.collection.fetch({reset:!0})},successfulConnection:function(){this.loading=!1,this.offline=!1,this.retrying=!1,this.loadedOnce=!0,this.dismissConnectionMessage()},failedConnection:function(e){this.loading=!1,this.offline=!0,this.render(),this.displayConnectingText('Trouble connecting… <span class="retry">Retry</span>',e||this.clickedOnce)},dismissConnectionMessage:function(){this.$message&&this.$message.is(":visible")&&this.$message.fadeOut(500)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){this.isCollectionReady=!0,this.isParentReady&&this.render(),this.successfulConnection()},setNewFocus:function(){this.render(!0),m.views.focusPrompt&&m.views.focusPrompt.focusInput(),this.dismissConnectionMessage()},autoFocusChanged:function(){this.render()},showAssignedTodosOnlyChanged:function(){this.render()},setFocusState:function(e){this.lastStateFocused==e?this.focusStateChanged=!1:this.focusStateChanged=!0,this.lastStateFocused=e},render:function(e){var t=!1;m.views.focusPrompt&&(t=m.views.focusPrompt.controlFocusedOnce);var i=this;if(!this.renderedOnce){var n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$message=this.$(".message")}this.renderedOnce=!0;var o=null;if(e||(o=this.collection.activeFocus()),o){this.setFocusState(!0);var s=!1,a=null,l=!0;m.views.todayFocus?m.views.todayFocus.model.id!=o.id?m.views.todayFocus.model.id.startsWith("todo-")?m.views.todayFocus.model.get("todoId")!=o.get("todoId")&&(s=!0,a=m.views.todayFocus):(s=!0,a=m.views.todayFocus):m.views.todayFocus.model.collection||(s=!0,a=m.views.todayFocus,l=!1):s=!0,s&&(i.$el.find(".prompt").fadeTo(0,0).remove(),m.views.focusPrompt=null,m.views.todayFocus=new m.views.Focus({model:o}),i.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(l?500:0,1))),a&&a.removeView()}else this.setFocusState(!1),m.views.todayFocus&&i.$el.find("li").fadeTo(0,0).remove(),m.views.focusPrompt||(m.views.focusPrompt=new m.views.FocusPrompt({collection:this.collection}),this.$el.prepend(m.views.focusPrompt.render().$el.fadeIn(this.focusStateChanged?500:0))),t&&m.views.focusPrompt.focusInput();return this},addToday:function(e){m.sendEvent("Focus","Save"),m.views.todayFocus=new m.views.Focus({model:e}),this.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(500,1))},successfullyCreatedNewFocus:function(){m.views.focuses.successfulConnection(),this.render()},changeDay:function(){m.collect.focuses.fetch({reset:!0})},todayArchived:function(){this.render()}}),m.bootstrappers.InitializeFocus=function(e,t){},m.bootstrappers.RenderFocus=function(e,t,i){e.conditionalFeatures.checkFeatureAndMigrateData("serverfocus","focusVisible","momentum-focus",function(){e.collect.focuses=new e.collect.Focuses,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.conditionalFeatures.featureEnabled("pinfocus")&&e.models.customization.get("autoFocus")||e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)},function(){e.collect.focuses=new e.collect.FocusesLegacy,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)})},m.models.legacy=m.models.legacy||{},m.collect.legacy=m.collect.legacy||{},m.views.legacy=m.views.legacy||{},m.models.legacy.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0!==t&&1==t},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t}}),m.models.legacy.Todo=m.models.legacy.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null}},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},comparator:"order"}),m.models.legacy.TodoProxy=m.models.legacy.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.collect.legacy.TodosBase=Backbone.Collection.extend({model:m.models.legacy.Todo,saveOptions:{},initialize:function(){this.loadingFromServer=!0,localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.loadingFromServer=!0,this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){return this.where({done:!0,archive:!1,deleted:!1})},completedCount:function(){var e=this.completeToday();return e.length},activeToday:function(){return this.where({archive:!1,deleted:!1})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){return this.where({archive:!1,deleted:!1,done:!1})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return void 0==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.legacy.Todos=m.collect.legacy.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){}).fail(function(e,t){})},onLoadingFromServerChanged:function(){this.saveCachedCompletedCount()},onCollectionChanged:function(e){this.saveCachedCompletedCount()},completedCount:function(){if(this.loadingFromServer)return this.cachedCompletedCount();var e=this.completeToday();return e.length},saveCachedCompletedCount:function(){if(!this.loadingFromServer){var e=this.completeToday(),t=e.length,i=getActiveDateString();localStorage.cachedCompletedCount=JSON.stringify({count:t,forDate:i}),t!=this.previousCount&&(this.previousCount=t,this.trigger("completedCountChanged"))}},cachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return e.count}return 0},hasValidCachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return!0}return!1},parse:function(e){return e.items?e.items:e}}),m.collect.legacy.TodosLegacy=m.collect.legacy.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},clearCompleted:function(){var e=!1,t=this.completeToday();_.each(t,function(t){var i=t.get("completedDate");if(i){var n=Date.parse(i),o=activeDateStringForDate(n);o!=getActiveDateString()&&(t.archive(),e=!0)}}),e&&this.trigger("reset")},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),n=e.move_offset>0?1:-1,o=this.indexOf(i),s=1;if(o+n>=0&&o+n<this.length){var a=this.at(o+n);s=Math.abs(a.get("order")-i.get("order")),s<=20&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*n;t.save({order:l},{silent:!0})}}),m.views.legacy.Todos=Backbone.View.extend({attributes:{id:"todo","class":"widget-bottom-right todo"},template:m.templates.todos["legacy-todo"],offline:!0,initialFetchStarted:!1,renderedOnce:!1,loadedOnce:!1,events:{"click .todo-list-active":"openList","click .todo-list-chooser-dropdown":"chooseList","click .todo-toggle":"toggleShow","click .show-completed":"showCompleted","click .retry":"onClickRetry","click #clear-completed":"clearCompleted","keyup #todo-new":"handleInput",dragover:"dragover",dragend:"dragend"},initialize:function(){this.subViews=[],this.proxyCollection=new Backbone.Collection({model:m.models.legacy.TodoProxy}),this.show_completed=!1,_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.render(),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:window:resize",this.setMaxWidgetHeight),this.listenTo(this,"connectionOnline",this.connectionOnline),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.proxyCollection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"change",this.collectionModelChanged),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchtodos")?this.doFetchIfNeeded():this.collection.hasValidCachedCompletedCount()||this.doFetchIfNeeded(),1==JSON.parse(localStorage.showTodoList)&&(this.showPopup(),this.doFetchIfNeeded()),setTimeout(function(){try{if(m.conditionalFeatures.featureEnabled("plus")&&!localStorage.plus_first_load&&(localStorage.plus_first_load=!0,m.views.legacy.todos))try{m.views.legacy.todos.$el.hide(),m.views.legacy.todos.undelegateEvents(),m.views.legacy.todos.$el.removeData().unbind(),m.views.legacy.todos.remove(),Backbone.View.prototype.remove.call(m.views.legacy.todos),m.bootstrappers.RenderTodos(m,$)}catch(e){}}catch(e){}},500)},render:function(){if(!this.renderedOnce){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.updateTodoCount(),this.renderedOnce=!0,this.setMaxWidgetHeight(),this.visibleChanged()}return this},visibleChanged:function(){var e=m.models.customization.getComputedSetting("todoVisible");e?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},setMaxWidgetHeight:function(){var e=$(window).height()-125;$(".pane").css("max-height",e);var t=$(".todo-pane");if(t){var i=t.find(".todo-header").outerHeight(),n=t.find(".todo-message").outerHeight(!0),o=t.find(".todo-new").outerHeight();0==i&&(i=34),null==n&&(n=0),0==o&&(o=39),t.find(".todo-list").css("max-height",e-(i+n+o))}return e},connectionOnline:function(){this.retryConnection()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){if(!this.initialFetchStarted&&(this.doFetch(),m.conditionalFeatures.featureEnabled("localtodonotify"))){var e=this;window.addEventListener("storage",function(t){if(t.key&&0===t.key.indexOf("todos-updated")){if(e.fetching)return;e.fetching=!0,e.collection.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0})}},!1)}},initializeGreetings:function(e){if(localStorage.greetings){var t=JSON.parse(atob(localStorage.greetings)),e=t.todo;e&&(e.none&&(this.emptyTodoGreetings=e.none),e.completed&&(this.completedTodoGreetings=e.completed))}this.emptyTodoGreetings||(this.emptyTodoGreetings=[{caption:"Nothing to do",message:"Add a todo to get started, "}]),this.completedTodoGreetings||(this.completedTodoGreetings=[{caption:"All done",message:"Great work, "},{caption:"All done",message:"Good job, "},{caption:"All done",message:"You are awesome, "},{caption:"All done",message:"Good one, "},{caption:"All done",message:"Good on ya, "},{caption:"All done",message:"Congratulations, "},{caption:"All done",message:"You did it, "}])},randomEmptyTodoGreetings:function(){if(this.initializeGreetings(),!this.emptyTodoGreeting){var e=Math.floor(Math.random()*this.emptyTodoGreetings.length);this.emptyTodoGreeting=this.emptyTodoGreetings.splice(e,1)[0]}return this.emptyTodoGreeting},randomCompletedTodoGreetings:function(){if(this.initializeGreetings(),!this.completedTodoGreeting){var e=Math.floor(Math.random()*this.completedTodoGreetings.length);this.completedTodoGreeting=this.completedTodoGreetings.splice(e,1)[0]}return this.completedTodoGreeting},addOne:function(e){var t=new m.views.legacy.Todo({model:e,parent:this});this.subViews.push(t),this.$(".todo-list").append(t.render().el),this.$el.find("#todo-new")[0].scrollIntoView(!1)},addAll:function(){_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.$(".todo-list").html(""),_.each(this.collection.activeToday(),this.addOne),_.each(this.proxyCollection.where({proxyValid:!0}),this.addOne),this.successfulConnection(),this.setMaxWidgetHeight()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$el.find(".todo-count").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$el.find(".todo-count").fadeIn(500)},collectionReset:function(){this.loadedOnce=!0,this.render(),this.addAll()},collectionRequest:function(e){this.loadedOnce||this.displayConnectingText('<i class="loading-icon"></i>Loading...')},collectionError:function(e,t,i){return 200===t.status?void this.successfulConnection():void this.failedConnection()},successfulConnection:function(){var e=this.offline;this.offline=!1,this.dismissConnectionError(),this.checkEmptyPaneState(),e&&this.trigger("connectionOnline")},failedConnection:function(e){this.offline=!0,this.displayConnectingText(e?e:'Trouble connecting… <span class="retry">Retry</span>'),this.checkEmptyPaneState()},handleInput:function(e){13==e.keyCode&&this.createOnEnter(),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())},onClickRetry:function(e){e.preventDefault(),e.stopPropagation(),this.retryConnection()},retryConnection:function(){var e=this;this.loadedOnce?(_.each(this.proxyCollection.where({proxyValid:!0,saveFailed:!0,isLoading:!1}),function(t){e.createNewModel(t,!0)}),_.each(this.collection.where({saveFailed:!0,isLoading:!1}),function(t){e.saveToModel(t)})):this.collection.fetch({reset:!0})},createNewModel:function(e,t){var i=this;t?i.displayConnectingText('<i class="loading-icon"></i>Retrying...'):i.displayConnectingText('<i class="loading-icon"></i>Saving...'),e.set({saveFailed:!1,isLoading:!0}),i.collection.create({title:e.get("title")},{wait:!0,success:function(){i.successfulConnection(),e.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(t,n,o){i.failedConnection('Error saving… <span class="retry">Retry</span>'),e.set({saveFailed:!0,isLoading:!1})}})},saveToModel:function(e,t){var i=this;i.displayConnectingText('<i class="loading-icon"></i>Saving...');var n=e.saveOptions();n.wait=!0,n.success=function(){var t={};jQuery.extend(t,e.attemptedSaveValues),e.attemptedSaveValues=null,jQuery.extend(t,{saveFailed:!1,isLoading:!1}),setTimeout(function(){e.set(t),i.successfulConnection()},50)},n.error=function(t,n,o){if(200==n.status){var s={};jQuery.extend(s,e.attemptedSaveValues),e.attemptedSaveValues=null,jQuery.extend(s,{saveFailed:!1,isLoading:!1}),setTimeout(function(){e.set(s),i.successfulConnection()},50)}else e.set({saveFailed:!0,isLoading:!1}),i.failedConnection('Error saving… <span class="retry">Retry</span>')},t?(e.attemptedSaveValues?jQuery.extend(e.attemptedSaveValues,t):e.attemptedSaveValues=t,e.save(t,n)):e.attemptedSaveValues&&(t=e.attemptedSaveValues,e.save(e.attemptedSaveValues,n)),jQuery.extend(t,{saveFailed:!1,isLoading:!0}),e.set(t)},createOnEnter:function(e){var t=this.$el.find("#todo-new")[0].value.trim();if(t){var i=this,n=new m.models.legacy.TodoProxy({title:t});this.proxyCollection.add(n),i.$el.find("#todo-new")[0].value="",this.createNewModel(n)}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"todo"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},li_index:function(e){return this.$("li").index(e)},toggleShow:function(e){e&&e.preventDefault(),this.doFetchIfNeeded(),this.setMaxWidgetHeight(),this.$el.hasClass("show")?this.hidePopup(e):this.showPopup(),localStorage.showTodoList=!JSON.parse(localStorage.showTodoList)},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto"),this.$el.find("#todo-new").focus()},hidePopup:function(){if(this.$el.hasClass("show")){var e=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(t){e.$el.removeClass("show").find(".pane").css("height","auto")})}},showCompleted:function(e){e.preventDefault(),e.stopPropagation(),this.show_completed=!0,this.addAll()},hide:function(e){var t=!1;$(".todo-item-title").each(function(e,i){"true"==$(this).attr("contentEditable")&&(t=!0)}),!t&&this.$el.hasClass("show")&&this.toggleShow()},openList:function(e){this.$el.find(".todo-list-chooser-dropdown").show()},chooseList:function(e){this.$el.find(".todo-list-chooser-dropdown").hide()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},collectionModelChanged:function(e){this.checkEmptyPaneState()},checkEmptyPaneState:function(){if(this.offline||this.show_completed)this.$el.find(".todo-pane").removeClass("is-empty"),this.$el.find(".todo-pane").css("min-height","");else if(0===this.collection.remaining().length)if(this.$el.find(".todo-pane").addClass("is-empty"),this.$el.find(".todo-pane").css("min-height",200),0===this.collection.completeToday().length){var e=this.randomEmptyTodoGreetings();this.$(".title").html(e.caption),m.models.customization.get("displayname")&&this.$(".description").html(e.message+m.models.customization.get("displayname"))}else{var t=this.randomCompletedTodoGreetings();this.$(".title").html(t.caption),m.models.customization.get("displayname")&&this.$(".description").html(t.message+m.models.customization.get("displayname")+"!")}else this.$el.find(".todo-pane").removeClass("is-empty"),this.$el.find(".todo-pane").css("min-height","");this.updateTodoCount()},updateTodoCount:function(){if(!this.offline){var e=this.collection.remaining().length;switch(e){case 0:;break;case 1:;break;default:}this.$(".todo-count").html(e+" to do"),this.$(".todo-count").removeClass("pulsetext")}}}),m.views.legacy.Todo=Backbone.View.extend({tagName:"li",className:"todo-item",template:m.templates.todos["legacy-todo-item"],events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","click .destroy":"clear","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",dragleave:"dragleave"},editing:!1,initialize:function(e){_.bindAll(this,"dragstart","dragenter","dragleave"),this.parent=e.parent,this.listenTo(this.model,"change",this.render),this.listenTo(m,"globalEvent:esc",this.abortEdit)},render:function(){var e="",t=m.utils.captionFormatter(this.model.getValue("title"));if(done=this.model.getValue("done"),done)var e="checked";var i={title:t,checked:e};return this.$el.html(this.template(i)),this.$el.find(".todo-item-checkbox").prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",done),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.$el.prop("draggable","true"),this.$title=this.$el.find(".todo-item-title").first(),this.$title.text(t),this},destroy:function(){this.remove(),this.unbind()},clear:function(){m.sendEvent("Todo","Delete"),this.$el.hide(),m.views.legacy.todos.saveToModel(this.model,{deleted:!0,deletedDate:new Date})},abortEdit:function(){this.editing&&(this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.$title.attr("contentEditable",!1),this.editing=!1)},saveEdit:function(){if(this.editing){this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.editing=!1;var e=this.$title.text();this.$title.attr("contentEditable",!1),e?m.views.legacy.todos.saveToModel(this.model,{title:e}):this.clear()}},retrySave:function(){this.model.isTrue("isProxy")?m.views.legacy.todos.createNewModel(this.model,!0):this.model.attemptedSaveValues&&m.views.legacy.todos.saveToModel(this.model)},edit:function(e){this.editing||(this.originalText=this.$title.text(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$el.removeClass("viewing"),this.$title.attr("contentEditable",!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),m.sendEvent("Todo","Activate Edit")))},dragstart:function(e){return!this.editing&&(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="todo",this.parent.dragging=this,void m.sendEvent("Todo","Reorder"))},dragenter:function(e){if("todo"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},dragleave:function(e){},toggleDone:function(){m.sendEvent("Todo","Done");var e=!this.model.get("done");m.views.legacy.todos.saveToModel(this.model,{done:e,completedDate:e?new Date:null})},handleInput:function(e){this.editing&&(13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit"),e.preventDefault(),e.stopPropagation()),27==e.keyCode&&(e.stopPropagation(),this.abortEdit()))}}),m.views.legacy.TodosComplete=Backbone.View.extend({attributes:{id:"todo-complete","class":"metric"},template:m.templates.todos["legacy-todo-complete"],initialize:function(){this.listenTo(this.collection,"completedCountChanged",this.render),this.render()},render:function(){var e=this.collection.completedCount(),t="todos";1==e&&(t="todo");var i={done:e,item:t},n=(this.options.order||"append")+"To";return this.$el[n]("#"+this.options.region).html(this.template(i)).fadeTo(500,1),e?this.$el.show():this.$el.hide(),this}}),m.bootstrappers.RenderTodos=function(e,t){var i=e.conditionalFeatures.featureEnabled("enhancedtodo");i?e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.views.todoPane=new e.views.TodoPane({region:"bottom-right",order:"append"}),e.widgets.push(e.views.todoPane)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)}):e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.collect.legacy.todos=new e.collect.legacy.Todos,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)})},m.models.Weather=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-weather"),defaults:{location:"",woeid:"",fetchUnit:"c"}}),m.views.Weather=Backbone.View.extend({attributes:{id:"weather","class":"metric weather"},template:m.templates.weather.weather,events:{"dblclick .metric-stat":"toggleUnit","dblclick .location":"editLocation","keypress .location":"onKeypress","keydown .location":"onKeydown","blur .location":"saveLocation","webkitAnimationEnd .location":"onAnimationEnd"},initialize:function(){this.renderedOnce=!1;var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0),this.listenTo(this.model,"change",this.render),this.listenTo(m.models.customization,"change:temperatureUnit",this.render),this.updateWeather(),this.render(this.options.unitClass="hide"),this.listenTo(m.models.customization,"change:weatherVisible",this.visibleChanged),this.weatherTimer=setInterval(function(){this.updateWeather()}.bind(this),6e5)},render:function(){var e=this.calculateDisplayTemperature(),t=this.model.get("location");t&&0!=t.length||(t="location<br>unknown");var i={temperature:e,location:t,unit:this.displayUnit(),condition:this.model.get("condition"),code:this.getConditionFromCode(this.model.get("code")),unitClass:this.options.unitClass,message:this.model.get("error")},n=this.getManualWeatherLocation();i.message&&n&&(i.location=n.enteredLocation);var o=(this.options.order||"append")+"To";return this.$el[o]("#"+this.options.region).html(this.template(i)).fadeTo(500,1),this.$location=this.$(".location"),this.renderedOnce=!0,this},visibleChanged:function(e){var t=m.models.customization.get("weatherVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},calculateDisplayTemperature:function(){var e=this.model.get("fetchTemperature");if(e){var t=this.model.get("fetchUnit");return"c"===this.displayUnit()?"c"===t?e:Math.round(5*(e-32)/9):"c"===t?Math.round(9*e/5+32):e}return null},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e?e:"c"},editLocation:function(){this.$el.hasClass("editing")||(this.$location.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$location.get(0)))},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$location.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveLocation())},onKeydown:function(e){27===e.keyCode&&(this.$location.html(this.model.get("location")),this.doneEditingLocation())},saveLocation:function(){var e=this.$location.html();if(e&&e.length>0){var t={enteredLocation:e,woeid:null,location_name:null};localStorage.setItem("manual-weather-location",JSON.stringify(t))}else localStorage.removeItem("manual-weather-location");this.doneEditingLocation(),this.updateWeather(),m.sendEvent("Weather","Set Manual Location")},doneEditingLocation:function(){this.$location.attr("contenteditable",!1).removeClass("editing").addClass("pulse");
},toggleUnit:function(){this.options.unitClass="","c"===this.displayUnit()?m.models.customization.save("temperatureUnit","f"):m.models.customization.save("temperatureUnit","c")},setUnit:function(e){var t=["US","BM","BZ","JM","PW"];t.indexOf(e)>=0?this.model.save("fetchUnit","f"):this.model.save("fetchUnit","c")},updateWeather:function(){m.commandManager.execute("weather.update",this.model)},getManualWeatherLocation:function(){var e=localStorage.getItem("manual-weather-location");return e?JSON.parse(e):null},getConditionFromCode:function(e){var t={};return t[0]="F",t[1]="F",t[2]="F",t[3]="O",t[4]="P",t[5]="X",t[6]="X",t[7]="X",t[8]="X",t[9]="Q",t[10]="X",t[11]="R",t[12]="R",t[13]="U",t[14]="U",t[15]="U",t[16]="W",t[17]="X",t[18]="X",t[19]="J",t[20]="M",t[21]="J",t[22]="M",t[23]="F",t[24]="F",t[25]="G",t[26]="Y",t[27]="I",t[28]="H",t[29]="E",t[30]="H",t[31]="C",t[32]="B",t[33]="C",t[34]="B",t[35]="X",t[36]="B",t[37]="O",t[38]="O",t[39]="O",t[40]="R",t[41]="W",t[42]="U",t[43]="W",t[44]="H",t[45]="O",t[46]="W",t[47]="O",t[3200]=")",t[e]}}),m.bootstrappers.RenderWeather=function(e,t){e.conditionalFeatures.checkPreferenceForRender("weatherVisible",function(){e.models.weather=new e.models.Weather({id:1}),e.models.weather.fetch(),e.views.weather=new e.views.Weather({model:e.models.weather,region:"top-right",order:"append"}),e.widgets.push(e.views.weather)},function(t){e.listenToOnce(e.models.customization,"change:weatherVisible",t)})},m.models.Message=Backbone.Model.extend({defaults:function(){return{title:null,message:"",priority:5,views:0,viewLimit:3,deleted:!1,createdDate:Date.now(),visible:!1,loginOnClick:!1,fromServer:!1}},showMessage:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},showMessageNow:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},dismissMessage:function(){m.commandManager.execute("notification.dismiss")},save:function(e,t){if(t||(t={}),e||(e=_.clone(this.attributes)),e.hasOwnProperty("dismissed")&&e.dismissed&&(e.deleted=!0),!t.download_save&&this.get("fromServer"))try{var i=null;for(prop in e)e.hasOwnProperty(prop)&&"changed_props"!=prop&&"sync_success"!=prop&&(i||(i=this.get("changed_props")||[]),_.contains(i,prop)||i.push(prop));i&&(e.changed_props=i,e.sync_success=!1,t.silent=!1)}catch(n){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.collect.Messages=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-messages"),model:m.models.Message,cleaned:!1,initialize:function(){this.listenTo(this,"reset",this.cleanupMessagesIfRequired)},cleanupMessagesIfRequired:function(){if(!this.cleaned){this.cleaned=!0;var e=[];this.each(function(t){if(t.get("deleted"))t.get("fromServer")&&t.get("sync_success")&&!t.get("changed_props")&&e.push(t);else{var i=t.get("filter");i&&m.conditionalFeatures.featureEnabled(i)?t.save({deleted:!0,filtered:!0}):5==t.get("priority")?t.get("fromServer")?t.save({deleted:!0}):e.push(t):t.get("visible")||t.save({deleted:!0})}}),e.length>0&&_.each(e,function(e){e.destroy()})}}}),m.models.NotificationSync=Backbone.Model.extend({baseUrl:m.globals.urlRootApi+"notifications",initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"change:changed_props",this.onChange),this.listenTo(this.collection,"reset",this.onReset)},findHavingAttribute:function(e,t){return e.filter(function(e){return e.has(t)})},hasAttribute:function(e,t){return!!e.find(function(e){return e.has(t)})},onReset:function(){this.syncToServer()},onChange:function(e,t){if(!t.ignoreSave){var i=e.changedAttributes();i&&i.hasOwnProperty("changed_props")&&i.changed_props&&this.syncToServer()}},syncToServer:function(e){var t=this,i=this.findHavingAttribute(this.collection,"changed_props");return i&&0!=i.length?void nimble.each(i,function(e,i){if(e.get("fromServer")){var n=e.get("changed_props");if(!n||0==n.length)return void i();var o={};if(_.each(n,function(t){"changed_props"!=t&&"sync_success"!=t&&(o[t]=e.get(t))}),1==Object.keys(o).length&&o.hasOwnProperty("views"))return void i();var s=t.baseUrl+"/"+encodeURIComponent(e.id);$.ajax({url:s,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(t){t&&t.success&&e.save({changed_props:null,sync_success:!0},{silent:!0})}).fail(function(t,i){e.save({sync_success:!1},{silent:!0})}).always(function(){i()})}},function(){e&&e()}):void(e&&e())}}),m.models.NotificationManager=Backbone.Model.extend({backgroundLoaded:!1,_notificationView:null,_parent:null,settingsVisible:!1,initialize:function(){this.displayed=[],this.collection=new m.collect.Messages,m.models.message=new m.models.Message,this.listenTo(this.collection,"add reset",this.displayPendingMessages),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"settings:hidden",this.settingsHidden),this.listenTo(m,"settings:visible",this.onSettingsVisible),this.listenTo(m,"notifications:timestamp",this.onAvailableTimestamp),m.conditionalFeatures.featureEnabled("notifySyncOff")||(this.notifySync=new m.models.NotificationSync({collection:this.collection})),this.collection.fetch({reset:!0})},onBackgroundLoaded:function(){this.backgroundLoaded||(this.backgroundLoaded=!0,this.displayPendingMessages(),m.commandManager.execute("clean.localstorage"))},displayPendingMessages:function(){var e=this;if(this.collection.cleanupMessagesIfRequired(),this._parent&&this.backgroundLoaded&&!this.settingsVisible){var t=this.notificationView();if(t&&!t.notifying){var i=_.chain(this.collection.where({deleted:!1,visible:!0})).reject(function(t){var i=t.get("filter");return!(!i||!m.conditionalFeatures.featureEnabled(i))||_.contains(e.displayed,t)}).sortBy("priority").sortBy("createdDate").value();if(i&&0!=i.length){var n=i[0];this.displayed.push(n),t.showMessage(n)}}}},setParent:function(e){e&&(this._parent=e,this.displayPendingMessages())},onAvailableTimestamp:function(e){if(e){var t=localStorage.getItem("ts_notifications");(!t||e>t)&&this.downloadNotifications()}},downloadNotifications:function(){var e=this,t=localStorage.getItem("ts_notifications"),i=m.globals.urlRootApi+"notifications";t&&(t=parseInt(t,10),Number.isInteger(t)&&(i=i+"?ts="+t));try{$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(t){t&&t.timestamp&&(t.notifications&&t.notifications.length>0&&(e.collection.reset(t.notifications),e.collection.invoke("save",null,{download_save:!0})),localStorage.setItem("ts_notifications",t.timestamp))}).fail(function(e,t){})}catch(n){}},showMessage:function(e,t,i,n){var o={title:e,message:t,visible:!0};void 0!=i&&(o.viewLimit=i),void 0!=n&&(o.loginOnClick=n),this.collection.create(o)},showMessageEnhanced:function(e,t,i){e.hasOwnProperty("visible")||(e.visible=!0);var n={};t&&(n.success=t),i&&(n.silent=!0),this.collection.create(e,n)},dismissMessage:function(){this._notificationView&&this.notificationView().hideNotification()},settingsHidden:function(){this.settingsVisible=!1,this.displayPendingMessages()},onSettingsVisible:function(){this.settingsVisible=!0},notificationView:function(){return this._notificationView||(this._notificationView=new m.views.Notification({_parent:this._parent})),this._notificationView}}),m.views.Notification=Backbone.View.extend({attributes:{"class":"notification-container"},template:m.templates.notification.notification,notifying:!1,timeoutId:null,events:{"click .hide":"hideNotificationClicked","click .notification-button":"ctaButtonClicked","click .secondary-text":"secondaryTextClicked"},initialize:function(e){this._parent=e._parent,this.renderedOnce=!1,this.listenTo(m,"settings:visible",this.settingsVisible)},showMessage:function(e){this.model&&this.model.cid==e.cid||(this.model=e,this.render())},render:function(){var e=this;this.notifying=!0,this.incrementViews(),this.renderedOnce?this.$el.fadeTo(0,0).html(this.template(this.model.toJSON())).fadeTo(500,1):(e.$el.html(e.template(e.model.toJSON())).fadeTo(500,1),this._parent.$el.append(e.$el),this.$message=this.$(".notification-description"),this.renderedOnce=!0),this.model.has("message_html")&&this.$message.html(this.model.get("message_html"));var t=this.model.get("display_time");!t||null==t||void 0===t||t<=0||(this.timeoutId=setTimeout(function(){e.hideNotification()},t))},incrementViews:function(){var e=this.model.get("views")+1;e>=this.model.get("viewLimit")?this.model.save({visible:!1,views:e}):this.model.save({views:e},{silent:!0})},settingsVisible:function(){this.hideNotification(!0,!0)},hideNotificationClicked:function(e){e.stopPropagation(),this.hideNotification(),this.model.save({dismissed:!0,visible:!1},{silent:!0})},hideNotification:function(e,t){var i=this;if(clearTimeout(this.timeoutId),this.notifying){var n=t?0:500;this.notifying=!1,this.$el.fadeTo(n,0,function(){i.$el.hide(),e||setTimeout(function(){m.models.notificationManager.displayPendingMessages()},500)})}},ctaButtonClicked:function(e){e.stopPropagation(),this.hideNotification(!0,!0),this.notifying=!1;var t=this.model.get("cta_cmd"),i=this.model.get("cta_options");t&&t.length>0&&(this.model.save({ctaClicked:Date.now(),visible:!1},{silent:!0}),m.commandManager.execute(t,null,i))},secondaryTextClicked:function(e){e.stopPropagation(),this.model.get("secondary_hide")&&(this.hideNotification(!0,!0),this.notifying=!1);var t=this.model.get("secondary_cmd"),i=this.model.get("secondary_options");t&&t.length>0&&(this.model.save({secondaryClicked:Date.now()},{silent:!0}),m.commandManager.execute(t,null,i))}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.models.QuickLinks=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",local:!1,order:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({order:e},this.saveOptions())},comparator:"order"}),m.collect.QuickLinksBase=Backbone.Collection.extend({model:m.models.QuickLinks,initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},saveOptions:{},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",reorderItem:function(e){}}),m.collect.QuickLinks=m.collect.QuickLinksBase.extend({url:m.globals.urlRoot+"links",saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"links"}).done(function(e){}).fail(function(e,t){})}}),m.collect.QuickLinksLegacy=m.collect.QuickLinksBase.extend({localStorage:new Backbone.LocalStorage("momentum-quicklinks"),isLegacy:!0,fetch:function(e){var t=Backbone.Collection.prototype.fetch.call(this,e);return 0!==this.length||localStorage.gmailLinkAdded||(this.create({title:"Gmail",url:"http://mail.google.com/"}),localStorage.gmailLinkAdded=!0),t},createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),n=e.move_offset>0?1:-1,o=this.indexOf(i),s=1;if(o+n>=0&&o+n<this.length){var a=this.at(o+n);s=Math.abs(a.get("order")-i.get("order")),s<=20&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*n;t.save({order:l},{silent:!0})}}),m.views.QuickLinks=Backbone.View.extend({attributes:{id:"quicklinks","class":"quicklinks top-widget"},template:m.templates.quicklinks["quicklinks-template"],offline:!0,initialFetchStarted:!1,events:{"click .quicklinks-show":"toggleShow","keypress #quicklinks-new-url":"createLink","keypress #quicklinks-new-title":"createLink","click .add":"showAdd","click .hide":"hideUsageHint","click .local":"handleLocal","click .retry":"retryConnection","click .quicklinks-new":"inputsClicked",dragover:"dragover",dragend:"dragend"},initialize:function(){this.subViews=[],_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.renderedOnce=!1,this.render(),this.listenTo(m,"globalEvent:click globalEvent:esc",this.hidePopup),this.listenTo(m,"globalEvent:toggleQuickLinks",this.toggleShow),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:linksVisible",this.visibleChanged),(this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchlinks"))&&this.doFetchIfNeeded()},render:function(){var e=(this.options.order||"append")+"To";return this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.$el[e]("#"+this.options.region).html(this.template()).fadeTo(500,1),this.$connectionmessage=this.$el.find(".connection-message"),this.$connectionmessage.show(),this.renderedOnce=!0,this},destroy:function(){this.remove(),this.unbind()},visibleChanged:function(e){var t=m.models.customization.get("linksVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){this.initialFetchStarted||this.doFetch()},hideUsageHint:function(e){e.preventDefault(),e.stopPropagation(),m.models.customization.save({linksHintHidden:!0}),this.checkUsageHint()},collectionError:function(e,t,i){return 200===t.status?void this.successfulConnection():void this.failedConnection()},showAdd:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find("#quicklinks-new-title").val(""),this.$el.find("#quicklinks-new-url").val(""),this.$el.find(".add").addClass("active"),this.$el.find(".quicklinks-new").toggle().find("#quicklinks-new-title").focus()},inputsClicked:function(e){e.stopPropagation()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.collection.fetch({reset:!0})},collectionReset:function(){this.addAll()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},addOne:function(e){var t=new m.views.QuickLink({model:e,parent:this});this.subViews.push(t),this.$(".quicklinks-pane ol").append(t.render().$el)},addAll:function(){this.offline=!1,_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.collection.each(this.addOne),this.successfulConnection()},successfulConnection:function(){this.$connectionmessage.hide(),this.dismissConnectionError(),this.checkUsageHint()},failedConnection:function(){this.$el.find(".connection-message").html('Trouble connecting… <span class="message-action">Retry</span>'),this.$el.find(".connection-message").show(),this.checkUsageHint()},createLink:function(e){if(13==e.keyCode){var t=this.$el.find("#quicklinks-new-title")[0].value,i=this.$el.find("#quicklinks-new-url")[0].value;if(!t){var n=this;return this.$el.find("#quicklinks-new-title").addClass("pulse"),void _.delay(function(){n.$el.find("#quicklinks-new-title").removeClass("pulse")},1e3)}if(!i){var n=this;return this.$el.find("#quicklinks-new-url").addClass("pulse"),void _.delay(function(){n.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)}if(this.offline)return void this.revealConnectionError();var o=!1;/^chrome|chrome-extension|chrome-search:\/\//i.test(i)&&(o=!0),i=ensureUrlScheme(i),m.sendEvent("Quick Links","Add");var n=this,s=0;if(this.collection.length>0){var a=this.collection.max(function(e){return e.get("order")});s=a.get("order")+100}this.collection.create({title:t,url:i,local:o,order:s},{wait:!0,success:function(){n.successfulConnection(),n.$el.find(".add").removeClass("active"),n.$el.find(".quicklinks-new").css("display","none")},error:function(e,t,i){n.failedConnection(),n.revealConnectionError()}})}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"quicklink"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.$el.hasClass("show")?this.hidePopup():this.showPopup(),m.trigger("globalEvent:click",this),this.doFetchIfNeeded(),this.setMaxWidgetHeight()},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},hidePopup:function(e){if(e!=this&&this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}},li_index:function(e){return this.$("li").index(e)},urlInvalid:function(){var e=this;this.$el.find("#quicklinks-new-url").addClass("pulse"),_.delay(function(){e.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)},handleLocal:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Quick Links","Local Link"),chrome.tabs.update({url:e.currentTarget.href})},setMaxWidgetHeight:function(){var e=$(window).height()-125;this.$el.find(".quicklinks-pane").css("max-height",e)},checkUsageHint:function(){var e=m.models.customization.get("linksHintHidden");this.offline||e?this.$el.find(".link-hint").hide():this.$el.find(".link-hint").show()}}),m.views.QuickLink=Backbone.View.extend({tagName:"li",template:m.templates.quicklinks["quicklinks-item-template"],events:{"keypress .todo-input":"updateOnEnter","click .destroy":"delete",dragstart:"dragstart",dragenter:"dragenter",click:"handleClick","click .local":"handleLocal"},initialize:function(e){_.bindAll(this,"dragstart","dragenter"),this.parent=e.parent,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove)},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),i=this.model.get("url"),n=this.model.get("local"),o=new Image;return o.src="https://icons.duckduckgo.com/ip2/encrypted."+detachUrlScheme(i)+".ico",o.onload=function(){var s={title:t,url:i,local:n};48!==o.width?s.favicon_url="https://icons.duckduckgo.com/ip2/encrypted."+detachUrlScheme(i)+".ico":s.favicon_url="https://icons.duckduckgo.com/ip2/"+detachUrlScheme(i)+".ico",e.$el.html(e.template(s)),e.$el.prop("draggable","true")},e},"delete":function(){m.sendEvent("Quick Links","Delete"),this.model.destroy()},dragstart:function(e){e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="quicklink",this.parent.dragging=this},dragenter:function(e){if("quicklink"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},handleClick:function(e){e.stopPropagation()},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.bootstrappers.RenderQuickLinks=function(e,t){e.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","linksVisible","momentum-quicklinks",function(){e.collect.quicklinks=new e.collect.QuickLinks,e.views.quicklinks=new e.views.QuickLinks({collection:e.collect.quicklinks,region:"top-left",order:"prepend"}),e.widgets.push(e.views.quicklinks)},function(){e.collect.quicklinks=new e.collect.QuickLinksLegacy,e.views.quicklinks=new e.views.QuickLinks({collection:e.collect.quicklinks,region:"top-left",order:"prepend"}),e.widgets.push(e.views.quicklinks)},function(t){e.listenToOnce(e.models.customization,"change:linksVisible",t)})},m.models.PersistentSettings=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaults:{linksVisible:!0,focusVisible:!0,todoVisible:!0,weatherVisible:!0,quoteVisible:!0,searchVisible:!1,requestSync:!1,keepTodoState:!0,countdownVisible:!1,notesVisible:!1,percentClock:!1,themeColour:"dark",autoFocus:!1,balanceModeStr:""},initialize:function(){var e=this;e.fetching=!1,window.addEventListener("storage",function(t){t.key&&0===t.key.indexOf("momentum-customization-1")&&(e.fetching=!0,e.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0}))})}}),m.models.Settings=Backbone.Model.extend({defaults:{},initialize:function(){}}),m.models.GenericSettings=Backbone.Model.extend({initialize:function(e){this.url=m.globals.urlRoot+e},save:function(e,t){t=t||{},t.patch=!0,Backbone.Model.prototype.save.call(this,e,t)},toggle:function(e){var t={};this.has(e)?t[e]=!this.get(e):t[e]=!0,this.save(t)}}),m.models.BalanceMode=Backbone.Model.extend({defaults:{enabled:!1,active:!1,balanceClock:!1,balanceTodo:!1,balanceFocus:!0,balanceNotes:!1,customTime:!1,customDays:!1,start:{hour:9,minute:"00",noon:"AM"},end:{hour:5,minute:"00",noon:"PM"},startCustom:{hour:9,minute:"00",noon:"AM"},endCustom:{hour:5,minute:"00",noon:"PM"},days:[!1,!0,!0,!0,!0,!0,!1],daysCustom:[!1,!0,!0,!0,!0,!0,!1]},initialize:function(e,t){var i=this;this.customization=t.customization||m.models.customization,this.listenTo(this.customization,"change:balanceModeStr",this.customizationChanged),this.listenTo(this,"change:enabled",this.balanceChanged),setInterval(function(){i.checkBalance()},1e3)},checkBalance:function(){var e=new Date,t=this.getStart(),i=this.getEnd(),n=this.getDays(),o=t.hour+":"+t.minute+t.noon,s=i.hour+":"+i.minute+i.noon,a=this.get("active");this.set("active",this.get("enabled")&&(!n[e.getDay()]||m.utils.toTodaysTime(o).getTime()>e.getTime()||e.getTime()>m.utils.toTodaysTime(s).getTime())),a!=this.get("active")&&this.balanceChanged()},customizationChanged:function(e,t){var i=this.customization.get("balanceModeStr");i&&i!=this.balanceModeStr&&i.length>0&&this.resetBalanceMode()},resetBalanceMode:function(){if(this.balanceModeStr=this.customization.get("balanceModeStr"),this.balanceModeStr&&this.balanceModeStr.length>0){var e=JSON.parse(this.balanceModeStr);this.set("enabled","undefined"==typeof e.enabled?this.defaults.enabled:e.enabled),this.set("start",e.start||this.defaults.start),this.set("end",e.end||this.defaults.end),this.set("days",e.days||this.defaults.days),this.set("customDays","undefined"==typeof e.customDays?this.defaults.customDays:e.customDays),this.set("customTime","undefined"==typeof e.customTime?this.defaults.customTime:e.customTime),this.set("startCustom",e.startCustom||this.defaults.startCustom),this.set("endCustom",e.endCustom||this.defaults.endCustom),this.set("daysCustom",e.daysCustom||this.defaults.daysCustom),this.set("balanceClock","undefined"==typeof e.balanceClock?this.defaults.balanceClock:e.balanceClock),this.set("balanceFocus","undefined"==typeof e.balanceFocus?this.defaults.balanceFocus:e.balanceFocus),this.set("balanceTodo","undefined"==typeof e.balanceTodo?this.defaults.balanceTodo:e.balanceTodo),this.set("balanceNotes","undefined"==typeof e.balanceNotes?this.defaults.balanceNotes:e.balanceNotes),this.initCompleted=!0,this.checkBalance()}},getDays:function(){return this.get("customDays")?this.get("daysCustom"):this.get("days")},getStart:function(){return this.get("customTime")?this.get("startCustom"):this.get("start")},getEnd:function(){return this.get("customTime")?this.get("endCustom"):this.get("end")},get:function(e){return!!("customDays"!=e&&"customTime"!=e||m.conditionalFeatures.featureEnabled("plus"))&&Backbone.Model.prototype.get.call(this,e)},balanceChanged:function(){this.initCompleted&&this.customization.save({balanceModeStr:JSON.stringify(this.attributes)})}}),m.models.ComputedSettings=Backbone.Model.extend({defaults:{todoVisible:!1,focusVisible:!1,clockVisible:!1,notesVisible:!1},initializeSettings:function(e){var t=this;this.persistentSettings=new m.models.PersistentSettings({id:1}),this.listenTo(this.persistentSettings,"change",this.computeProperties),this.listenTo(this.persistentSettings,"sync",function(){var e=t.persistentSettings.get("balanceModeStr");e&&e.length>0&&(m.models.balanceMode.resetBalanceMode(),t.computeProperties()),t.initialized||(t.initialized=!0,t.trigger("initialized"))}),m.conditionalFeatures=new m.models.ConditionalFeatures({customization:this}),m.models.balanceMode=this.balanceMode=new m.models.BalanceMode({id:1},{customization:this}),this.persistentSettings.fetch({error:function(e,t,i){"Record Not Found"==t&&e.save()}})},checkBalanceMode:function(e,t,i){var n=this.attributes[e],o=!!i||(!this.persistentSettings.has(e)||this.persistentSettings.get(e));this.attributes[e]=o&&!(m.models.balanceMode.get("active")&&m.models.balanceMode.get(t)),n!=this.attributes[e]&&this.trigger("change:"+e)},computeProperties:function(e,t,i){var n=this;this.checkBalanceMode("todoVisible","balanceTodo"),this.checkBalanceMode("clockVisible","balanceClock",!0),this.checkBalanceMode("focusVisible","balanceFocus"),this.checkBalanceMode("notesVisible","balanceNotes"),_.keys(this.persistentSettings.changedAttributes()).forEach(function(o){n.trigger("change:"+o,e,t,i)}),this.trigger("change",e,t,i)},get:function(e){return!("autoFocus"==e&&!m.conditionalFeatures.featureEnabled("plus"))&&this.persistentSettings.get(e)},getPersistentSettings:function(){return this.persistentSettings},getComputedSetting:function(e){return void 0!=this.attributes[e]?Backbone.Model.prototype.get.call(this,e):this.persistentSettings.get(e)},set:function(){arguments[0].id?Backbone.Model.prototype.set.apply(this,arguments):this.persistentSettings.set.apply(this.persistentSettings,arguments)},save:function(){this.persistentSettings.save.apply(this.persistentSettings,arguments)},fetch:function(){this.persistentSettings.fetch.apply(this.persistentSettings,arguments)},toggle:function(e){if(e){var t=!this.get(e),i={};i[e]=t,this.save(i)}}}),m.collect.Settings=Backbone.Collection.extend({model:m.models.Settings,saveOptions:{patch:!0},initialize:function(){}}),m.collect.TodoSettings=m.collect.Settings.extend({model:m.models.Settings,allowReorder:!1,saveOptions:{patch:!0},url:m.globals.urlRoot+"settings/todo/providers/1/lists",comparator:"order",initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},nextOrder:function(){return this.length?this.last().get("order")+100:100},parse:function(e){return e.lists?(this.allowReorder=e.allow_reorder,e.lists):e},reorderItem:function(e){console.log(e);var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRoot+"settings/todo/providers/1/lists"}).done(function(e){m.trigger("globalEvent:resetLists")}).fail(function(e,t){console.log("failed"),m.trigger("globalEvent:resetLists")})}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){var e={};return this.$el.html(this.template(e)),this},close:function(){this.remove(),this.unbind(),this.panelClosing()},panelClosing:function(){}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{id:"settings-main","class":"pane-container settings-container"},template:m.templates.settings.main,events:{"click .hide":"hideSettings",wheel:"onWheel"},detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){return this.visible?(this.paneRendered||(this.$el.html(this.template()),this.$container=this.$(".subpanel-container"),this.paneRendered=!0),this.cssLoaded?(this.renderedOnce||(this.navMenu=new m.views.settings.NavMenu({el:this.$("#nav-menu")}),this.listenTo(this.navMenu,"navItemClicked",this.navItemClicked),this.renderedOnce=!0,this.visible||this.$el.hide()),this.renderActivePanel(),this):this):this},onWheel:function(e){if(0!=e.originalEvent.deltaY){if(this.patchWheelEvents)return this.$popBody[0].scrollTop=this.$popBody.scrollTop()+e.originalEvent.deltaY,void e.preventDefault();if(!this.testingWheelEvents){var t=this,i=this.$popBody.scrollTop();this.testingWheelEvents=!0,setTimeout(function(){var n=t.$popBody.scrollTop();i==n?(t.patchWheelEvents=!0,t.$popBody[0].scrollTop=t.$popBody.scrollTop()+e.originalEvent.deltaY):$(t.el).off("wheel"),t.testingWheelEvents=!1},20)}}},renderActivePanel:function(e){this.activePanel&&this.cssLoaded&&this.renderedOnce&&(this.activePanel.render(e).$el.detach().appendTo(this.$container),this.$popBody=this.$container.find(".pop-body"))},navItemClicked:function(e){if(this.upsellView&&this.upsellView.hideUpsell(),e!=this.activePanelId){var t=this.getNavItem(e);t&&t.cmd&&t.cmdonly?(this.setActiveNavItem(e),m.commandManager.ensureCommandLoaded(t.cmd,function(){t.hide&&m.commandManager.execute("settings.hide"),m.commandManager.execute(t.cmd,t.options)},function(){},function(e){})):this.activateSection(e,{source:"nav-"+e})}},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},showUpsell:function(e){e.template=m.templates.settings.upsell,this.upsellView=new m.views.upsell.message(e),this.$el.find(".upsell-parent").prepend(this.upsellView.render().$el),this.upsellView.show()},showSettings:function(e){var t=this;if(!this.cssLoaded&&!this.cssLoading){this.cssLoading=!0;var i=$('<link type="text/css" href="css/settings.css" rel="stylesheet" />');i.load(function(){t.cssLoaded=!0,t.render()}),$("head").append(i)}this.visible=!0,m.trigger("globalEvent:toggle:bottom-left",this),this.paneRendered&&this.renderedOnce||this.render(),m.trigger("settings:visible"),e&&e.section?this.activateSection(e.section,e):this.activateSection(this.activePanelId&&"loading"!=this.activePanelId?this.activePanelId:"general"),this.$el.show()},hideSettings:function(e){if(this.$el.is(":visible")){e&&e.preventDefault(),this.visible=!1,m.trigger("settings:hidden"),this.$el.find(".settings").removeClass("fade-in");setTimeout(function(){},200),this.activePanel&&this.activePanel.close()}},getNavItem:function(e){var t=m.settingsManager.getNavItems(),i=_.findWhere(t.navItems,{id:e});return i||(i=_.findWhere(t.secondaryNavItems,{id:e})),i},getPanel:function(e){var t=m.settingsManager.getPanelItems();return _.findWhere(t,{id:e})},showLoadingPanel:function(e){this.loadingPanel||(this.loadingPanel=new m.views.settings.panels.Loading),"loading"!=this.activePanelId&&this.setActivePanel(this.loadingPanel,"loading",null),this.loadingPanel.setDisplayOptions(e),this.renderActivePanel()},setActivePanel:function(e,t,i){e&&(this.activePanel&&this.activePanel.close(),this.activePanel=e,this.activePanelId=t,this.activePanelOptions=i)},setActiveNavItem:function(e){$(".main-nav-item").removeClass("active");var t=this.getNavItem(e);t||(t=this.getPanel(e)),t&&t.section?$('li[data-navitem="'+t.section+'"]').addClass("active"):$('li[data-navitem="'+e+'"]').addClass("active");
},activateSection:function(e,t){var i=this;if(e){t&&t.nav?this.setActiveNavItem(t.nav):this.setActiveNavItem(e);var n=this.getNavItem(e);n||(n=this.getPanel(e));var o=null,s=!1,a=!1,l=!1;if(n&&n.cmd)m.commandManager.ensureCommandLoaded(n.cmd,function(){s=!0,o=m.commandManager.execute(n.cmd,t),i.setActivePanel(o,e,t),i.renderActivePanel(t)},function(){a||s||(a=!0,setTimeout(function(){l||s||i.showLoadingPanel()},400))},function(n){a=!0,l=!0,i.showLoadingPanel({error:"We were unable to load settings.",retryInfo:{id:e,options:t}})});else{if(o=_.findWhere(this.subViews,{panelid:e}),!o){var r=e.charAt(0).toUpperCase()+e.slice(1),d=m.views.settings.panels[r];d&&(o=new d(t))}this.setActivePanel(o,e,t),this.renderActivePanel()}}}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPicker=Backbone.View.extend({template:m.templates.settings["color-picker"],active:!1,attributes:{"class":"color-picker"},events:{"click .swatch":"handleClick"},initialize:function(e,t,i){this.listenTo(m,"globalEvent:settingsclick",this.settingsClick),this.settingName=e,this.optionValue=t,this.options=i,this.options.ignoreClick&&delete this.events["click .swatch"]},render:function(){this.$el.html(this.template()),this.delegateEvents(),this.$swatch=this.$el.find(".swatch").first();var e=m.models.themeManager.getThemeColourRGBA(this.settingName);return this.$swatch.css({backgroundColor:e}),this.picker&&(this.$picker=this.picker.render().$el,this.$el.append(this.$picker)),this},scrollIntoViewElement:function(){return!!(this.$picker&&this.$picker.is(":visible")&&this.active)&&this.$picker.find(".cp-color-picker").first()[0]},settingsClick:function(e){var t=$(e.target).closest(".cp-color-picker");if(!(t.length>0)){var i=$(e.currentTarget).data("option-value");i&&i==this.optionValue||this.dismiss()}},setActive:function(){this.active=!0},setInactive:function(){this.active=!1},dismiss:function(){this.$picker&&(this.$picker.hide(),this.$el.closest(".toggle-option").removeClass("color-picker-active"),this.$picker.is(":visible")&&m.models.themeManager.saveThemeColour())},ignoreClickEvent:function(e){return"swatch"!=e.className&&"color-picker"!=e.className},handleClick:function(e,t){if(this.active||t){e.stopPropagation();var i=this;if(this.picker)this.$picker&&(this.$picker.toggle(),this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$picker.is(":visible")?(this.picker.setSizes(),this.picker.preRender(!0)):m.models.themeManager.saveThemeColour());else{var n={light:"#fff",dark:"#fff",renderCallback:function(e){if(e){var t=e.colors,n=m.models.themeManager.toRgbA(t);i.$swatch.css({backgroundColor:n,color:t.RGBLuminance>.22?"#222":"#ddd"}),m.models.themeManager.setColorValues(this.settingName,t)}}},o=m.models.themeManager.getThemeColourRGBA(this.settingName);o&&(n.color=o),this.picker=new m.views.settings.ColorPickerPopup(n),this.$picker=this.picker.render().$el,this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$el.append(this.$picker),this.picker.setSizes(),this.picker.preRender(!0)}}},close:function(){m.models.themeManager.saveThemeColour(),this.dismiss()}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"preferences","class":"preferences"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){var e=this;if(!this.renderedOnce){var t='<span class="toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>',i=(this.options.order||"append")+"To";this.$el[i]("#"+this.options.region).html(t),this.renderedOnce=!0,m.views.settings.mainSettings=new m.views.settings.MainSettings,setTimeout(function(){e.$el.append(m.views.settings.mainSettings.$el)},100),this.$el.toggleClass("infinispin",m.settingsManager.infinispin())}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},settingsHidden:function(e){if(e&&e.preventDefault(),this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this,t=this.options.email,i=this.options.size,n=!1,o=this.$el.on("error",function(){n||(n=!0,e.$el.attr({src:"/img/gravatar_unknown.jpg"}))}).attr({src:"https://www.gravatar.com/avatar/"+md5(t)+"?s="+i+"&d=mm"});return this.$el.html(o),this}}),m.views.settings.panels.About=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-about","class":"subpanel-container"},template:m.templates.settings.about,panelid:"about",events:{"dblclick #momo-version":"revealUuid","dblclick .about-logo":"logoDblClicked"},render:function(){var e={version:m.globals.version};return this.$el.html(this.template(e)),this},revealUuid:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find(".made").html(localStorage.client_uuid)},logoDblClicked:function(e){e.stopPropagation(),$(".preferences").first().toggleClass("infinispin",m.settingsManager.toggleInfinispin())}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPickerPopup=Backbone.View.extend({template:m.templates.settings["color-picker-popup"],events:{"mousedown .cp-xy-slider,.cp-z-slider,.cp-alpha":"mouseDown"},initialize:function(e){this._color=this.color=new Colors(e),this._options=this._color.options,this._GPU=!1,this._css="",this._pointermove="touchmove.tcp mousemove.tcp pointermove.tcp",this._pointerup="touchend.tcp mouseup.tcp pointerup.tcp"},render:function(){return this.$el.html(this.template()),this.delegateEvents(),this._$z_slider=this.$el.find(".cp-z-slider").first(),this._$xy_slider=this.$el.find(".cp-xy-slider").first(),this._$xy_cursor=this.$el.find(".cp-xy-cursor").first(),this._$z_cursor=this.$el.find(".cp-z-cursor").first(),this._$alpha=this.$el.find(".cp-alpha").first(),this._$alpha_cursor=this.$el.find(".cp-alpha-cursor").first(),this.setSizes(),this.preRender(),this.renderedOnce=!0,this},setSizes:function(){this._$alpha._width=this._$alpha.width(),this._$xy_slider._width=this._$xy_slider.width(),this._$xy_slider._height=this._$xy_slider.height(),this._$z_slider._height=this._$z_slider.height()},resolveEventType:function(e){return e=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches[0]:e,e.originalEvent?e.originalEvent:e},findElement:function(e){return $(e.find(this._options.doRender)[0]||e[0])},mouseDown:function(e){var t=this;e.stopPropagation(),this._$trigger=$(e.currentTarget),this.setSizes();var i=e.currentTarget.className,n=i.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");(e.button||e.which)>1||(e.preventDefault&&e.preventDefault(),e.returnValue=!1,this._$trigger._offset=this._$trigger.offset(),n="xy_slider"===n?this.xy_slider:"z_slider"===n?this.z_slider:this.alpha,n.call(this,e),this.preRender(),this.$el.on(this._pointerup,function(e){t.$el.off(".tcp")}).on("mouseleave.tcp",function(e){n.call(t,e),t.preRender(),t.$el.off(".tcp")}).on(this._pointermove,function(e){n.call(t,e),t.preRender()}))},xy_slider:function(e){var t=this.resolveEventType(e),i=t.pageX-this._$trigger._offset.left,n=t.pageY-this._$trigger._offset.top;this._color.setColor({s:i/this._$xy_slider._width*100,v:100-n/this._$xy_slider._height*100},"hsv")},z_slider:function(e){var t=this.resolveEventType(e).pageY-this._$trigger._offset.top;this._color.setColor({h:360-t/this._$z_slider._height*360},"hsv")},alpha:function(e){var t=this.resolveEventType(e).pageX-this._$trigger._offset.left,i=t/this._$alpha._width;this._color.setColor({},"rgb",i)},preRender:function(e){colors=this._color.colors,hueRGB=colors.hueRGB,RGB=colors.RND.rgb,HSL=colors.RND.hsl,dark=this._options.dark,light=this._options.light,colorText=this._color.toString(this._color._colorMode,this._options.forceAlpha),HUEContrast=colors.HUELuminance>.22?dark:light,alphaContrast=colors.rgbaMixBlack.luminance>.22?dark:light,h=(1-colors.hsv.h)*this._$z_slider._height,s=colors.hsv.s*this._$xy_slider._width,v=(1-colors.hsv.v)*this._$xy_slider._height,a=colors.alpha*this._$alpha._width,translate3d=this._GPU?"translate3d":"",this._$trigger?(triggerValue=this._$trigger[0].value,hasNoValue=this._$trigger[0].hasAttribute("value")&&""===triggerValue&&void 0!==e):(triggerValue=null,hasNoValue=!0),this._$xy_slider._css={backgroundColor:"rgb("+hueRGB.r+","+hueRGB.g+","+hueRGB.b+")"},this._$xy_cursor._css={transform:translate3d+"("+s+"px, "+v+"px, 0)",left:this._GPU?"":s,top:this._GPU?"":v,borderColor:colors.RGBLuminance>.22?dark:light},this._$z_cursor._css={transform:translate3d+"(0, "+h+"px, 0)",top:this._GPU?"":h,borderColor:"transparent "+HUEContrast},this._$alpha._css={background:"linear-gradient(to left,#"+colors.HEX+",rgba(0,0,0,0))"},this._$alpha_cursor._css={transform:translate3d+"("+a+"px, 0, 0)",left:this._GPU?"":a,borderColor:alphaContrast+" transparent"},this.renderInternal(e)},renderInternal:function(e){this._$xy_slider.css(this._$xy_slider._css),this._$xy_cursor.css(this._$xy_cursor._css),this._$z_cursor.css(this._$z_cursor._css),this._$alpha.css(this._$alpha._css),this._$alpha_cursor.css(this._$alpha_cursor._css),this._options.doRender&&this._$trigger.css(this._$trigger._css),this._options.renderCallback.call(null,this._color,this._$trigger,"boolean"==typeof e?e:void 0)}}),m.views.settings.panels.General=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-general","class":"subpanel-container"},template:m.templates.settings.general,panelid:"general",syncState:!1,events:{"click .slide-toggle":"toggleSlider","click .sync-option":"toggleSyncSlider","click .toggle-option":"toggleOption","click .login":"loginClicked","click .action-logout":"logoutClicked","click .profile":"profileClicked","click .plan":"planClicked"},initialize:function(){this.model=m.models.customization,this.initializeCustomizeItems(),this.listenTo(this.model,"change",this.customizationModelChanged)},initializeCustomizeItems:function(){var e=m.models.themeManager.getAvailableFonts();this.customizeItems=[{name:"Theme",field:"themeColour",widget:"themeColour",options:[{label:"Dark",value:"dark"},{label:"Light",value:"light"},{label:"Custom",value:"custom",view_cmd:"settings.color.picker",view_opt:{settingName:"themeColour",ignoreClick:!0},show_always:!0}],"default":"dark",plusOnly:!0,section:"customize"},{name:"Font",field:"themeFont",widget:"themeFont",options:e,"default":"default",plusOnly:!0,section:"customize"},{name:"Links",widget:"linksVisible",field:"linksVisible",section:"widgets"},{name:"Search",widget:"searchVisible",field:"searchVisible",section:"widgets"},{name:"Weather",widget:"weatherVisible",field:"weatherVisible",section:"widgets"},{name:"Focus",widget:"focusVisible",field:"focusVisible",section:"widgets"},{name:"Quote",widget:"quoteVisible",field:"quoteVisible",section:"widgets"},{name:"Todo",widget:"todoVisible",field:"todoVisible",section:"widgets"},{name:"Countdown",widget:"countdownVisible",field:"countdownVisible",plusOnly:!0,message:"Count down the days until an important date",section:"widgets",beta:!0},{name:"Notes",widget:"notesVisible",field:"notesVisible",plusOnly:!0,message:"Take quick notes and store wisdom to review",section:"widgets",beta:!0},{name:"Weather Units",field:"temperatureUnit",widget:"temp-unit",options:[{label:"°C",value:"c"},{label:"°F",value:"f"}],section:"misc"},{name:"Clock Format",field:"hour12clock",widget:"clock-format","boolean":!0,options:[{label:"12 hour",value:!0},{label:"24 hour",value:!1}],section:"misc"},{name:"Percent Clock",widget:"percentClock",field:"percentClock",message:"Visualize your progression through the work day (customize in Balance)",section:"misc"},{name:"Search Provider",field:"searchProvider",widget:"search-provider",options:[{label:"Google",value:"google"},{label:"Bing",value:"bing"}],section:"misc"}]},render:function(){var e=m.models.customization.get("displayname"),t=localStorage.email||null,i=!!localStorage.token;if(this.syncMessage||(m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")?(this.syncMessage="Your account data is available anywhere you log in",this.syncState=!0):(this.syncMessage="Access your Momentum account from any computer",this.syncState=!1)),this.$el.html(this.template({displayname:e,email:t,loggedIn:i,syncMessage:this.syncMessage})),t){var n=this.$el.find(".user-gravatar");if(n){var o=new m.views.Gravatar({email:t,size:50});n.html(o.render().$el)}}m.conditionalFeatures.featureEnabled("plus")&&this.$el.find(".user").addClass("has-plus"),this.$synclist=this.$el.find(".sync-option"),this.updateSyncToggleState();var s={customize:this.$el.find("#customize-list"),widgets:this.$el.find("#widgets-list"),misc:this.$el.find("#misc-list")};return _.each(s,function(e){e.empty()}),_.each(this.customizeItems,function(e){e.feature&&!m.conditionalFeatures.featureEnabled(e.feature)||(e.options?s[e.section].append(m.templates.settings["general-toggle-options"](e)):s[e.section].append(m.templates.settings["general-toggle-slider"](e)))}),this.updateControlStates(_.pluck(this.customizeItems,"field")),this},updateSyncToggleState:function(){this.$synclist&&this.$synclist.toggleClass("fixed on",this.syncState)},updateSyncMessage:function(e){if(this.$synclist){var t=this.$synclist.find(".option-message");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},updateSyncCaption:function(e){if(this.$synclist){var t=this.$synclist.find(".sync-caption");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},toggleSyncSlider:function(e){e.preventDefault(),e.stopPropagation();var t=this;this.syncState||(localStorage.token?m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){t.updateSyncCaption("Account Sync Activated"),t.updateSyncMessage("Refresh or load a new tab to use your synced account"),t.syncState=!0,t.updateSyncToggleState()},function(){t.syncState=!1,t.updateSyncToggleState(),t.updateSyncCaption("Account Sync Access Request Failed"),t.updateSyncMessage("Please check that you are online and try again"),t.syncState=!1,t.updateSyncToggleState()}):(t.updateSyncCaption("Login required for Account Sync"),t.updateSyncMessage("Click Login above to log in or create an account, and try again"),t.syncState=!1,t.updateSyncToggleState()))},customizationModelChanged:function(e){if(e){var t=e.changedAttributes(),i=_.keys(t);this.updateControlStates(i)}},updateControlStates:function(e){var t=this,i=m.conditionalFeatures.featureEnabled("plus");_.each(e,function(e){var n=_.findWhere(t.customizeItems,{field:e});if(n){var o=t.model.get(e);if(n.options){n.plusOnly&&!i&&(o=n["default"]),t.$el.find("."+n.widget).removeClass("active");var s=t.$el.find("."+n.widget+"[data-option-value='"+o+"']").first();s.addClass("active"),_.each(n.options,function(e){if(e.view_cmd){s=t.$el.find("."+n.widget+"[data-option-value='"+e.value+"']").first();var i=s.find(".sub-view").first();return!e.view&&e.show_always&&(e.view=m.commandManager.execute(e.view_cmd,e.value,e.view_opt)),0==i.children().length&&(i.html(e.view.render().$el),i.css("display","inline-block")),e.value!=o?(e.show_always||i.hide(),!e.view||!e.view.dismiss||e.view.dismiss(),void(!e.view||!e.view.setInactive||e.view.setInactive())):void(!e.view||!e.view.setActive||e.view.setActive())}})}else{var a=t.model.getComputedSetting(e);o=!(n.plusOnly&&!i)&&!!o;var l=t.$el.find("[data-related-widget='"+n.widget+"']");if(l&&1===l.length){var r=l.first();r.toggleClass("on",o),o!=a&&(n.plusOnly&&i||!n.plusOnly)&&!r.hasClass("balanced")&&(r.append('<span class="option-message balanced-message">• Currently hidden by Balance mode (see Balance for more)</span>'),r.addClass("balanced"))}}}})},setOption:function(e){var t=e.attr("data-related-widget"),i=e.attr("data-option-value"),n=_.findWhere(this.customizeItems,{widget:t});if(!n)return null;if(n.plusOnly&&!m.conditionalFeatures.featureEnabled("plus")){var o={targetRegion:"settings",sourceEvent:t,buttonText:"Learn more",title:"Custom Themes",description:"Select a font and color theme to make Momentum your own"};return void m.commandManager.execute("upsell.message",o)}this.$el.find("."+t).removeClass("active"),e.addClass("active");var s={};return n["boolean"]?s[n.field]=JSON.parse(i):s[n.field]=i,this.model.save(s),n},toggleOption:function(e){var t=$(e.currentTarget),i=$(e.currentTarget).attr("data-option-value"),n=this.setOption(t);if(n){var o=_.findWhere(n.options,{value:i});if(o&&o.view&&o.view.handleClick){var s=$(e.target).closest(".sub-view");if(s.length>0&&o.view.ignoreClickEvent&&o.view.ignoreClickEvent(e.target))return;if(o.view.handleClick(e,!0),o.view.scrollIntoViewElement){var a=o.view.scrollIntoViewElement();a&&this.scrollIntoView(a)}}}m.trigger("globalEvent:settingsclick",e)},scrollIntoView:function(e){var t=$(e),i=t.closest(".pop-body"),n=t.offset().top,o=i.offset().top;n-o<0&&i.animate({scrollTop:i[0].scrollTop+n-o-12})},toggleSlider:function(e){var t=$(".cp-color-picker");if(!($(e.target).attr("data-option-value")||t.length>0&&$.contains(t[0],e.target))){var i,n=$(e.currentTarget).attr("data-related-widget");if(n){var o,s=_.findWhere(this.customizeItems,{widget:n}),a=this.model.get(s.field);if(s.options){for(i=0;i<s.options.length;i++)if(s.options[i].value==a){i==s.options.length-1&&(i=-1),o=s.options[i+1].value;break}var l=$(e.currentTarget).find("."+s.widget+"[data-option-value='"+o+"']").first();this.setOption(l)}else{if(o=!this.model.get(n),this.model.toggle(n),s.plusOnly&&!m.conditionalFeatures.featureEnabled("plus")){if(s.plusOnly&&!m.conditionalFeatures.featureEnabled("plus")){var r;return"Countdown"==s.name?r={targetRegion:"settings",sourceEvent:n,buttonText:"Learn more",title:"Countdown",description:"Track your upcoming milestones"}:"Notes"==s.name&&(r={targetRegion:"settings",sourceEvent:n,buttonText:"Learn more",title:"Notes",description:"Take longer form notes"}),void m.commandManager.execute("upsell.message",r)}return void m.commandManager.execute("upsell.message",r)}var d={};d[n]=o,this.model.save(d)}}m.trigger("globalEvent:settingsclick",e)}},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Login","Clicked"),m.commandManager.execute("settings.hide"),m.commandManager.execute("account.login")},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),$(".action-logout").addClass("action-logout-disabled").text("Logging out..."),m.sendEvent("Settings","Logout","Clicked"),m.commandManager.execute("logout")},profileClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching..."),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/me?setCookie=true"}).done(function(e){e.userValid&&(window.location.href="https://account.momentumdash.com/profile")}).fail(function(e,t){}).always(function(){})},planClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching..."),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/me?setCookie=true"}).done(function(e){e.userValid&&(window.location.href="https://account.momentumdash.com")}).fail(function(e,t){}).always(function(){})},panelClosing:function(){_.each(this.customizeItems,function(e){_.each(e.options,function(e){e.view_cmd&&(!e.view||!e.view.close||e.view.close())})})}}),m.views.settings.panels.Help=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-help","class":"subpanel-container"},template:m.templates.settings.help,panelid:"help",initialize:function(){}}),m.views.settings.panels.Loading=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-loading"},template:m.templates.settings.loading,panelid:"loading",events:{"click .button-retry":"retryClicked"},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;var e={};this.$el.html(this.template(e)),this.$errorMessage=this.$(".settings-loading-error-message"),this.$retryButton=this.$(".button-retry"),this.$loading=this.$(".settings-loading-loading-message")}return this.renderDisplayState(),this},renderDisplayState:function(){if(this.displayOptions){var e=this.displayOptions;if(e.error)return this.$errorMessage.text(e.error),this.$errorMessage.show(),this.$retryButton.show(),void this.$loading.hide()}this.$loading.show(),this.$errorMessage.hide(),this.$retryButton.hide()},setDisplayOptions:function(e){e?this.displayOptions=e:this.displayOptions=null},retryClicked:function(e){if(e.stopPropagation(),this.displayOptions&&this.displayOptions.retryInfo){var t=this.displayOptions.retryInfo,i=t.options||{};i.section=t.id,m.commandManager.execute("settings.display",null,i)}}}),m.views.settings.NavMenu=Backbone.View.extend({template:m.templates.settings.navmenu,events:{"click .main-nav-item":"onClickNavItem"},initialize:function(){this.listenTo(m.settingsManager,"navItemsChanged",this.render),this.render()},render:function(){var e=m.settingsManager.getNavItems();return this.$el.html(this.template(e)),this},onClickNavItem:function(e){e.stopPropagation();var t=$(e.currentTarget).data("navitem");this.trigger("navItemClicked",t)}}),m.views.settings.panels.Upgrade=m.views.settings.SettingsPanel.extend({attributes:{id:"upgrade-panel","class":"subpanel-container pop-body settings-upgrade"},template:m.templates.settings.upgrade,panelid:"upgrade",events:{"click .button-upgrade":"getPlusClicked"},initialize:function(e){m.sendEvent("Upgrade to Plus","Show Upgrade Panel"),this.listenTo(m,"settings:upgradeCopyChanged",this.render),e&&(e.source?(this.source=e.source,m.commandManager.execute("settings.cache.upgradecopy",!0,e.source)):m.commandManager.execute("settings.cache.upgradecopy",!0),e.utm_source&&(this.utm_source=e.utm_source),e.utm_medium&&(this.utm_medium=e.utm_medium),e.utm_campaign&&(this.utm_campaign=e.utm_campaign))},render:function(){if(this.$el.html(this.template({})),localStorage.cachedUpgradeCopy){var e=JSON.parse(localStorage.cachedUpgradeCopy);if(e.html){var t=e.html.replace("{{campaignDetails}}",this.getCampaignDetails());this.$el.html(t)}}return this},getCampaignDetails:function(){var e={utm_source:"extension",utm_medium:"upgrade-panel",utm_campaign:this.source};return this.utm_campaign&&(e={utm_source:this.utm_source,utm_medium:this.utm_medium,utm_campaign:this.utm_campaign}),e},getPlusClicked:function(e){var t=this;e.preventDefault(),e.stopPropagation(),localStorage.token?(m.sendEvent("Upgrade to Plus","Click Get Momentum Plus"),$(e.currentTarget).html("Launching..."),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/me"}).done(function(e){if(e.userValid){var i="https://account.momentumdash.com/upgrade?"+$.param(t.getCampaignDetails());window.location.href=i}}).fail(function(e,t){}).always(function(){})):(m.sendEvent("Upgrade to Plus","Click Get Momentum Plus, but not logged in"),$(this.$el).find(".login-needed").css({opacity:0,display:"block"}).fadeTo(500,1))}}),m.views.settings.panels.Whatsnew=m.views.settings.SettingsPanel.extend({attributes:{id:"whats-new-panel","class":"subpanel-container"},template:m.templates.settings.whatsnew,panelid:"whatsnew",events:{"click .action-back":"clickBack"},initialize:function(){m.sendEvent("Whats New","Show Whats New Panel")},render:function(){return this.$el.html(this.template({})),this.$whatsnew=$(this.$el.find(".whatsnew-body")[0]),this.$whatsnew.html('<span class="loading"><i class="loading-icon"></i>Loading...</span>'),this.fetchLatestWhatsNew(),this},fetchLatestWhatsNew:function(){var e=this;$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings/whatsnew"}).done(function(t){t.html&&e.$whatsnew.html(t.html)}).fail(function(t,i){e.$el.html(e.template({}))})}}),m.views.Introduction=Backbone.View.extend({attributes:{id:"introduction"},template:m.templates.introduction["introduction-template"],initialize:function(){this.activeView=null,localStorage.removeItem("doLoginOnNextLoad"),this.render()},render:function(){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(1e3,1),m.models.customization.get("displayname")?this.promptForEmail():this.promptForName()},promptForName:function(){m.sendEvent("Introduction","Name","Show"),m.views.namePrompt=new m.views.NamePrompt,this.activeView=m.views.namePrompt,this.$el.find(".content").append(m.views.namePrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForEmail:function(){m.views.emailPrompt=new m.views.EmailPrompt,this.activeView=m.views.emailPrompt,this.$el.find(".content").append(m.views.emailPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordLogin:function(){m.sendEvent("Introduction","Password For Login","Show"),m.views.loginPasswordPrompt=new m.views.LoginPasswordPrompt,this.activeView=m.views.loginPasswordPrompt,this.$el.find(".content").append(m.views.loginPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordCreate:function(){m.sendEvent("Introduction","Password For Create","Show"),m.views.createPasswordPrompt=new m.views.CreatePasswordPrompt,this.activeView=m.views.createPasswordPrompt,this.$el.find(".content").append(m.views.createPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordReset:function(){m.sendEvent("Introduction","Password For Reset","Show"),m.views.resetPasswordPrompt=new m.views.ResetPasswordPrompt,this.activeView=m.views.resetPasswordPrompt,this.$el.find(".content").append(m.views.resetPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},doneIntroductionWithMessage:function(){localStorage.removeItem("doLoginOnNextLoad"),this.$el.fadeTo(1e3,0,function(){m.bootstrappers.InitializeFocus(m,$),m.appView.render(!0)})},showLoading:function(){this.$el.find(".tip").html('<div class="loading"><span class="loading-icon"></span>Loading...</div>').css("opacity","0").fadeTo(500,1)},hideLoading:function(){}}),m.views.NamePrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},render:function(){var e="Hello, what's your name?",t={message:e};return this.$el.html(this.template(t)),this},updateOnEnter:function(e){13==e.keyCode&&this.save()},save:function(){m.sendEvent("Introduction","Name","Submit");var e=this,t=this.$el.find("input")[0].value.trim();t.length<1||(m.models.customization.save({displayname:t}),this.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForEmail()}))}}),m.views.EmailPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="What's your email, "+m.models.customization.get("displayname")+"?",i={message:t},n=new m.views.IntroductionButton({value:"Stay logged out",clicked:function(){return e.stayOffline()}});return this.$el.html(this.template(i)),this.$el.find(".buttons").append("Or would you rather stay logged out?").append(n.render().$el),this.$el.find("input")[0].focus(),this},handleBack:function(e){m.sendEvent("Introduction","Email","Escape Pressed"),this.stayOffline()},updateOnEnter:function(e){13==e.keyCode&&this.checkEmail()},stayOffline:function(){m.sendEvent("Introduction","Email","Stay Offline Clicked"),localStorage.stayOffline=!0,m.views.introduction.doneIntroductionWithMessage()},checkEmail:function(){m.sendEvent("Introduction","Email","Submit");var e=this,t=this.$el.find("input")[0].value.trim();if(!(t.length<1)){var i=validateEmail(t);if(!i){var n=new m.views.IntroductionTip({value:"Sorry, "+t+" doesn't seem to be a valid email address. Please try again."});return void this.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,localStorage.email=t,m.views.introduction.showLoading(),$.ajax({type:"GET",url:m.globals.urlRootApi+"user-search?email="+encodeURIComponent(t)}).done(function(t){e.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForPaswordLogin()}),m.views.introduction.hideLoading(),e.loading=!1}).fail(function(t,i){return 404!==t.status?(e.loading=!1,void e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)):(e.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForPaswordCreate()}),e.loading=!1,m.views.introduction.hideLoading(),void 0)}))}}}),m.views.LoginPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="What's your password?",i={message:t},n=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}}),o=new m.views.IntroductionButton({value:"Change your password",clicked:function(){return e.resetPassword()}});return this.$el.html(this.template(i)),this.$el.find(".buttons").append(n.render().$el),this.$el.find(".buttons").append(o.render().$el),this.$el.find("input").attr("type","password").focus(),this},handleBack:function(e){m.sendEvent("Introduction","Password For Login","Escape Pressed"),this.changeEmail(e)},updateOnEnter:function(e){13==e.keyCode&&this.login()},changeEmail:function(e){m.sendEvent("Introduction","Password For Login","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},resetPassword:function(e){m.sendEvent("Introduction","Password For Login","Reset Password Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForPaswordReset()})},login:function(){m.sendEvent("Introduction","Password For Login","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var n=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,
m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:t,password:i}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/authenticate"}).done(function(t){e.loading=!1,t.token&&(m.commandManager.execute("notification.dismiss"),localStorage.token=t.token,t.token_uuid&&(localStorage.token_uuid=t.token_uuid),t.features&&m.conditionalFeatures.setFeatures(t.features),m.trigger("user:successfulLogin",function(){localStorage.setItem("loggedIn",Date.now()),m.views.introduction.doneIntroductionWithMessage()}),m.views.introduction.hideLoading())}).fail(function(t,i){if(400!==t.status&&401!==t.status)return e.loading=!1,void e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1);var n=new m.views.IntroductionTip({value:"The password you entered for the email "+localStorage.email+" isn't right."});e.$el.find(".tip").html(n.render().$el.fadeTo(500,1)),e.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.CreatePasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="Please choose a password.",i={message:t},n=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});return this.$el.html(this.template(i)),this.$el.find("input").attr("type","password").focus(),this.$el.find(".buttons").append(n.render().$el),this},updateOnEnter:function(e){13==e.keyCode&&this.create()},handleBack:function(e){m.sendEvent("Introduction","Password For Create","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Create","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},create:function(){m.sendEvent("Introduction","Password For Create","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var n=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:i,version:m.globals.version}),url:m.globals.urlRootLogin+"user/register"}).done(function(e){e.token?(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),e.features&&m.conditionalFeatures.setFeatures(e.features)):e.first_time_key&&(localStorage.first_time_key=e.first_time_key,localStorage.next_login_attempt=Date.now(),e.token_uuid&&(localStorage.token_uuid=e.token_uuid)),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){m.views.introduction.hideLoading(),e.loading=!1}))}}),m.views.ResetPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(e){var t=this,i="What would you like your new password to be?",n={message:i},o=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return t.changeEmail()}});return this.$el.html(this.template(n)),this.$el.find(".buttons").append("Changing password for "+localStorage.email).append(o.render().$el),this.$el.find("input").attr("type","password").focus(),this},handleBack:function(e){m.sendEvent("Introduction","Password For Reset","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Reset","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},updateOnEnter:function(e){13==e.keyCode&&this.reset()},reset:function(){m.sendEvent("Introduction","Password For Reset","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var n=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:i}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/forgot"}).done(function(e){m.commandManager.execute("notification.show","Password change started","Check your email to change your password. Your password change email may take a few moments to arrive."),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){e.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.IntroductionTip=Backbone.View.extend({template:m.templates.introduction["introduction-tip-template"],render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this}}),m.views.IntroductionButton=Backbone.View.extend({template:m.templates.introduction["introduction-button-template"],events:{click:"clicked"},render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this},clicked:function(e){this.options.clicked()}}),m.models.DropdownMenuItem=Backbone.Model.extend({}),m.collect.TopDropdownMenuItems=Backbone.Collection.extend({model:m.models.DropdownMenuItem,url:m.globals.urlRoot+"settings/todo/menu",fetchCompleted:!1,initialize:function(e,t){t&&t.listId&&(this.listId=t.listId)},parse:function(e){return e.menuoptions},fetchIfRequired:function(){return!this.fetchCompleted&&(this.fetchCompleted=!0,this.fetch({reset:!0,error:function(e,t,i){this.fetchCompleted=!1}}),!0)},queueFetch:function(){this.fetchCompleted=!1},fetch:function(e){var t={};return this.listId?(t.data={listId:this.listId},e=_.extend(e||{},t),Backbone.Collection.prototype.fetch.call(this,e)):null}}),m.models.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0!==t&&1==t},attemptSave:function(e,t){},retrySave:function(){this.get("isProxy")?this.collection.parentList&&this.collection.parentList.createNewModel&&this.collection.parentList.createNewModel(this):this.attemptedSaveValues&&this.attemptSave(this.model)},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t},isSibling:function(e){return e.get("parentId")==this.get("parentId")}}),m.models.Todo=m.models.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null,listId:"inbox"}},parse:function(e){return e&&e.done&&e.archive&&(e.listId="1-done"),e},archive:function(){this.setArchiveState(!0)},setArchiveState:function(e){var t={};t.archive=void 0===e?!this.get("archive"):e,t.archive?(t.archivedDate=new Date,this.get("done")||(t.done=!0,t.completedDate=new Date)):t.archivedDate=null,this.attemptSave(t)},toggleDoneState:function(){this.setDoneState()},setDoneState:function(e,t){var i=this.getDoneStateChanges(e,t);this.attemptSave(i),i.done&&m.sendEvent("Todo","Done"),m.trigger("todo:loadingStateChange",status)},getDoneStateChanges:function(e,t){var i={};if(i.done=void 0===e?!this.get("done"):e,i.done){var n=this.collection.parentList;if(n.has("done_disabled")){var o=n.get("done_disabled");return void(o.message&&m.trigger("todo:status",o))}i.completedDate=new Date,t&&(i.archive=!0,i.archivedDate=new Date)}else i.archive=!1,i.archivedDate=null,i.completedDate=null;return i},getTodayStateChanges:function(e){var t={};return t.today=e,e&&this.get("archive")&&(t.archive=!1,t.archivedDate=null),t},setTodayState:function(e){var t=this.getTodayStateChanges(e);this.attemptSave(t)},deleteItem:function(){this.attemptSave({deleted:!0,deletedDate:(new Date).toISOString()})},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},attemptSave:function(e,t){var i=this;i.displayConnectingText('<i class="loading-icon"></i>Saving...');var n=i.saveOptions();n.wait=!0,n.success=function(){var e={};jQuery.extend(e,i.attemptedSaveValues),i.attemptedSaveValues=null,jQuery.extend(e,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",i.id,e),setTimeout(function(){i.set(e),i.successfulConnection(),t&&t(!0)},50)},n.error=function(e,n,o){if(200==n.status){var s={};jQuery.extend(s,i.attemptedSaveValues),i.attemptedSaveValues=null,jQuery.extend(s,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",i.id,s),setTimeout(function(){i.set(s),i.successfulConnection(),t&&t(!0)},50)}else{var a={saveFailed:!0,isLoading:!1,deleted:!1,deletedDate:null};i.set(a),m.trigger("todo:loadingStateChange"),i.failedConnection('Error saving… <span class="retry">Retry</span>'),t&&t(!1)}},e?(i.attemptedSaveValues?jQuery.extend(i.attemptedSaveValues,e):i.attemptedSaveValues=e,i.save(e,n)):i.attemptedSaveValues?(e=i.attemptedSaveValues,i.save(i.attemptedSaveValues,n)):i.pendingReorderData&&(i.set({isLoading:!0}),$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(i.pendingReorderData),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){i.set({isLoading:!1,saveFailed:!1})}).fail(function(e,t){i.set({saveFailed:!0,isLoading:!1})})),jQuery.extend(e,{saveFailed:!1,isLoading:!0}),i.set(e),m.trigger("todo:changing",i.id,e)},comparator:"order",save:function(e,t){t||(t={}),e||(e=_.clone(this.attributes));try{if(this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data&&jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data}),this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data_cmd){var i=m.commandManager.execute(this.collection.parentList.collection.aux_data_cmd,this,this.collection.parentList.collection.aux_data);jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data,aux_data_result:i})}}catch(n){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.models.TodoProxy=m.models.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.models.TodoList=Backbone.Model.extend({itemFetchStarted:!1,showAssignedTodosOnly:!1,defaults:{selected:!1},initialize:function(){this.itemCollection=new m.collect.Todos(null,{parentList:this}),this.listenTo(this.itemCollection,"add remove change reset",this.triggerChangeEvent),this.listenTo(this.itemCollection,"remainingCountChanged",this.remainingCountChanged),this.proxyCollection=new m.collect.TodoProxy(null,{parentList:this}),this.listenTo(this.proxyCollection,"add change",this.triggerChangeEvent),this.get("assigned_support")&&(this.listenTo(m.models.customization,"change:assigned-"+this.id,this.showAssignedTodosOnlyChanged),this.refreshShowAssignedTodosOnly())},todoItemMenuOptions:function(){if(this.itemCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.itemCollection.menuOptions)),!this._todoItemMenuOptions){var e=[{captionText:"Edit",commandId:"todo.edit"},{css_class:"line"},{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}},{captionText:"Move Back",commandId:"todo.undone",options:{}},{captionText:"Move to...",commandId:"todo.moveTo"},{captionText:"Archive",commandId:"todo.archive"},{css_class:"line"},{captionText:"Delete",commandId:"todo.delete"}];this._todoItemMenuOptions=new Backbone.Collection(e)}return this._todoItemMenuOptions},showAssignedTodosOnlyChanged:function(){this.refreshShowAssignedTodosOnly(),this.itemCollection.checkRemainingItemCount(),m.trigger("todo:showAssignedTodosOnlyChanged",this.id)},refreshShowAssignedTodosOnly:function(){this.showAssignedOnly=m.models.customization.get("assigned-"+this.id)},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new m.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},refreshItems:function(){this.doItemFetchIfNeeded(!0)},doItemFetchIfNeeded:function(e){!e&&this.itemFetchStarted||(this.itemFetchStarted=!0,this.itemCollection.doFetchIfNeeded(e))},triggerChangeEvent:function(){this.trigger("change",this),m.trigger("todo:globalChange")},getDefaultCommands:function(){return 1!=this.collection.provider.id?[]:this.isDoneList()?[{commandId:"todo.undone",options:{}}]:[{commandId:"todo.toggle.today",options:{}}]},isDoneList:function(){var e=this.get("type");return"done"==e},isTodayList:function(){var e=this.get("type");return"today"==e},listType:function(){return this.get("type")},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},remainingTodoCount:function(){var e=this.get("count");return void 0!=e&&null!=e?e:""},showAssignedTodosOnly:function(){return this.get("assigned_support")&&this.showAssignedOnly},remainingCountChanged:function(e){var t=this.get("count");t!=e&&this.set("count",e)},changeCount:function(e){if("undefined"==typeof this.get("count")){var t=this;setTimeout(function(){t.refreshItems()},500)}else this.set("count",this.get("count")+(e?1:-1)),this.collection.cacheLists()},supportsReordering:function(){var e=this.get("reorder");return!!e},groupingInfo:function(){return this.isDoneList()?{type:"date",field:"completedDate"}:null},createNewModel:function(e,t,i){var n=i?{at:0}:null,o=null;e instanceof Backbone.Model?o=e:(e.listId=this.id,this.isDoneList()&&(e.done=!0),this.isTodayList()&&(e.today=!0),o=new m.models.TodoProxy(e),this.proxyCollection.add(o,n));var s=this;t?s.displayConnectingText('<i class="loading-icon"></i>Retrying...'):s.displayConnectingText('<i class="loading-icon"></i>Saving...'),o.set({saveFailed:!1,isLoading:!0});var a,l=this.collection.provider.getDefaultList(),r=l?l.get("id"):null,d=s.isDoneList()&&r?r:o.get("listId");n={wait:!0,success:function(e){s.successfulConnection(),o.set("proxyValid",!1),m.sendEvent("Todo","Add"),i&&(a.move_id=e.get("id"),s.itemCollection.reorderItem(a))},error:function(e,t,i){s.failedConnection('Error saving… <span class="retry">Retry</span>'),o.set({saveFailed:!0,isLoading:!1}),o.targetList=s}},i&&(n.at=0,a={move_target_id:s.itemCollection.models[0].get("id"),move_offset:"-1",list_id:d}),s.itemCollection.create({title:o.get("title"),listId:o.get("listId"),today:o.get("today"),done:o.get("done"),homeListId:d,completedDate:o.get("done")?new Date:null},n)}}),m.models.TodoProvider=Backbone.Model.extend({fetchStarted:!1,initialize:function(){this.prefetchTodos=this.get("prefetchTodos"),this.listCollection=new m.collect.ProviderTodoLists(null,{provider:this,prefetchTodos:this.prefetchTodos}),this.listenTo(this,"add",this.onAdd),this.listenTo(this,"change:count",this.countChanged),this.listenTo(this.listCollection,"reset selectionChanged",this.triggerChangeEvent)},refreshItems:function(){this.listCollection.fetch()},doFetchIfNeeded:function(e){!e&&this.fetchStarted||(this.fetchStarted=!0,this.listCollection.doFetchIfNeeded(e),this.refreshTodoItems())},refreshTodoItems:function(){var e=this.selectedList();e&&e.refreshItems()},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(e){return this.listCollection.getListOfType(e)},getListById:function(e){return this.listCollection.getListById(e)},triggerChangeEvent:function(){this.trigger("change",this)},selectedList:function(){return this.listCollection?this.listCollection.selectedItem():null},providerStatus:function(){if(this.listCollection.listStatus)return this.listCollection.listStatus;var e=this.selectedList();return e?e.itemCollection.listStatus:null},addNewList:function(e,t,i){var n=this,o=m.globals.urlRootApi+"todos/lists",s={providerId:this.id,title:e};$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(s),url:o}).done(function(e){e&&e.success&&n.listCollection.fetch({success:function(){n.selectList(e.id),t&&t()}})}).fail(function(e,t){i&&i()})},selectList:function(e){var t=this.listCollection;t.selectItem(e)},selectPreviousList:function(){if(this.listCollection){var e=this.listCollection.selectedItem();if(e){var t=this.listCollection.indexOf(e);if(t>0){var i=this.listCollection.at(t-1);i&&this.selectList(i.id)}}}},selectNextList:function(){if(this.listCollection){var e=this.listCollection.selectedItem();if(e){var t=this.listCollection.indexOf(e);if(t<this.listCollection.length-1){var i=this.listCollection.at(t+1);i&&this.selectList(i.id)}}}}}),m.collect.TodoProxy=Backbone.Collection.extend({model:m.models.TodoProxy,initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList)}}),m.collect.TodosBase=Backbone.Collection.extend({model:m.models.Todo,saveOptions:{},initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList),localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"sync",this.onSync),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onSync:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged"),m.trigger("todo:listSync")},onNewDay:function(){this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){var e=this;return this.filter(function(t){var i=t.get("completedDate");if(i){var n="";if(i instanceof Date)n=activeDateStringForDate(i);else{var o=i.split("T");if(o.length>1)var n=o[0]}var s=getActiveDateString();if(n!=s)return!1}if(1==t.get("done")&&0==t.get("archive")&&0==t.get("deleted")&&t.get("listId")==e.parentList.id)return!0})},completedCount:function(){var e=this.completeToday();return e.length},activeToday:function(){var e=this;return this.parentList.isDoneList()?this.where({deleted:!1,done:!0}):this.filter(function(t){if(0==t.get("archive")&&0==t.get("deleted")){var i=t.get("listId");if(i==e.parentList.id||!i)return!0;if("1-##default"==e.parentList.id)return!0}})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){var e=this.activeToday();if(this.parentList.isDoneList())return e;var t=_.filter(e,function(e){return!e.get("done")});return t},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return void 0==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.ProviderTodoLists=Backbone.Collection.extend({model:m.models.TodoList,url:m.globals.urlRoot+"todos/lists",loadedFromCache:!1,listStatus:null,initialize:function(e,t){if(this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(m,"globalEvent:resetLists",this.fetch),t&&t.prefetchTodos&&(this.externallyFetchedOnce=!0),t&&t.provider){this.provider=t.provider;var i=this.listCacheKey(),n=localStorage[i];if(n){var o=JSON.parse(n);o&&o.length>0&&(this.loadedFromCache=!0,this.reset(o))}}},comparator:"order",mergeLists:function(e){var t=e;e&&e.lists&&(t=e.lists);var i=this,n=this.selectedItem();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(n)){var o=this.models[0];this.selectItem(o.id)}},listCacheKey:function(){return this.provider?"listCache-"+this.provider.id:"listCache-default"},selectedListCacheKey:function(){return this.provider?"activeTodoListId-"+this.provider.id:null},cacheLists:function(){var e=JSON.stringify(this.models),t=this.listCacheKey();localStorage[t]=e},doFetchIfNeeded:function(e){this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(e){return e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.lists},handleCountChanged:function(){this.checkSelectedItem(),this.cacheLists()},collectionSync:function(){this.setStatus(null),this.checkSelectedItem(this.forceFetch),this.forceFetch=!1,this.cacheLists()},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},fetch:function(e){var t=this,i=e||{};if(this.provider){var n={};n.data={provider_id:this.provider.id},i=_.extend(i,n)}return i.error=function(e,i,n){return this.externallyFetchedOnce=!0,403==i.status&&i.responseJSON&&i.responseJSON.status&&"authRequired"==i.responseJSON.status?void t.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:i.responseJSON}):void t.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},i&&void 0!=i.reset?this.setStatus({status:"loading",message:"Loading..."}):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,i)},collectionChanged:function(){this.setStatus(null),this.checkSelectedItem(this.forceFetch),this.forceFetch=!1},selectedItem:function(){var e;if(this.selectedListId&&this.get(this.selectedListId))return this.get(this.selectedListId);if(e=this.findWhere({selected:!0}),!e&&(e=this.getListOfType("today"))){var t=this.getListOfType("inbox");t&&t.doItemFetchIfNeeded()}return e||(e=this.getListOfType("inbox")),e?this.selectItem(e.id):this.models.length&&(e=this.models[0],this.selectItem(e)),e?e:null},getListOfType:function(e){return this.findWhere({type:e})},getListById:function(e){return this.findWhere({id:e})},unSelectedItems:function(){var e=this;return this.selectedListId?this.reject(function(t){return t.id==e.selectedListId}):this.toArray()},isDoneList:function(){var e=this.selectedItem();return!(!e||!e.get("done"))},checkSelectedItem:function(e){if(!this.selectedListId){var t=null,i=this.selectedListCacheKey();if(i&&localStorage.getItem(i)){var n=localStorage.getItem(i);t=this.findWhere({id:n})}if(t||(t=this.findWhere({selected:!0})),!t&&this.models.length>0)return t=this.models[0],void this.selectItem(t.id);t?this.selectItem(t.id):this.selectItem(null)}},selectItem:function(e){if(e!=this.selectedListId){var t=this.selectedListCacheKey();t&&localStorage.setItem(t,e),this.selectedListId=e,this.trigger("selectionChanged"),null!=e&&this.externallyFetchedOnce&&this.selectedItem().doItemFetchIfNeeded(!0)}}}),m.collect.Todos=m.collect.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},listStatus:null,firstLoadCompleted:!1,reorderItem:function(e){var t=this,i={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset,list_id:e.list_id}}]},n=this.get(e.move_id);n&&(n.set({isLoading:!0}),$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(i),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){n.set({isLoading:!1}),t.fetch()}).fail(function(e,t){n.pendingReorderData=i,n.set({saveFailed:!0,isLoading:!1})}))},onLoadingFromServerChanged:function(){this.setStatus(null),this.checkRemainingItemCount()},onCollectionChanged:function(e){this.checkRemainingItemCount()},completedCount:function(){var e=this.completeToday();return e.length},checkRemainingItemCount:function(){if(!this.loadingFromServer){this.firstLoadCompleted=!0;var e=this.remaining(),t=e.length;t!=this.previousCount&&(this.previousCount=t,this.trigger("remainingCountChanged",t))}},doFetchIfNeeded:function(e){this.firstItemFetchStarted?this.fetch(this.moreLoaded?{remove:!1}:null):(this.firstItemFetchStarted=!0,this.fetch({reset:!0}))},loadMore:function(e){this.moreLoaded=!0,this.todoChangedListener||(this.todoChangedListener=!0,this.listenTo(m,"todo:changed",this.todoChanged)),this.fetch({endDate:e,remove:!1})},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},parse:function(e){return e.items?(e.sections?this.itemSections=e.sections:this.itemSections=null,e.menu_options?this.menuOptions=e.menu_options:this.menuOptions=null,e.default_commands?this.defaultCommands=e.default_commands:this.defaultCommands=null,e.items):e},todoChanged:function(e){if(this.moreLoaded){var t=this.get(e);t&&t.fetch()}},activeToday:function(){var e=this;if(!this.firstItemFetchStarted)return this.doFetchIfNeeded(),[];if(this.parentList.isDoneList()){if(e.parentList.showAssignedTodosOnly()&&!item.get("assigned"))return;return this.where({deleted:!1,done:!0})}return this.filter(function(t){if((!e.parentList.showAssignedTodosOnly()||t.get("assigned"))&&(!t.get("today")||e.parentList.isTodayList())&&(t.get("today")||!e.parentList.isTodayList())&&0==t.get("archive")&&0==t.get("deleted")){var i=t.get("listId");if(i==e.parentList.id||!i)return!0;if("1-##default"==e.parentList.id)return!0}})},fetch:function(e){var t=this;if(!this.loadingFromServer){this.loadingFromServer=!0;var i={};return this.parentList&&(i.data=i.data||{},i.data.listId=this.parentList.id),e&&e.endDate&&(i.data=i.data||{},i.data.endDate=e.endDate),i.error=function(e,i,n){return t.loadingFromServer=!1,403==i.status&&i.responseJSON&&i.responseJSON.status&&"authRequired"==i.responseJSON.status?void t.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:i.responseJSON}):void t.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},e=_.extend(e||{},i),e&&void 0!=e.reset?(this.setStatus({status:"loading",message:"Loading..."}),this.moreLoaded=!1):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,e)}}}),m.collect.TodosLegacy=m.collect.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,fetch:function(e){return e=e||{},Backbone.Collection.prototype.fetch.call(this,e)},createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},clearCompleted:function(e){var t="archived-"+getActiveDateString();if(e||!localStorage[t]){localStorage.setItem(t,Date.now());var i=!1,n=this.completeToday();_.each(n,function(e){var t=e.get("completedDate");if(t){var n=Date.parse(t),o=activeDateStringForDate(n);o!=getActiveDateString()&&(e.archive(),i=!0)}}),i&&this.trigger("reset")}},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),n=e.move_offset>0?1:-1,o=this.indexOf(i),s=1;if(o+n>=0&&o+n<this.length){var a=this.at(o+n);s=Math.abs(a.get("order")-i.get("order")),s<=20&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*n;t.save({order:l},{silent:!0})}}),m.collect.TodoProviders=Backbone.Collection.extend({model:m.models.TodoProvider,url:m.globals.urlRoot+"todos/providers",loadedOnce:!1,initialize:function(e,t){this.listenTo(this,"reset",this.collectionReset)},collectionReset:function(){this.loadedOnce=!0},parse:function(e){return e.connected?e.connected:null}}),m.models.TodoListManager=Backbone.Model.extend({mergeLists:function(e){},defaults:{activeTodoList:null},initialize:function(e){if(e&&e.prefetchTodos&&(this.prefetchTodos=!0),this.todoProviders=new m.collect.TodoProviders,this.listenTo(m,"globalEvent:refreshInbox",this.refreshInbox),this.listenTo(this.todoProviders,"reset",this.todoProvidersReset),!localStorage.activeTodoProvider)return void this.changeProvider(1,!0);var t=JSON.parse(localStorage.activeTodoProvider);return t?void this.changeProvider(t,!0):void this.changeProvider(1,!0)},refreshInbox:function(){this.activeProvider.getDefaultList()&&this.activeProvider.getDefaultList().refreshItems()},triggerChangeEvent:function(){this.trigger("change",this)},doFetchIfNeeded:function(e){this.externallyFetchedOnce=!0,this.activeProvider.doFetchIfNeeded(e)},changeProvider:function(e,t){var i=this.todoProviders.get(e);if(!i){var n={id:e,prefetchTodos:this.prefetchTodos};1!=e&&"1"!=e||(n.add_lists=!0),this.todoProviders.add(n),i=this.todoProviders.get(e)}i&&this.activeProvider!=i&&(m.trigger("todo:topmenu:reset"),localStorage.activeTodoProvider=JSON.stringify(i.id),this.activeProvider&&this.stopListening(this.activeProvider),this.activeProvider=i,this.listenTo(this.activeProvider,"change",this.triggerChangeEvent),this.triggerChangeEvent(),(this.externallyFetchedOnce||this.prefetchTodos)&&(this.activeProvider.refreshTodoItems(),this.activeProvider.doFetchIfNeeded(!0)),m.trigger("todo:providerChanged",e))},todoProvidersReset:function(){this.pendingResetCallback&&(this.pendingResetCallback(),this.pendingResetCallback=null)},todoProviderDetails:function(e){if(this.todoProviders){if(this.todoProviders.loadedOnce)return this.todoProviders.get(e);if(this.cachedTodoProviders){var t=this.cachedTodoProviders.findWhere({id:e});if(t)return t}if(localStorage.cachedTodoProviders){this.cachedTodoProviders=new Backbone.Collection(JSON.parse(localStorage.cachedTodoProviders));var t=this.cachedTodoProviders.findWhere({id:e});if(t){if(localStorage.tsCachedTodoProviders){var i=new Date,n=JSON.parse(localStorage.tsCachedTodoProviders),o=new Date(n),s=new Date(i.getTime()-864e5);o<s&&this.fetchAndCacheTodoProviders()}else this.fetchAndCacheTodoProviders();return t}}return this.fetchAndCacheTodoProviders(),null}},fetchAndCacheTodoProviders:function(e){var t=this;this.fetchingTodoProviders||(this.fetchingTodoProviders=!0,this.pendingResetCallback=function(){t.cacheTodoProviders(),e?e():t.triggerChangeEvent()},this.todoProviders.fetch({reset:!0}))},cacheTodoProviders:function(){if(this.todoProviders&&this.todoProviders.loadedOnce){var e=new Date;localStorage.setItem("tsCachedTodoProviders",JSON.stringify(e.getTime()));var t=this.todoProviders.toJSON();localStorage.setItem("cachedTodoProviders",JSON.stringify(t))}},selectPreviousProvider:function(){var e=this,t=function(){var t=e.todoProviders.get(e.activeProvider.id);if(t){var i=e.todoProviders.indexOf(t);if(i>0){var n=e.todoProviders.at(i-1);n&&e.changeProvider(n.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?t():this.fetchAndCacheTodoProviders(t))},selectNextProvider:function(){var e=this,t=function(){var t=e.todoProviders.get(e.activeProvider.id);if(t){var i=e.todoProviders.indexOf(t);if(i<e.todoProviders.length-1){var n=e.todoProviders.at(i+1);n&&e.changeProvider(n.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?t():this.fetchAndCacheTodoProviders(t))}}),m.views.TodoDropdownMenu=Backbone.View.extend({template:m.templates.todos.dropdownmenu,expanded:!1,renderedOnce:!1,menuOptionsFetched:!1,events:{"click .control-dropdown":"toggleDropdown","dblclick .control-dropdown":"eatDblClick","click li":"clickMenuItem","click .show-dropdown-detail":"showDropdownDetail","click .dropdown-detail-back":"hideDropdownDetail"},initialize:function(e){this.submenu=null,this.menuItems=e.menuItems,this.parentContext=e.parentContext,this.comparisonNode=e.comparisonNode,this.iClassName=e.iClassName,this.dropdownClassName=e.dropdownClassName,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),
this.listenTo(m,"globalEvent:closeDropdowns",this.closeDropdown),this.listenTo(m,"globalEvent:esc globalEvent:click",this.closeDropdown),this.subViews=[]},render:function(){var e={};this.iClassName&&(e.iClassName=this.iClassName),"icon-cog"==this.iClassName&&(e.iClassName=""),this.dropdownClassName&&(e.dropdownClassName=this.dropdownClassName);var t=this.template(e);this.$el.html(t),this.$dropdown=$(this.$el.find(".dropdown")[0]),this.$dropdownList=$(this.$el.find(".dropdown-list")[0])},updateModel:function(e){this.model=e},resetMenuItems:function(){this.menuOptionsFetched=!1;var e=this.expanded;this.expanded=void 0,e&&this.setExpandedState(e)},setExpandedState:function(e){if(this.expanded!=e){void 0!=e&&(this.expanded=e),this.$el.toggleClass("active",this.expanded);var t=this.$dropdown.closest(".todo-item");t.toggleClass("todo-item-active",this.expanded);var i=this;this.expanded?(this.$dropdown.show(),setTimeout(function(){i.$dropdown.css("opacity",1)},10),this.renderMenuOptions()):(this.$dropdown.css("opacity",0),setTimeout(function(){i.$dropdown.hide()},300)),this.ensureVisible(this.$dropdown.outerHeight())}},eatDblClick:function(e){e&&(e.preventDefault(),e.stopPropagation())},closeDropdown:function(e){this!=e&&this.expanded===!0&&this.setExpandedState(!1)},attachMenuItems:function(e,t){this.menuItems&&this.menuItems!=t&&this.stopListening(this.menuItems),this.$el!=e&&(this.setElement(e),this.renderedOnce=!1),this.menuItems!=t&&(this.menuItems=t,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.menuOptionsFetched=!1),this.expanded=!1,this.render()},renderMenuOptions:function(){var e=this;if(this.items=this.getActiveMenuOptions(),this.items&&this.items.length>0){this.$dropdownList.html("");var t=this.items.filter(function(t){return m.commandManager.canExecute(t.get("commandId"),e.model,t.get("options"),e.parentContext)}),i=t.length;if(i>0){var n=0,o=null;_.each(t,function(t){var s,a=t.get("css_class");(!a||"line"!=a||"line"!=o&&"header"!=o)&&("line"!=a||0!=n&&n!=i-1?(s=e.buildMenuItem(t),e.$dropdownList.append(s)):n+=1,n+=1,o=a)})}}else 0==this.items&&e.$dropdownList.html('<li class="loading"><i class="loading-icon"></i> Loading...</li>');m.trigger("todolist:updateHeight",e.$dropdownList.height()),this.ensureVisible(this.$dropdown.outerHeight()),this.menuOptionsFetched=!0},buildMenuItem:function(e){var t,i=m.commandManager.getProperties(e.get("commandId"),this.model,e.get("options"),this.parentContext);i&&i.captionText&&(t=i.captionText);var n=e.get("css_class"),o=$("<li/>");if(e.id?o.attr("data-itemid",e.id):o.attr("data-itemid",e.cid),o.text(t||e.get("captionText")),e.get("imageUrl")){var s=$("<img />");s.addClass("dropdown-list-icon"),s.attr("src",e.get("imageUrl")),o.prepend(s)}if(e.get("checkStateCmd")){var a=m.commandManager.execute(e.get("checkStateCmd"),this.model,e.get("options"),this.parentContext);a&&o.prepend('<i class="icon icon-check dropdown-list-icon"></i>')}return n&&o.addClass(n),o},getActiveMenuOptions:function(){return(!this.menuItems.fetchIfRequired||!this.menuItems.fetchIfRequired())&&this.menuItems},toggleDropdown:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.expanded||m.trigger("globalEvent:closeDropdowns",this),this.setExpandedState(!this.expanded)},clickMenuItem:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),i=t.data("itemid");if(i&&this.items){var n=this.items.get(i);void 0==n&&(n=this.submenu.items.get(i));var o=n.get("commandId");if("undefined"==typeof o)return;var s=m.commandManager.getCommand(o),a=s.execute(this.model,n.get("options"),this.parentContext);s.getSubmenu&&(this.submenu=s.getSubmenu()),n.get("checkStateCmd")&&this.renderMenuOptions(),a||this.closeDropdown(),s.getSubmenu&&this.showDropdownDetail()}},expandedHeight:function(){return this.expanded?this.$dropdown.outerHeight():0},ensureVisible:function(e){var t=$(this.comparisonNode);if(this.comparisonNode&&this.$dropdown&&this.expanded){var i,n=this.$dropdown.parentsUntil(".todo-item").parent(),o=e;o>t.outerHeight()&&(i=Math.min(o+5,document.body.getBoundingClientRect().height-150),m.trigger("todolist:updateHeight",i));var s=t.offset().top+t.outerHeight(),a=n.offset().top+n.outerHeight()+o,l=s-a;l<0?this.$dropdown.css({top:Math.max(t.offset().top-n.offset().top,l+18)+"px",right:"18px"}):this.$dropdown.css({top:"20px"}),this.$dropdown.css({bottom:"auto"}).show()}else this.$dropdown&&!this.expanded&&m.trigger("todolist:updateHeight",0)},showDropdownDetail:function(){var e=this;if(this.submenu.items&&this.submenu.items.length>0){var t=this.submenu.items.length,i=$(this.$el.find(".dropdown-detail")[0]);i.html("");var n=this.submenu.title;n?i.append($('<li class="dropdown-detail-back dropdown-title">'+n+"</li>")):i.append($('<li class="dropdown-detail-back"><i class="icon icon-left dropdown-detail-title-back"></i></li>'));var o=0;if(t>0){var s=null,a=this.submenu.items.models;_.each(a,function(t){var n=t.get("css_class");if(!n||"line"!=n||"line"!=s&&"header"!=s){var a=e.buildMenuItem(t);i.append(a),o+=1,s=n}})}}var l=this.$el.find(".dropdown-detail").outerHeight(!0);m.trigger("todolist:updateHeight",l);this.$el.find(".dropdown").addClass("show-detail").height(l);setTimeout(function(){e.ensureVisible(l+20)},0)},hideDropdownDetail:function(e){var t=this.$el.find(".dropdown-list").outerHeight(!0);m.trigger("todolist:updateHeight",t+20),this.$el.find(".dropdown").removeClass("show-detail").height(t);var i=this;setTimeout(function(){i.ensureVisible(t+20)},0)}}),m.views.AddTodoList=Backbone.View.extend({tagName:"li",attributes:{"class":"todo-list-add-row"},template:m.templates.todos.addtodolist,events:{keyup:"handleKeyup",keydown:"handleKeydown",click:"ignoreClick","click #add-label":"handleClick"},initialize:function(e){this.parent=e.parent,this.listenTo(m,"todo:loadingStateChange",this.render),this.adding=!1},render:function(){this.adding=!1,this.$el.html(this.template()),this.$inputNewList=$(this.$el.find("#list-new")[0]),this.$addListLabel=$(this.$el.find("#add-label")[0]),this.$loading=$(this.$el.find(".new-list-loading")[0]);var e=this.model.activeProvider.selectedList();return e&&e.get("add_hidden")?(this.$el.prop("disabled",!0),void this.$el.prop("placeholder","")):(this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New List")),this.$inputNewList.hide(),this.$loading.hide(),this.$addListLabel.show(),this)},ignoreClick:function(e){e.stopPropagation(),e.preventDefault()},handleClick:function(e){if(e.stopPropagation(),e.preventDefault(),!m.conditionalFeatures.featureEnabled("plus")){var t={targetRegion:"todos",sourceEvent:"todoAddList",buttonText:"Learn more",title:"Multi-todo lists",description:"Create and customize multiple todo lists"};return void m.commandManager.execute("upsell.message",t)}this.adding=!0,this.$inputNewList.show(),this.$addListLabel.hide(),this.focusInputField()},cancelEdit:function(e){this.adding=!1,this.$inputNewList.hide(),this.$inputNewList.val(""),this.$addListLabel.show()},createOnEnter:function(e){var t=m.utils.capitalizeFirstLetter(this.$inputNewList.val());t&&0!=t.length&&0!=t.trim().length&&this.model.activeProvider&&(this.$inputNewList.val(""),this.model.activeProvider.addNewList(t,function(){m.trigger("todo:listAdded")}),this.adding=!1,this.$inputNewList.hide(),this.$inputNewList.val(""),this.$loading.show())},focusInputField:function(){this.$inputNewList.focus()},handleKeyup:function(e){13==e.keyCode?this.createOnEnter():27==e.keyCode&&(e.stopPropagation(),this.cancelEdit(),this.$el.blur())},handleKeydown:function(e){var t=null;if(t){var i=this.$el.val();i&&0!=i.length&&0!=i.trim().length||(e.preventDefault(),e.stopPropagation(),m.trigger(t,e))}}}),m.views.NewTodoInput=Backbone.View.extend({events:{keyup:"handleKeyup",keydown:"handleKeydown"},initialize:function(e){this.parent=e.parent,this.todoList=e.todoList,this.listenTo(m,"todo:loadingStateChange",this.render),this.listenTo(m,"todo:listAdded",this.focusInputField)},render:function(){var e=this.model.activeProvider.selectedList();return e&&e.get("add_hidden")?(this.$el.prop("disabled",!0),void this.$el.prop("placeholder","")):void(this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo")))},createOnEnter:function(e){if(!this.todoList.isLoading()){var t=this.$el.val();if(t&&0!=t.length&&0!=t.trim().length){var i=this.model.activeProvider.selectedList();if(i){i.changeCount(!0),this.$el[0].value="";var n=e&&(e.ctrlKey||e.metaKey);i.createNewModel({title:t},!1,n)}}}},focusInputField:function(){this.$el.focus()},handleKeyup:function(e){13==e.keyCode&&this.createOnEnter(e),27==e.keyCode&&(e.stopPropagation(),this.$el.blur())},handleKeydown:function(e){var t=null;if(32==e.keyCode?t="globalEvent:spacebar":37==e.keyCode?t="globalEvent:arrowLeft":39==e.keyCode&&(t="globalEvent:arrowRight"),t){var i=this.$el.val();i&&0!=i.length&&0!=i.trim().length||(e.preventDefault(),e.stopPropagation(),m.trigger(t,e))}}}),m.views.TodoListHeader=Backbone.View.extend({events:{"click .todo-list-active":"toggleChooser","click .todo-list-choice":"chooseList","click .control-autofocus":"toggleAutoFocus","click #status-action":"statusActionClick"},choosing:!1,initialize:function(e){this.listeningTo=null,this.parent=e.parent,this.$activecontainer=$(this.$el.find(".todo-list-active")[0]),this.$choosercontainer=$(this.$el.find(".todo-list-chooser-dropdown")[0]),this.listenTo(m,"globalEvent:closeDropdowns",this.stopChoosing),this.listenTo(this.model,"change",this.handleManagerChange),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m,"globalEvent:click",this.globalClick),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.listenTo(m,"todo:status",this.renderActiveItem),this.listenTo(m,"todo:topmenu:reset",this.topMenuReset),this.defaultColor="rgba(0,0,0,0)"},render:function(e){var t=this.model.activeProvider.listCollection;t&&this.listeningTo!=t&&(this.listenTo(t,"change",this.handleCollectionChange),this.listeningTo&&this.stopListening(this.listeningTo,"change"),this.listeningTo=t),this.renderActiveItem(e),this.renderListChooser(),this.renderTopMenu()},toggleChooser:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.model.activeProvider.listCollection.length>1&&(m.trigger("globalEvent:closeDropdowns",this),this.setChoosingState(!this.choosing))},globalClick:function(e){e!=this&&this.setChoosingState(!1)},todoChanged:function(e,t){t&&(t.hasOwnProperty("done")||t.hasOwnProperty("listId"))&&this.renderActiveItem()},topMenuReset:function(){this.topMenuDropdownView&&this.topMenuDropdownView.resetMenuItems()},autoFocusChanged:function(e){var t=e.changedAttributes();t.hasOwnProperty("autoFocus")&&this.renderActiveItem()},showAssignedTodosOnlyChanged:function(){this.renderActiveItem()},setChoosingState:function(e){this.choosing!=e&&(this.choosing=e,this.$activecontainer.toggleClass("choosing",this.choosing),this.choosing?(this.$el.closest(".todo-pane").css("overflow-y","auto"),m.trigger("todolist:updateHeight",this.$choosercontainer.height()),this.$choosercontainer.show()):(this.$el.closest(".todo-pane").css("overflow-y","hidden"),m.trigger("todolist:updateHeight",0),this.$choosercontainer.hide()))},expandedHeight:function(){var e=0,t=0;return this.choosing&&(e=this.$choosercontainer.outerHeight()),this.topMenuDropdownView&&(t=this.topMenuDropdownView.expandedHeight()),_.max([e,t])},stopChoosing:function(e){m.views;e!=this&&e!=m.views.todoPane&&this.setChoosingState(!1)},chooseList:function(e){e&&e.stopPropagation(),this.stopChoosing();var t=$(e.currentTarget).data("list-id");this.model.activeProvider.selectList(t)},toggleAutoFocus:function(e){if(e&&(e.preventDefault(),e.stopPropagation()),!m.conditionalFeatures.featureEnabled("plus")){var t={targetRegion:"todos",sourceEvent:"autofocus",buttonText:"Learn more",title:"Autofocus Mode",description:"See your top todo as your focus throughout the day"};return void m.commandManager.execute("upsell.message",t)}m.commandManager.execute("todo.toggle.autofocus")},statusActionClick:function(e){if(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("action");t&&m.commandManager.execute(t,this.lastStatus)}},handleCollectionChange:function(e){var t=e.get("count"),i=this.$el.find("[data-list-id='"+e.id+"']");$(i.find(".todo-count")[0]).text(t),this.model.activeProvider.selectedList().id==e.id&&$(this.$el.find(".active-todo-count")[0]).text(t)},handleTodoCountUpdate:function(e,t){var i;if(i=e?this.model.activeProvider.getListById(e):this.model.activeProvider.selectedList(),i&&i.itemCollection){var n=i.remainingTodoCount();this.$el.find("span.active-todo-count").text(t)}var o=this.$el.find("[data-list-id='"+i.id+"']");$(o.find(".todo-count")[0]).text(n)},renderActiveItem:function(e){if(this.model.activeProvider.listCollection){var t={};e||(e=this.model.activeProvider.providerStatus()),e&&(this.lastStatus=e,"loading"!=e.status&&e.message&&(t.statusMessage=e.message,e.actionMessage&&(t.actionMessage=e.actionMessage),e.action&&(t.action=e.action)));var i=this.model.activeProvider.selectedList();if(i){var n=i.get("color");t.color=n?n.indexOf("rgb")<0?"#"+n:n:this.defaultColor,t.listTitle=i.get("title"),t.providerLogo=i.get("small_icon_url"),t.remaining=i.remainingTodoCount()}if(!t.providerLogo&&this.model.activeProvider&&1!=this.model.activeProvider.id){var o=this.model.todoProviderDetails(this.model.activeProvider.id);o&&(t.providerLogo=o.get("small_icon_url"))}if(!this.compareObjects(t,this.lastContext)){this.lastContext=t;var s=m.templates.todos.todolistactive(t);if(this.$activecontainer.html(s),i){var a=$(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView?this.topMenuDropdownView.attachMenuItems(a,i.topMenuItems()):this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:a,iClassName:"icon-cog",dropdownClassName:"todo-header-dropdown",menuItems:i.topMenuItems(),model:i}),this.topMenuDropdownView.render()}}this.$activecontainer.find(".control-autofocus").toggleClass("active",m.models.customization.get("autoFocus"));var l=!i||this.model.activeProvider.listCollection.length<=1;this.$activecontainer.find(".icon-angle-down").toggle(!l),l&&this.$activecontainer.find("li").css({Cursor:"default"}),this.parent.setMaxWidgetHeight(),this.$activecontainer.toggleClass("momentum-todo",1==this.model.activeProvider.id)}},compareObjects:function(e,t){return e==t||JSON.stringify(e)==JSON.stringify(t)},renderListChooser:function(){var e=this,t=this.model.activeProvider.listCollection;if(t){var i=t.toArray();this.$choosercontainer.html(""),_.map(i,function(i){var n={};n.listId=i.id,n.title=i.get("title"),n.color=i.get("color"),n.count=i.get("count"),i.id==t.selectedItem().get("id")&&(n["class"]="todo-list-choice-active");var o=m.templates.todos.todolistchoice(n),s=e.$choosercontainer.append(o);s.data("list-id",i.id)});var n=m.models.todoListManager.todoProviderDetails(this.model.activeProvider.get("id"));n&&n.get("add_lists")&&(this.addTodoListView||(this.addTodoListView=new m.views.AddTodoList({model:this.model}),this.listenTo(m,"todo:listAdded",this.stopChoosing)),e.$choosercontainer.append(this.addTodoListView.render().el),this.addTodoListView.delegateEvents())}},renderTopMenu:function(){},handleManagerChange:function(){if(this.topMenuDropdownView){var e=this.model.activeProvider.selectedList();this.topMenuDropdownView.updateModel(e)}this.render()},handleTodoLoadingStateChange:function(e){this.render(e)},providerChanged:function(){this.render()}}),m.views.TodoItem=Backbone.View.extend({attributes:{"class":"todo-item"},tagName:"li",template:m.templates.todos.todoitem,events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},editing:!1,renderedOnce:!1,initialize:function(e){this.parent=e.parent,this.provider=e.provider,this.listId=e.list_id,this.menu_options=e.menu_options,this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"todo:edit",this.edit),this.listenTo(m,"todo:refresh",this.refreshTodo),this.listenTo(m,"todo:set:done",this.setDone),this.listenTo(m,"globalEvent:esc",this.abortEdit)},refreshTodo:function(e){e==this.model.id&&this.model.fetch()},setDone:function(e,t){e==this.model.id&&this.model.set("done",t)},render:function(){if(this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.model.get("deleted"))return this.hideTodoItem(),this;if(!this.isDoneList&&(this.model.get("listId")!=this.listId||this.model.get("archive")))return this.hideTodoItem(),this;if(this.isDoneList&&!this.model.get("done"))return this.hideTodoItem(),this;if(!this.isTodayList&&!this.isDoneList&&this.model.get("today"))return this.hideTodoItem(),this;if(this.isTodayList&&!this.model.get("today"))return this.hideTodoItem(),this;var e=m.utils.captionFormatter(this.model.getValue("title"));if(this.renderedOnce)this.$title.text(e);else{var t={title:e};this.$el.html(this.template(t)),this.$title=this.$el.find(".todo-item-title").first(),this.$checkbox=this.$el.find(".todo-item-checkbox").first(),this.renderedOnce=!0}if(this.$checkbox.prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",this.model.isTrue("done")),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.$el.attr("data-todo-id",this.model.id),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.selectedList.supportsReordering()&&this.$el.prop("draggable","true"),this.menu_options){var i=$(this.$el.find(".dropdown-container")[0]);this.topMenuDropdownView||(this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:i,iClassName:"icon-ellipsis",dropdownClassName:"todo-item-dropdown",menuItems:this.menu_options,model:this.model,parentContext:this.provider,comparisonNode:this.parent.$el})),this.topMenuDropdownView.render()}return this},hideTodoItem:function(){this.$el.html(""),this.$el.hide(),this.stopListening(m,"globalEvent:spacebar"),this.parent&&this.parent.checkForEmptyState()},isHidden:function(){return!this.$el.is(":visible")},scrollIntoView:function(){this.parent.isScrolling&&this.$el[0].scrollIntoView(!1)},destroy:function(){this.stopListening(),this.remove(),this.unbind()},abortEdit:function(){this.editing&&(this.$el.removeClass("editing"),this.$title.text(this.originalText),this.$title.attr("contentEditable",!1),this.editing=!1)},saveEdit:function(){if(this.editing){this.$el.removeClass("editing"),this.editing=!1;var e=this.$title.text();this.$title.attr("contentEditable",!1),e?this.model.attemptSave({title:e}):this.clear(),this.parent.updateHeight()}},retrySave:function(){this.model.isTrue("isProxy")?this.model.targetList&&this.model.targetList.createNewModel(this.model,!0):(this.model.attemptedSaveValues||this.model.pendingReorderData)&&this.model.attemptSave()},edit:function(e){this.editing||(this.originalText=this.$title.text(),e&&e.stopPropagation(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$title.attr("contentEditable",!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),m.sendEvent("Todo","Activate Edit")))},dragstart:function(e){if(e.stopPropagation(),this.editing)return!1;if(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("todo_id",this.model.id),0==this.model.get("leafNode")){var t=this.$el.cloneNode(!0);t.className="ghost",t.style.position="absolute",t.style.zIndex="-1",t.querySelector(".todo-item-checkbox").style.marginTop="3px",e.currentTarget.appendChild(t),e.originalEvent.dataTransfer.setDragImage(t,e.originalEvent.offsetX-15,e.originalEvent.offsetY+2)}this.parent.dragmode="todo",this.parent.dragging=this,this.parent.original_index=this.parent.li_index(this.$el,!0),0!=this.parent.original_index?(this.parent.$preceeding_item=this.previousSiblingTodo(),this.parent.preceedingTodoId=this.previousSiblingTodoId()):(this.parent.$preceeding_item=null,this.parent.preceedingTodoId=null),m.sendEvent("Todo","Reorder")},dragenter:function(e){if(e.stopPropagation(),"todo"==this.parent.dragmode){if(!this.isSibling(this.parent.dragging.model))return!0;this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;return this.parent.$placeholder.css("display","list-item"),t.height(this.parent.dragging.$el.height()),t.after(this.parent.dragging.$el),!1}},isSibling:function(e){return this.model.isSibling(e)},previousSiblingTodo:function(){return this.$el.prevAll("li").not(".placeholder").first()},previousSiblingTodoId:function(){return this.$el.prevAll("li").not(".placeholder").first().data("todo-id")},onMouseEnter:function(e){m.views.todoPane.isHovered=!0,this.listenTo(m,"globalEvent:spacebar",this.invokeDefaultCommand)},onMouseLeave:function(e){this.stopListening(m,"globalEvent:spacebar"),m.views.todoPane.isHovered=!1},invokeDefaultCommand:function(){var e=this,t=this.selectedList.getDefaultCommands();if(t&&t.length>0){var i=_.find(t,function(t){return!!m.commandManager.canExecute(t.commandId,e.model,t.options,e.provider)});i&&(m.commandManager.execute(i.commandId,e.model,i.options,e.provider),this.parent.updateHeight())}},toggleDone:function(e){if(e&&e.stopPropagation(),this.selectedList.has("done_disabled")){e&&e.preventDefault();var t=this.selectedList.get("done_disabled");return void(t.message&&m.trigger("todo:status",t))}m.sendEvent("Todo","Done");var i=!this.model.get("done");this.model.attemptSave({done:i,completedDate:i?new Date:null}),this.topMenuDropdownView.resetMenuItems(),m.trigger("todo:loadingStateChange",null);var n=this.provider.getDoneList();n&&!this.selectedList.isDoneList()&&n.changeCount(i)},handleInput:function(e){this.editing&&(this.parent.updateHeight(),13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit"),e.preventDefault(),e.stopPropagation()),27==e.keyCode&&(e.stopPropagation(),this.abortEdit()))}}),m.views.TodoList=Backbone.View.extend({events:{dragover:"dragover",dragend:"dragend",drop:"drop","click .empty-link":"clickEmptyStateLink","click .empty-title":"clickEmptyTitleLink","click .todo-load-more-button":"loadMore"},reordered:!1,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],itemsRendered:!0,initialize:function(){this.emptyListGreeting="Add a todo to get started",this.subViews=[],this.isScrolling=!1,this.$loading=$('<span class="overlay loading todo-loading"><i class="loading-icon"></i> Loading...</span>'),this.$inPlaceLoading=$('<span class="loading"><i class="loading-icon"></i> <span class="loading-title">Loading...</span></span>'),this.listenTo(this.model,"change",this.providerChanged),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.listenTo(m,"todolist:updateHeight",this.updateHeight),this.listenTo(m,"todo:loadingStateChange",this.renderLoading),this.providerChanged()},render:function(){if(!this.renderedOnce){this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.renderedOnce=!0,this.renderLoading({status:"loading"}),this.$el.css("max-height",this.getHeightLimit()+"px");var e=localStorage.getItem("todo-list-min-height");this.$el.css("min-height",e||"22px")}this.$el.removeClass().addClass("todo-list");var t=this.model.activeProvider.selectedList();if(t){var i=t.get("list_class");i&&this.$el.addClass(i)}var n=this;this.addAll(function(e){n.renderItems(e)})},renderItems:function(e){var t=this.model.activeProvider.selectedList();e?t&&t.isDoneList()&&0==this.$el.find(".todo-load-more").length&&(this.lastCount&&this.lastCount==t.itemCollection.length?this.$el.append('<li class="todo-load-more"><span class="todo-load-more-done" style="text">That\'s all!</span></li>'):this.$el.append('<li class="todo-load-more"><span class="button todo-load-more-button">Load More</span></li>')):this.renderEmptyState();var i=this;this.$el.css("opacity",1),i.updateHeight(),t&&!t.itemCollection.loadingFromServer&&this.removeLoading()},loadMore:function(){var e=this,t=this.$el.find(".todo-load-more-button");t.remove(),e.$el.find(".todo-load-more").prepend(e.$inPlaceLoading);var i=this.model.activeProvider.selectedList();this.lastCount=i.itemCollection.length,i.itemCollection.loadMore(this.endDate)},dismissEmptyState:function(){this.emptyStateActive&&(this.$el.find(".empty").hide(),this.emptyStateActive=!1)},checkForEmptyState:function(){if(this.subViews){var e=_.every(this.subViews,function(e){return e.isHidden()});e&&this.render()}},renderEmptyState:function(){var e,t=this.model.activeProvider.selectedList();if(t&&t.itemCollection&&t.itemCollection.firstLoadCompleted){var i={};if(t.has("empty_message"))i.message=t.get("empty_message"),i.submessage=t.get("empty_submessage"),i.use_command=!!t.get("empty_command");else if("today"==t.listType()){i.message=this.emptyListGreeting;var n=this.model.activeProvider.listCollection.getListOfType("inbox");if(n){i.targetListId=n.id;var o=n.get("count");1==o?i.submessage="1 todo in Inbox":o>1?i.submessage=o+" todos in Inbox":i.submessage="Switch to Inbox"}}else"inbox"==t.listType()?(i.message=this.emptyListGreeting,e=this.model.activeProvider.listCollection.getListOfType("today"),e&&(i.targetListId=e.id,i.submessage="Switch to Today")):"done"==t.listType()?(i.message="No completed todos yet",e=this.model.activeProvider.listCollection.getListOfType("today"),e&&(i.targetListId=e.id,i.submessage="Get started in Today")):i.message=this.emptyListGreeting;this.emptyStateActive=!0,this.$el.append(m.templates.todos["todo-list-empty-state"](i)),this.itemsRendered=!0,this.updateHeight()}},addedToProxyCollection:function(e,t,i){this.isScrolling||this.$el.addClass("hide-scroll"),this.dismissEmptyState(),this.addOne(e,i&&0==i.at)},addOne:function(e,t){var i=null,n=this.model.activeProvider.selectedList();n&&(i=n.todoItemMenuOptions());var o=new m.views.TodoItem({model:e,parent:this,menu_options:i,provider:this.model.activeProvider,list_id:n.id});this.subViews.push(o);var s=e.get("parentId");if(s){var a=this.getTodoSubelementContainer(s);a?a.append(o.render().el):this.$el.append(o.render().el)}else e.get("isProxy")&&n.isDoneList()?$(this.$el.find("li.todo-section")[0]).after(o.render().el):t?this.$el.prepend(o.render().el):this.$el.append(o.render().el);e.get("isProxy")&&e.get("proxyValid")&&this.isScrolling&&(o.scrollIntoView(),this.newTodoAdded=!0,m.trigger("todolist:updateHeight"))},getTodoSubelementContainer:function(e){var t=this.$el.find('[data-todo-id="'+e+'"]');if(t&&t.length>0){var i=$(t[0]).find("ol");if(!i||0==i.length){var n=$("<ol />");return $(t[0]).append(n),n}return $(i)}return null},addAll:function(e){var t=this,i=function(){var i=t.addAllNow();e(i)};this.lastLisId!=this.model.activeProvider.selectedList()?(this.lastLisId=this.model.activeProvider.selectedList(),setTimeout(i,200),this.$el.css("opacity",0)):i()},addAllNow:function(){_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[];var e=!1;this.reordered=!1;var t=this;this.$el.html("");var i=this.model.activeProvider.selectedList();if(i){var n=i.itemCollection.activeToday(),o=i.proxyCollection.where({proxyValid:!0});n.length>0&&(e=!0),o&&o.length>0&&(e=!0);var s=!1,a=i.groupingInfo();if(a&&"date"==a.type){if(!_.isEmpty(n)){var l=_.map(n,function(e){var t=e.get(a.field),i=new Date(t);return{sortDate:i.getTime(),year:i.getFullYear(),month:i.getMonth(),day:i.getDate(),item:e}}),r=_(l).chain().sortBy("sortDate").reverse().value(),d=null,c=null,h=null;_.each(r,function(e){if(e.year!=d||e.month!=c||e.day!=h){d=e.year,c=e.month,h=e.day;var i=t.formatDate(e);t.$el.append('<li class="todo-section" title="'+i.calendarDate+'">'+i.friendlyDate+"</li>")}t.addOne(e.item),t.endDate=e.item.get("completedDate")})}s=!0}s||(_.each(n,function(e){t.addOne(e),t.endDate=e.get("completedDate")},this),_.each(o,function(e){t.addOne(e)},this))}if(e&&(this.itemsRendered=!0),this.newTodoAdded){var u=this.$el.children().last();u&&u.length>0&&this.isScrolling&&u[0].scrollIntoView(!1),this.newTodoAdded=!1}return e},formatDate:function(e){var t=new Date,i=this.monthNames[e.month]+" "+e.day+(t.getFullYear()==e.year?"":", "+e.year);if(e.year==t.getFullYear()&&e.month==t.getMonth()&&e.day==t.getDate())return{friendlyDate:"Today",calendarDate:i};var n=new Date(t.getTime()-864e5);if(e.year==n.getFullYear()&&e.month==n.getMonth()&&e.day==n.getDate())return{friendlyDate:"Yesterday",calendarDate:i};var o=new Date(e.sortDate),s=new Date(t.getTime()-5184e5);return o>s?{friendlyDate:this.weekdayNames[o.getDay()],calendarDate:i}:{friendlyDate:i,calendarDate:""}},clickEmptyStateLink:function(e){if(e&&e.currentTarget){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("use-command");if(t){var i=this.model.activeProvider.selectedList(),n=i.get("empty_command"),o=i.get("empty_command_options");return void m.commandManager.execute(n,null,o)}var s=$(e.currentTarget).data("target-list-id");s&&this.model.activeProvider.selectList(s)}},clickEmptyTitleLink:function(e){if(e&&e.currentTarget&&(e.preventDefault(),e.stopPropagation(),$(e.currentTarget).text()==this.emptyListGreeting)){var t=this.$el.parent().find(".todo-new")[0];t&&t.focus()}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el[0].getBoundingClientRect(),i=e.originalEvent.pageX,n=e.originalEvent.pageY,o=this.dragging.model.id,s=this.move_target_id;if(s!=o){if(i-10<t.right&&i+30>t.left&&n-20<t.top&&t.top-n<40)return void this.drop(e);if(i-10<t.right&&i+30>t.left&&n+20>t.bottom&&n-t.bottom<40)return void this.drop(e)}if("todo"==this.dragmode){var a=this.dragging.$el;"none"==e.originalEvent.dataTransfer.dropEffect&&(null!=this.$preceeding_item?this.$preceeding_item.after(a):this.$el.prepend(a)),this.$placeholder.hide(),a.show(),a.find(".ghost").remove()}return!1},drop:function(e){if("todo"==this.dragmode){var t=this.dragging.$el,i=this.dragging.model.id,n=this.move_target_id;if(n==i)return void this.dragend(e);var o=this.move_offset,s=this.li_index(this.dragging.$el,!0);if(0==s&&0==this.original_index)return!1;if(i==n)return!1;if(this.preceedingTodoId==this.dragging.previousSiblingTodoId())return!1;var a=this.model.activeProvider.selectedList(),l=a.itemCollection.get(i),r=a.itemCollection.get(n);if(!l||!r||!l.isSibling(r))return!1;this.$placeholder.hide(),t.show(),a.itemCollection.reorderItem({move_id:i,move_target_id:n,move_offset:o,list_id:a.id}),this.reordered=!0}},getTopActiveTodoId:function(){return this.$("li:not(.done, .placeholder)").first().data("todo-id")},li_index:function(e,t){return t?this.$("li").not(".placeholder").index(e):this.$("li").index(e);
},handleManagerChange:function(){this.render()},handleTodoLoadingStateChange:function(){this.render()},showAssignedTodosOnlyChanged:function(e){var t=this.model.activeProvider.selectedList();t&&t.id==e&&this.render()},providerChanged:function(){var e=this.model.activeProvider.selectedList();this.selectedList!=e&&(this.itemsRendered=!1,this.selectedList&&this.stopListening(this.selectedList.proxyCollection),this.selectedList=e,e&&this.listenTo(e.proxyCollection,"add",this.addedToProxyCollection)),this.render()},updateHeight:function(e){var t=0;0==e&&(e=this.contentHeight);var i,n=this.$el;if(n.is(":visible")){var o=this.$el.closest(".todo-pane");this.isScrolling?n.addClass("animating"):n.addClass("hide-scroll"),o.addClass("animating");var s=this.getHeightLimit();if(void 0==e){if(e=0,this.$loading.parent()&&0==n.children().length)return;n.children().each(function(t,i){e+=$(i).outerHeight(!0)}),i=!0,this.contentHeight=e,this.visibleHeight=Math.min(e,s)}var a=function(){n.removeClass("hide-scroll"),n.removeClass("animating"),o.removeClass("animating"),l.$el.unbind("transitionend webkitTransitionEnd",a)};this.$el.bind("transitionend webkitTransitionEnd",a),setTimeout(a,500),e>=n.outerHeight(!0)?(e=Math.min(e,s),this.isScrolling=e==s,t=e+"px",n.parent().css({"min-height":t}),n.css({"min-height":t})):(n.parent().css({"min-height":Math.max(this.visibleHeight,e)+"px"}),t=Math.max(this.visibleHeight,e)+"px",n.css({"min-height":t})),i&&(n.parent().css({"max-height":e+"px"}),n.css({"max-height":e+"px"})),localStorage.setItem("todo-list-min-height",t);var l=this}},renderLoading:function(e){var t=this;e&&("loading"==e.status?setTimeout(function(){t.$el.parent().append(t.$loading)},10):"error"==e.status&&setTimeout(function(){t.removeLoading()},20))},removeLoading:function(){this.$loading.remove(),this.$inPlaceLoading.remove(),this.updateHeight()},isLoading:function(){return this.$loading.parent().length>0},getHeightLimit:function(){var e=this.$el.parent().parent(),t=e.find(".todo-header").outerHeight(),i=e.find(".todo-message").outerHeight(!0),n=e.find(".todo-new").outerHeight(),o=$("#top-right").outerHeight()+$("#bottom-right").outerHeight();return document.body.getBoundingClientRect().height-(o+t+i+n)}}),m.views.TodoPane=Backbone.View.extend({attributes:{id:"todo","class":"widget-bottom-right todo"},template:m.templates.todos.todopane,renderedOnce:!1,todoListOpen:!1,events:{"click .todo-toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:toggle:bottom-right",this.onToggleBottomRight),this.listenTo(m,"globalEvent:esc",this.setTodoStateClosed),this.listenTo(m,"todo:visible",this.todoVisible),this.listenTo(m,"globalEvent:key:N",this.handleKeyPressN),this.listenTo(m,"globalEvent:arrowLeft",this.arrowLeft),this.listenTo(m,"globalEvent:arrowRight",this.arrowRight),this.listenTo(m,"globalEvent:window:resize",this.windowResize),this.listenTo(m,"todo:hidden",this.todoHidden),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),m.models.customization.get("keepTodoState")&&this.showTodoList()&&this.toggleShow(),this.isHovered=!1},render:function(){if(!this.renderedOnce){this.setMaxWidgetHeight();var e=this.template({}),t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(e).fadeTo(500,1),this.$panecontainer=this.$el.find(".todo-pane")[0],this.$listcontainer=this.$el.find(".todo-list")[0],this.$headercontainer=this.$el.find(".todo-header")[0],this.$newtodoinput=this.$el.find("#todo-new")[0],this.$el.toggleClass("show",this.todoListOpen),this.renderedOnce=!0}var i=this;return setTimeout(function(){i.$el.find(".todo-item").first().find(".dropdown").show()},1e3),this},showUpsell:function(e){e.template=m.templates.todos.upsell;var t=new m.views.upsell.message(e),i=t.render().$el;this.$el.find(".todo-pane").append(i),t.show()},showTodoList:function(){var e=localStorage.getItem("showTodoList");return!!e&&JSON.parse(e)},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.trigger("globalEvent:closeDropdowns",this),m.trigger("globalEvent:toggle:bottom-left",this);var t=!this.todoListOpen;t?this.todoVisible():this.todoHidden(),this.setMaxWidgetHeight()},onToggleBottomRight:function(e){e!=this&&this.todoListOpen&&this.todoHidden()},setTodoStateClosed:function(e){if(e!=this&&!(e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.el,e.target))){var t=!1;$(".todo-item-title").each(function(e,i){"true"==$(this).attr("contentEditable")&&(t=!0)}),t||this.todoHidden()}},setTodoOpenState:function(e){this.todoListOpen=e,m.models.customization.get("keepTodoState")?localStorage.showTodoList=e:localStorage.showTodoList=!1,1==e?this.showPopup():this.hidePopup(),e?(this.newTodoInput&&this.newTodoInput.focusInputField(),this.doFirstFetch()):this.todoHeader&&this.todoHeader.stopChoosing()},windowResize:function(){this.setMaxWidgetHeight()},setMaxWidgetHeight:function(){var e=$(window).height()-125,t=this.$el;if(t.css("max-height",e),t){var i=t.find(".todo-list-active").outerHeight(),n=t.find(".todo-message").outerHeight(!0),o=t.find(".todo-new").outerHeight();0==i&&(i=39),null==n&&(n=0),0==o&&(o=38)}return e},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto")},hidePopup:function(){if(this.$el.hasClass("show")){var e=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(t){e.$el.removeClass("show").find(".pane").css("height","auto")})}},doFirstFetch:function(){this.initializeManager(),m.models.todoListManager.externallyFetchedOnce=!0,m.models.todoListManager.activeProvider.doFetchIfNeeded(),m.models.todoListManager.activeProvider.refreshTodoItems()},todoVisible:function(){this.setTodoOpenState(!0)},todoHidden:function(){this.setTodoOpenState(!1)},onBackgroundLoaded:function(){this.initializeManager()},initializeManager:function(){m.models.todoListManager||(m.models.todoListManager=new m.models.TodoListManager({prefetchTodos:this.todoListOpen}),m.trigger("todo:managerReady"),this.todoHeader=new m.views.TodoListHeader({el:this.$headercontainer,model:m.models.todoListManager,parent:this}),this.todoList=new m.views.TodoList({el:this.$listcontainer,model:m.models.todoListManager}),this.newTodoInput=new m.views.NewTodoInput({todoList:this.todoList,el:this.$newtodoinput,model:m.models.todoListManager}),this.setMaxWidgetHeight())},visibleChanged:function(e){var t=m.models.customization.getComputedSetting("todoVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},arrowLeft:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),e.shiftKey?m.models.todoListManager.selectPreviousProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectPreviousList())},arrowRight:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),e.shiftKey?m.models.todoListManager.selectNextProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectNextList())},handleKeyPressN:function(e){this.todoListOpen&&e.altKey&&(e&&(e.preventDefault(),e.stopPropagation()),this.newTodoInput.focusInputField())},storedTodoPaneHeight:function(e){if(void 0!=e)return e>0&&localStorage.setItem("todo-pane-height",e),e;var t=localStorage["todo-pane-height"];return t?JSON.parse(t):null}}),m.views.upsell=m.views.upsell||{},m.views.upsell.message=Backbone.View.extend({events:{"click .upsell-hide":"hideUpsell","click .upsell-action":"clickButton"},initialize:function(e){this.template=e.template,this.options=e,this.listenTo(m,"globalEvent:click",this.handleClick)},render:function(){return this.options["class"]=(this.options["class"]?this.options["class"]+" ":"")+this.options.targetRegion+"-upsell",this.$el.html(this.template(this.options)),this.$el.addClass("overlay upsell-overlay"),this.$el.addClass(this.options["class"]),this},show:function(){var e=this,t=e.$el.height();e.$el.css("max-height",e.$el.parent().height()),setTimeout(function(){e.parentMinHeight=e.$el.parent().css("min-height"),e.parentMinHeight&&(e.parentMinHeight=parseInt(e.parentMinHeight.substring(0,e.parentMinHeight.length-2))),e.$el.parent().css("min-height",Math.max(t,e.parentMinHeight)),e.parentOverflow=e.$el.parent().css("overflow-y"),e.$el.parent().css("overflow-y","hidden"),e.$el.css("opacity",1)})},handleClick:function(e){$.contains(this.$el,e.target)||1!=this.$el.css("opacity")||this.hideUpsell()},hideUpsell:function(e){e&&e.stopPropagation(),this.$el.css("opacity",0);var t=this;t.$el.parent().css("min-height",t.parentMinHeight?t.parentMinHeight:0),setTimeout(function(){t.$el.remove(),t.$el.parent().css("overflow-y",t.parentOverflow)},300)},clickButton:function(e){e.stopPropagation(),m.commandManager.execute("upsell.website",null,{source:this.options.eventSource})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){switch(e.targetRegion){case"settings":m.views.settings.mainSettings.showUpsell(e);break;case"todos":m.views.todoPane.showUpsell(e)}}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t,i){var n="https://momentumdash.com/plus?utm_source=extension";t&&t.source?n+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(n+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:n})}}),m.views.Greeting=Backbone.View.extend({id:"greeting",template:m.templates.greeting["greeting-template"],events:{"dblclick .name":"editName","keypress .name":"onKeypress","keydown .name":"onKeydown","blur .name":"saveName","webkitAnimationEnd .name":"onAnimationEnd"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updatePeriod,this),this.listenTo(m.models.customization,"change:displayname",this.onUpdateName)},render:function(){var e=this.getPeriod(),t=m.models.customization.get("displayname"),i={period:e,name:t},n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template(i)).fadeTo(500,1),this.$period=this.$(".period"),this.$name=this.$(".name");var o=this;m.models.customization.getComputedSetting("clockVisible")?o.$el.addClass("transition"):setTimeout(function(){o.moveToCenter(),setTimeout(function(){o.$el.addClass("transition")},1e3)},10)},getPeriod:function(){var e,t=this.model.get("date"),i=t.getHours();return i>=3&&i<12&&(e="morning"),i>=12&&i<17&&(e="afternoon"),(i>=17||i<3)&&(e="evening"),e},updatePeriod:function(){this.$period.html(this.getPeriod())},editName:function(){this.$name.hasClass("editing")||(this.$name.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$name.get(0)))},onUpdateName:function(){this.$name.html(m.models.customization.get("displayname")),this.$name.attr("contenteditable",!1).addClass("pulse")},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$name.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveName())},onKeydown:function(e){27===e.keyCode&&(this.$name.html(m.models.customization.get("displayname")),this.doneEditingName())},saveName:function(){var e=this.$name.html();""===e?this.$name.html(m.models.customization.get("displayname")):m.models.customization.save({displayname:e}),this.doneEditingName()},doneEditingName:function(){this.$name.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},moveToCenter:function(){var e=(document.body.getBoundingClientRect().height-this.$el.outerHeight(!0))/2-this.$el[0].getBoundingClientRect().top;this.$el.css("transform","translateY("+e+"px)")},moveOffCenter:function(){this.$el.css("transform","translateY(0)")}}),m.views.CenterClock=Backbone.View.extend({id:"centerclock",events:{dblclick:"toggleMode"},initialize:function(){var e=localStorage.getItem("clockPercent");e&&(m.models.customization.save("clockPercent",e),localStorage.removeItem("clockPercent")),this.listenTo(m.models.customization,"change:percentClock",this.percentClockToggled),this.listenTo(m.models.customization,"change:clockPercent",this.percentClockToggled),this.listenTo(m.models.customization,"change:clockVisible",this.balanceChanged),this.listenTo(m.models.customization,"change:balanceModeStr",this.chooseClock),this.renderedOnce=!1,this.render()},render:function(){var e=(this.options.order||"append")+"To";return this.$el[e]("#"+this.options.region).html(""),m.models.customization.getComputedSetting("clockVisible")&&this.$el.fadeTo(500,1),m.models.customization.get("percentClock")&&"on"==m.models.customization.get("clockPercent")&&m.models.balanceMode.getDays()[(new Date).getDay()]?m.views.clockView=new m.views.PercentClock({model:this.model,parent:this}):m.views.clockView=new m.views.DefaultClock({model:this.model,parent:this}),this.$el.append(m.views.clockView.render().$el),this.renderedOnce=!0,this},chooseClock:function(){var e=!m.models.balanceMode.getDays()[(new Date).getDay()];(!e&&"default"==m.views.clockView.type||e&&"percent"==m.views.clockView.type)&&this.render()},balanceChanged:function(){var e=m.models.customization.getComputedSetting("clockVisible"),t=this,i=!1,n=!1;e?(this.renderedOnce?i=!0:(setTimeout(function(){t.render()},5),n=!0),setTimeout(function(){i&&t.$el.animate({opacity:1},{duration:700,queue:!1}),m.views.greeting.moveOffCenter()},n?10:0)):(t.$el.animate({opacity:0},{duration:300,queue:!1}),m.views.greeting.moveToCenter())},percentClockToggled:function(e){e&&e.changed&&1==Object.keys(e.changed).length&&e.changed.percentClock&&m.models.customization.get("percentClock")&&m.models.customization.save("clockPercent","on"),this.render()},toggleMode:function(){m.models.customization.get("percentClock")&&("on"==m.models.customization.get("clockPercent")?m.models.customization.save("clockPercent","off"):m.models.customization.save("clockPercent","on"),this.render())}}),m.views.DefaultClock=Backbone.View.extend({attributes:{"class":"clock default-clock"},template:m.templates.centerclock.clock,events:{dblclick:"toggleFormat"},initialize:function(){this.type="default",this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.customization,"change:hour12clock",this.timeFormatSettingChanged)},render:function(){var e={time:this.model.getTimeString(),format:"AM"};return this.$el.html(this.template(e)),this.$time=this.$(".time"),this.$format=this.$(".format"),this},update:function(){this.$time.html(this.model.getTimeString())},toggleFormat:function(){if(!m.models.customization.get("percentClock")){var e=m.models.customization.get("hour12clock");e=!e,m.models.customization.save({hour12clock:e}),this.setTimeFormat(e)}},timeFormatSettingChanged:function(){var e=m.models.customization.get("hour12clock");this.setTimeFormat(e)},setTimeFormat:function(e){e?(setTimeout(function(){$(".format").addClass("show")},40),this.$format.html(this.model.getTimePeriod())):$(".format").removeClass("show")}}),m.views.PercentClock=Backbone.View.extend({attributes:{"class":"percent-clock"},template:m.templates.centerclock.clock,events:{},initialize:function(){this.type="percent",this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.balanceMode,"change",this.update,this)},render:function(){return this.$el.html(this.template({time:this.getPercent(),format:"%"})),this.$time=this.$(".time"),this.$format=this.$(".format"),this.$format.css({opacity:1,"font-size":"250%",left:"106%",bottom:"7%"}),this},getPercent:function(){var e=m.models.balanceMode.getStart(),t=m.models.balanceMode.getEnd(),i=parseInt(e.hour),n=parseInt(t.hour),o=i+("PM"==e.noon&&12!=i||"AM"==e.noon&&12==i?-12:0),s=e.minute,a=n+("PM"==t.noon&&12!=n||"AM"==t.noon&&12==n?12:0)+("AM"==t.noon&&n<5?24:0),l=t.minute;a-o>24&&(a-=24),o>a&&(a+=24);var r=60*(a+parseInt(l)/60-(o+parseInt(s)/60))*60*1e3,d=new Date,c=new Date;c.setHours(o,s,0,0);var h=d.getTime()-c.getTime(),u=Math.floor(h/r*100);return u>100&&(u="+"+(u-100)),u},update:function(){this.$time.html(this.getPercent())}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){var t=e.actionParameter,i=0;if(t&&t.status&&"authRequired"==t.status&&t.authorizationUrl&&i<2){i++;var n=t.winWidth?t.winWidth:600,o=t.winHeight?t.winHeight:510,s=t.windowFeatures?t.windowFeatures:"titlebar,resizable,toolbar,status",a=window.screen.width/2-n/2,l=window.screen.height/2-o/2,r=window.open(t.authorizationUrl,"MomentumAuthWindow",s+",left="+a+",top="+l+",width="+n+",height="+o),d=setInterval(function(){r.closed&&(clearInterval(d),m.models.todoListManager.doFetchIfNeeded(!0))},250)}}}),m.commands.CleanLocalStorage=m.models.Command.extend({defaults:{id:"clean.localstorage"},initialize:function(){this.twoDaysAgo=Date.now()-1728e5},execute:function(){var e=this,t=localStorage.getItem("last_cleanup");if(!(t>this.twoDaysAgo))var i=setTimeout(function(){try{var t=0;if(!m||!m.collect||!m.collect.backgrounds)return;clearTimeout(i);for(var n=[],o=!1,s=null,a=0;a<localStorage.length;a++)o=!1,s=localStorage.key(a),"archived-"==s.substring(0,9)&&(o=!0),"fallback-"==s.substring(0,9)&&(o=!0),"image_displayed-"==s.substring(0,16)&&(o=!0),"weather-loc-"==s.substring(0,12)?o=!0:"ddl-bg-"==s.substring(0,7)?localStorage.getItem(s)<e.twoDaysAgo&&(o=!0):"ddl-qt-"==s.substring(0,7)&&localStorage.getItem(s)<e.twoDaysAgo&&(o=!0),o&&n.push(s);for(var a=0;a<n.length;a++)localStorage.removeItem(n[a]);t+=n.length,t+=e.collectionCleaner(m.collect.backgrounds),t+=e.collectionCleaner(m.collect.quotes),t+=e.collectionCleaner(m.collect.shortquotes),m.commandManager.execute("clean.localstorage.addin"),localStorage.setItem("last_cleanup",Date.now())}catch(l){}},500)},collectionCleaner:function(e,t){var i=this;if(e){t=t||"forDate",entriesToClean=[],e.each(function(e){var n=e.get(t);Date.parse(n)<i.twoDaysAgo&&entriesToClean.push(n)});for(var n=0;n<entriesToClean.length;n++){var o=e.get(entriesToClean[n]);o.destroy()}return entriesToClean.length}return 0}}),m.commands.CleanupUserData=m.models.Command.extend({defaults:{id:"user.cleanup"},execute:function(e,t){e&&e.type&&("notifications"==e.type?this.cleanNotifications():"all"==e.type&&this.cleanUserData()),t&&t()},cleanNotifications:function(){for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,i=localStorage.key(n),i.startsWith("momentum-messages")?t=!0:"ts_notifications"==i&&(t=!0),t&&e.push(i);for(var n=0;n<e.length;n++)localStorage.removeItem(e[n])},cleanUserData:function(){for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,i=localStorage.key(n),"notes"==i?t=!0:i.startsWith("momentum-messages")?t=!0:"notes-"==i.substring(0,6)?t=!0:"cachedTodoProviders"==i?t=!0:"cachedFocus"==i?t=!0:"f3t6b23d"==i?t=!0:"current-countdown"==i?t=!0:"countdowns"==i?t=!0:"countdowns-"==i.substring(0,11)?t=!0:"activeTodoProvider"==i?t=!0:"activeTodoListId-"==i.substring(0,17)?t=!0:"font-"==i.substring(0,5)?t=!0:"listCache-"==i.substring(0,10)?t=!0:"tsCachedTodoProviders"==i?t=!0:"ts_notifications"==i?t=!0:"todos-updated"==i&&(t=!0),t&&e.push(i);for(var n=0;n<e.length;n++)localStorage.removeItem(e[n])}}),m.commands.LoadAddins=m.models.Command.extend({defaults:{id:"addins.load"},execute:function(e){if(e){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.length;i++){var t=e[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}}),m.commands.AccountLogin=m.models.Command.extend({defaults:{id:"account.login"},execute:function(e,t,i){localStorage.token?m.commandManager.execute("notification.show.enhanced",{message:"You are already logged in.",viewLimit:1,priority:2}):(m.commandManager.execute("user.cleanup",{type:"notifications"}),localStorage.doLoginOnNextLoad=!0,window.location.reload())}}),m.commands.Logout=m.models.Command.extend({defaults:{id:"logout"},execute:function(){var e=this;if(m.commandManager.execute("user.cleanup",{type:"all"}),localStorage.token&&localStorage.token_uuid){var t={token:localStorage.token,token_uuid:localStorage.token_uuid};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/logout"}).done(function(e){}).fail(function(e,t){}).always(function(t,i){localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),m.conditionalFeatures.clearFeatures(),e.showLogoutMessageAndReload()})}else localStorage.removeItem("token"),this.showLogoutMessageAndReload()},showLogoutMessageAndReload:function(e){localStorage.setItem("loggedOut",Date.now()),m.commandManager.execute("notification.show.enhanced",{message:"You have been logged out.",display_time:5e3,viewLimit:1,priority:2},function(){window.location.reload()},!0)}}),m.commands.SyncEnable=m.models.Command.extend({defaults:{id:"sync.enable"},execute:function(e,t,i){var n=m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks");n||localStorage.token&&m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){window.location.reload()},function(){m.commandManager.execute("notification.show.enhanced",{message:"Unable to enable account sync. Reload the tab and try again, or check our help site.",viewLimit:1,priority:2})})}}),m.commands.WindowNavigate=m.models.Command.extend({defaults:{id:"window.navigate"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&(window.location.href=i)}}}),m.commands.WindowOpen=m.models.Command.extend({defaults:{id:"window.open"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&window.open(i,t.windowName||"_blank")}}}),m.commands.SettingsColorPicker=m.models.Command.extend({defaults:{id:"settings.color.picker"},initialize:function(){this.views=[]},execute:function(e,t){if(t&&t.settingName){var i=_.findWhere(this.views,{settingName:t.settingName});return i||(i=new m.views.settings.ColorPicker(t.settingName,e,t),this.views.push(i)),i}return null}}),m.commands.SettingsDisplay=m.models.Command.extend({defaults:{id:"settings.display"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.showSettings(t)}}),m.commands.SettingsDisplayUpgrade=m.models.Command.extend({defaults:{id:"settings.display.upgrade"},execute:function(e,t,i){var n="https://momentumdash.com/plus?utm_source=extension";t&&t.source?n+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(n+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:n})}}),m.commands.SettingsDisplayUpgradePanel=m.models.Command.extend({defaults:{id:"settings.display.upgrade.panel"},execute:function(e,t,i){m.views.settings.mainSettings&&(t=t||{},t.section="upgrade",m.views.settings.mainSettings.showSettings(t))}}),m.commands.SettingsToggle=m.models.Command.extend({defaults:{id:"settings.toggle"},execute:function(e,t){t&&t.section?(m.views.settings.mainSettings.toggleVisible(),m.views.settings.mainSettings.visible&&m.views.settings.mainSettings.showSettings(t)):m.views.settings.mainSettings&&m.views.settings.mainSettings.toggleVisible()}}),m.commands.SettingsHide=m.models.Command.extend({defaults:{id:"settings.hide"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.hideSettings()}}),m.commands.SettingEnable=m.models.Command.extend({defaults:{id:"setting.enable"},execute:function(e,t){if(t&&t.name){var i={};i[t.name]=!!t.value,m.models.customization.set(i)}}}),m.commands.SettingsCacheUpgradeCopy=m.models.Command.extend({defaults:{id:"settings.cache.upgradecopy"},fetching:!1,fetched:!1,execute:function(e,t){var i=this;if((e||!m.conditionalFeatures.featureEnabled("plus"))&&(e||!i.fetching&&!i.fetched)){i.fetching=!0;var n=m.globals.urlRootApi+"settings/upgradecopy";t&&e?n=n+"?refresh=1&src="+encodeURIComponent(t):t?n=n+"?src="+encodeURIComponent(t):e&&(n+="?refresh=1"),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:n}).done(function(e){i.fetching=!1,e&&(i.fetched=!0,localStorage.setItem("cachedUpgradeCopy",JSON.stringify(e)),m.trigger("settings:upgradeCopyChanged"))}).fail(function(e,t){i.fetched=!1,i.fetching=!1}),setTimeout(function(){i.fetching&&(i.fetching=!1)},1e4)}}}),m.commands.TodoMove=m.models.Command.extend({defaults:{id:"todo.move.id"},execute:function(e,t){var i=e.collection.parentList.collection.findWhere({id:t.target_id}),n={};e.collection.parentList.isTodayList()?m.utils.mergeObjects(n,e.getTodayStateChanges(!1)):e.collection.parentList.isDoneList()&&m.utils.mergeObjects(n,e.getDoneStateChanges(!1)),i.isTodayList()?m.utils.mergeObjects(n,e.getTodayStateChanges(!0)):i.isDoneList()&&m.utils.mergeObjects(n,e.getDoneStateChanges(!0)),i.isTodayList()||i.isDoneList()||m.utils.mergeObjects(n,{listId:t.target_id}),e.attemptSave(n),i.changeCount(!0),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t){return!!t&&e.get("listId")!=t.target_id}}),m.commands.TodoDoneAndArchive=m.models.Command.extend({defaults:{id:"todo.done.archive"},execute:function(e,t){e.setDoneState(!0,!0),e.collection.parentList.collection.findWhere({id:"1-done"}).changeCount(!0)},canExecute:function(e,t,i){return!i.selectedList().isDoneList()}}),m.commands.TodoToggleToday=m.models.Command.extend({defaults:{id:"todo.toggle.today"},execute:function(e,t,i){var n=!e.get("today");e.setTodayState(n),"today"!=e.collection.parentList.get("type")&&e.collection.parentList.collection.findWhere({type:"today"}).changeCount(n),"today"==e.collection.parentList.get("type")&&e.collection.parentList.collection.findWhere({id:e.get("homeListId")}).changeCount(!n)},canExecute:function(e,t,i){return!(e.collection.parentList.id==e.get("homeListId")&&e.get("today")||i.selectedList().isDoneList())},getProperties:function(e,t,i){var n=e.collection.parentList.collection.findWhere({id:e.get("homeListId")});return n?{captionText:"Move to "+(e.get("today")?n.get("title"):"Today")}:{captionText:null}}}),m.commands.TodoUnDone=m.models.Command.extend({defaults:{id:"todo.undone"},execute:function(e,t,i){e.get("archive");e.setDoneState(!1),e.collection.parentList.collection.findWhere({id:e.get("homeListId")}).changeCount(!0),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t,i){return i.selectedList().isDoneList()},getProperties:function(e,t,i){var n=e.collection.parentList.collection.findWhere({id:e.get("homeListId")});return n?{captionText:"Move to "+(e.get("today")?"Today":n.get("title"))}:{captionText:null}}}),m.commands.TodoArchive=m.models.Command.extend({defaults:{id:"todo.archive"},execute:function(e,t,i){e.get("archive");e.setArchiveState(!0)},canExecute:function(e,t,i){return!i.selectedList().isDoneList()&&e.get("done")}}),m.commands.TodoArchiveAlways=m.models.Command.extend({defaults:{id:"todo.archive.always"},execute:function(e,t,i){e.get("archive");e.setArchiveState(!0)},canExecute:function(e,t,i){return!0}}),m.commands.TodoDelete=m.models.Command.extend({defaults:{id:"todo.delete"},execute:function(e){e.deleteItem(),m.trigger("todo:loadingStateChange")},canExecute:function(e,t){return!0}}),m.commands.TodoMoveTo=m.models.Command.extend({defaults:{id:"todo.moveTo"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var e=[],t=this;return this.parentContext.listCollection.map(function(i){if(t.parentContext.selectedList().id!=i.id){var n={};n.listId=i.id,n.captionText=i.get("title"),n.count=i.get("count"),e.push(n),i.isDoneList()&&(n.commandId="todo.done.archive"),n.commandId||(n.commandId="todo.move.id"),n.options={target_id:i.id}}}),{title:null,items:new Backbone.Collection(e)}}}),m.commands.MenuIgnore=m.models.Command.extend({defaults:{id:"menu.ignore"},execute:function(e){return!0},canExecute:function(e,t){return!0}}),m.commands.TodoDeleteWarn=m.models.Command.extend({defaults:{id:"todo.delete.warn"},execute:function(e){return!0},canExecute:function(e,t){return!0},getSubmenu:function(){return{title:"Delete?",items:new Backbone.Collection([{captionText:"Yes",commandId:"todo.delete"},{captionText:"No",commandId:"menu.ignore",css_class:"dropdown-detail-back"}])}}}),m.commands.TodoFocusPin=m.models.Command.extend({defaults:{id:"todo.focus.pin"},execute:function(e){m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var t=getActiveDateString(),i={todoId:e.id,listId:e.get("listId"),forDate:t};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(i),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"focus/pin"}).done(function(e){e.success&&1==e.success&&(m.views.focuses.successfulConnection(),m.models.customization.get("autoFocus")?m.models.customization.set("autoFocus",!1):m.collect.focuses.fetch({reset:!0}))}).fail(function(e,t){})},canExecute:function(e,t){return!e.get("done")}}),m.commands.TodoRetryConnection=m.models.Command.extend({defaults:{id:"todo.connection.retry"},execute:function(e){m.models.todoListManager&&m.models.todoListManager.doFetchIfNeeded(!0)}}),m.commands.ToggleAutoFocus=m.models.Command.extend({defaults:{id:"todo.toggle.autofocus"},execute:function(e){m.conditionalFeatures.featureEnabled("pinfocus")?m.models.customization.toggle("autoFocus"):m.commandManager.execute("settings.display",null,{section:"upgrade",source:"autofocus"})}}),m.commands.ToggleKeepTodoState=m.models.Command.extend({defaults:{id:"todo.toggle.keepstate"},execute:function(e){m.models.customization.toggle("keepTodoState"),m.models.customization.get("keepTodoState")||(localStorage.showTodoList=!1)}}),m.commands.EditTodo=m.models.Command.extend({defaults:{id:"todo.edit"},execute:function(e){e.trigger("todo:edit")}}),m.commands.TodoListDefaultCommand=m.models.Command.extend({defaults:{id:"todo.list.defaultcommand"},execute:function(e,t){return t&&t.get("done")?{captionText:"Archive to Done",commandId:"todo.move.done"}:{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}}}}),m.commands.TodoListArchiveAllDone=m.models.Command.extend({defaults:{id:"todo.list.archive"},execute:function(e,t){if(e&&!e.isDoneList()){var i=e.itemCollection.models;_.each(i,function(e){e.get("done")&&!e.get("archive")&&e.archive()})}},canExecute:function(e){if(e&&e.isDoneList())return!1;var t=e.itemCollection;return!!(t&&t.completedCount()>0)}}),m.commands.TodoProviderChange=m.models.Command.extend({defaults:{id:"settings.todo.provider.change"},execute:function(e,t){t&&t.provider_id&&m.models.todoListManager.changeProvider(t.provider_id)},canExecute:function(e,t){return t.provider_id!=m.models.todoListManager.activeProvider.id}}),m.commands.TodoListCheckStateAssigned=m.models.Command.extend({defaults:{id:"todo.list.check.state.assigned"},execute:function(e,t,i){var n=e.collection.selectedListId,o=m.models.customization.get("assigned-"+n);return!!o}}),m.commands.TodoListCheckToggleAssigned=m.models.Command.extend({defaults:{id:"todo.list.check.toggle.assigned"},execute:function(e,t){var i=e.collection.selectedListId,n=m.models.customization.get("assigned-"+i);return m.models.customization.set("assigned-"+i,!n),!1}}),m.commands.TodoTrelloAuxData=m.models.Command.extend({defaults:{id:"todo.trello.aux"},execute:function(e,t){var i={};return e.collection&&e.collection.parentList&&(i.showAssignedOnly=m.models.customization.get("assigned-"+e.collection.parentList.id)),i}}),m.commands.TodoTrelloOpenConfig=m.models.Command.extend({defaults:{id:"todo.trello.config"},execute:function(){m.commandManager.execute("settings.display",null,{section:"trello"})}}),m.commands.WeatherProcessFetched=m.models.Command.extend({defaults:{id:"weather.process.fetched"},execute:function(e,t){}}),m.commands.WeatherUpdate=m.models.Command.extend({
defaults:{id:"weather.update"},locationMigrated:!1,execute:function(e,t){if(!this.locationMigrated){var i=this.getManualWeatherLocation();if(i){if(e.has("manualLocation"))return this.locationMigrated=!0,e.unset("manualLocation"),void e.save({})}else{var n=e.get("manualLocation");if(n&&n.length>0)return i={enteredLocation:n,woeid:null,location_name:null},localStorage.setItem("manual-weather-location",JSON.stringify(i)),this.locationMigrated=!0,e.unset("manualLocation"),void e.save({})}this.locationMigrated=!0}this.updateWeather(e)},updateWeather:function(e){function t(){navigator.geolocation.getCurrentPosition(n,o)}function i(t){var i={};e.get("location")!=t.location_name&&(i.location=t.location_name),e.get("woeid")!=t.woeid&&(i.woeid=t.woeid),e.set(i)}function n(e){try{var t=!0,n=d.getLastWeatherLocation();n&&+n.latitude.toFixed(3)==+e.coords.latitude.toFixed(3)&&+n.longitude.toFixed(3)==+e.coords.longitude.toFixed(3)&&(t=!1,i(n),r(n.woeid)),t&&l("("+e.coords.latitude+","+e.coords.longitude+")",e.coords)}catch(o){console.log(o)}}function o(t){console.log("Error getting location: "+t.code+", msg: "+t.message);var i=d.getManualWeatherLocation();i?l():e.save("error","location error")}function s(e){var t={woeid:e.woeid};return e.locality1&&e.locality1.content?t.city=e.locality1.content:t.city=e.name,e.country&&(t.countrycode=e.country.code),t}function a(t){var i="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(t)+"%22&format=json";$.getJSON(i,function(i){var n=i.query.count,o=null,a=!1;if(n>1?(a=!0,o=s(i.query.results.place[0])):1==n?i.query.results.place&&(a=!0,o=s(i.query.results.place)):e.save("error","not found"),a){var l={enteredLocation:t,woeid:o.woeid,location_name:o.city};localStorage.setItem("manual-weather-location",JSON.stringify(l))}if(o&&o.countrycode&&(e.get("location")||d.setUnit(o.countrycode,e),localStorage.country=o.countrycode),o){var c=o.city,h=o.woeid;e.save({location:c,woeid:h,error:null}),r(h)}}).error(function(e){console.log("Error getting WoeID")})}function l(t,i){var n=d.getManualWeatherLocation();n&&(t=n.enteredLocation);var o="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(t)+"%22&format=json";$.getJSON(o,function(t){var n=t.query.count,o=null;if(n>1)validYQLResult=!0,o=s(t.query.results.place[0]);else if(1==n)t.query.results.place&&(validYQLResult=!0,o=s(t.query.results.place));else{var a=d.getLastWeatherLocation();a?o={woeid:a.woeid,city:a.location}:e.save("error","not found")}try{if(validYQLResult&&i){var l={latitude:i.latitude,longitude:i.longitude,woeid:o.woeid,location_name:o.city};localStorage.setItem("last-weather-location",JSON.stringify(l)),m.commandManager.execute("weather.process.fetched",i,t.query.results)}}catch(c){console.log(c)}if(o&&o.countrycode&&(e.get("location")||d.setUnit(o.countrycode,e),localStorage.country=o.countrycode),o){var a=o.city,h=o.woeid;e.save({location:a,woeid:h,error:null}),r(h)}}).error(function(e){console.log("Error getting WoeID")})}function r(t){var i=d.displayUnit();i||(i="c");var n=i,o="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+t+' and u="'+i+'"')+"&format=json";$.getJSON(o,function(t){if(t&&t.query&&1==t.query.count){var i=t.query.results.channel.item.condition,o=t.query.results.channel.units;o&&o.temperature&&(n=o.temperature.toLowerCase()),i&&e.save({fetchTemperature:i.temp,fetchUnit:n,code:i.code,condition:i.text,updated:new Date,error:null})}}).error(function(e){console.log("Error getting weather data: "+e)})}var d=this,c=this.getManualWeatherLocation();c?c.woeid?(i(c),r(c.woeid)):a(c.enteredLocation):t()},setUnit:function(e,t){var i=["US","BM","BZ","JM","PW"];i.indexOf(e)>=0?t.save("fetchUnit","f"):t.save("fetchUnit","c")},getLastWeatherLocation:function(){var e=localStorage.getItem("last-weather-location");return e?JSON.parse(e):null},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e?e:"c"},getManualWeatherLocation:function(){var e=localStorage.getItem("manual-weather-location");return e?JSON.parse(e):null}}),m.isValidDate=function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},m.models.Date=Backbone.Model.extend({defaults:function(){var e=new Date;return{date:e}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this)},startUpdateTimer:function(){this.dateIntervalId=setInterval(function(){m.models.date.set("date",new Date)},100)},getTimeString:function(e){var t=m.models.customization.get("hour12clock");e=e||this.get("date");var i=e.getHours(),n=e.getMinutes();return 1==t&&(i=(i+11)%12+1),i<10&&!t&&(i="0"+i),n<10&&(n="0"+n),i+":"+n},getTimePeriod:function(){return this.get("date").getHours()>=12?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!=e&&this.set("time",e)}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){this.$loading=$('<span class="overlay loading todo-loading""><i class="loading-icon"></i> Loading...</span>'),m.models.themeManager=new m.models.ThemeManager,m.models.customization.fetch({error:function(){m.models.customization.save(),m.models.themeManager.initializeThemes()},success:function(){m.models.themeManager.initializeThemes()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.backgroundManager=new m.models.BackgroundManager,m.views.background=new m.views.Background({region:"background"}),m.views.backgroundInfo=new m.views.BackgroundInfo({region:"bottom-left"}),m.models.backgroundManager.firstFetch(),m.models.notificationManager=new m.models.NotificationManager,m.bootstrappers.InitializeQuote(m,$),m.models.date&&m.models.date.startUpdateTimer(),this.newDayIntervalId=setInterval(function(){if(localStorage.activeDate){if(localStorage.activeDate!=getActiveDateString()){var e=9e3*Math.random()+1e3;setTimeout(function(){localStorage.activeDate=getActiveDateString(),m.trigger("newDay")},e)}}else localStorage.activeDate=getActiveDateString()},1e4),!m.models.customization.get("displayname")||localStorage.doLoginOnNextLoad?m.views.introduction=new m.views.Introduction({region:"full"}):(m.bootstrappers.InitializeFocus(m,$),this.render());var e=$("body"),t=new Dragster(document.body);m.conditionalFeatures.featureEnabled("custom-bg")&&!m.models.customization.get("disableDrop")&&(this.addEventHandler(document.body,"dragover",function(e){e.stopPropagation(),e.preventDefault(),_.contains(e.dataTransfer.types,"Files")?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none"}),document.addEventListener("dragster:enter",function(t){_.contains(t.detail.dataTransfer.types,"Files")&&e.addClass("drop")},!1),document.addEventListener("dragster:leave",function(t){e.removeClass("drop")},!1),this.addEventHandler(document.body,"drop",function(i){if(i.stopPropagation(),i.preventDefault(),e.removeClass("drop"),t.removeListeners(),t=new Dragster(document.body),_.contains(i.dataTransfer.types,"Files")){if(!m.conditionalFeatures.featureEnabled("custom-bg")){var n={targetRegion:"settings",sourceEvent:"customBackgrounds-dropFiles",buttonText:"Learn more",title:"Custom Backgrounds",description:"Add your own backgrounds with Plus"};return void m.commandManager.execute("upsell.message",n)}var o=i.dataTransfer.files;o&&o.length>0&&m.commandManager.ensureCommandLoaded("background.custom.uploadfiles",function(){m.commandManager.execute("background.custom.uploadfiles",o)},null,function(e){})}})),this.initializeCompleted=!0},addEventHandler:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},processAddIns:function(){var e=this;e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending(),m.conditionalFeatures.featureEnabled("randomWidget")&&(m.models.genericMetric=new m.models.GenericMetric,m.views.genericMetric=new m.views.GenericMetric({model:m.models.genericMetric,region:"top-right",order:"prepend"}),m.widgets.push(m.views.genericMetric)))},50)},render:function(e){m.bootstrappers.RenderQuote(m,$,e),m.bootstrappers.RenderFocus(m,$,e),m.views.backgroundInfo&&(m.views.backgroundInfo.parentReady(e),m.widgets.push(m.views.backgroundInfo)),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.models.notificationManager.setParent(m.views.settingsPane),m.bootstrappers.RenderSearch(m,$),m.bootstrappers.RenderQuickLinks(m,$),m.views.greeting=new m.views.Greeting({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.greeting),m.views.centerClock=new m.views.CenterClock({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.centerClock),m.bootstrappers.RenderTodos(m,$),m.bootstrappers.RenderWeather(m,$)},getViewById:function(e){var t=null;return _.each(m.widgets,function(i){i.el.id===e&&(t=i)}),t},removeView:function(e){_.each(m.widgets,function(t){t.el.id===e&&t.$el.fadeTo(500,0,function(){t.remove(),m.widgets.splice(m.widgets.indexOf(t),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.fadeTo(500,0,function(){e.remove()})}),m.widgets=[],_.delay(e,475)}}),$(function(){var e=function(){try{for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<1e3;i++)e+=t.charAt(Math.floor(Math.random()*t.length));localStorage.setItem("capacityTest",e),localStorage.removeItem("capacityTest")}catch(n){try{localStorage.removeItem("capacityTest");for(var o=Date.now()-1728e5,s=[],a=!1,l=null,i=0;i<localStorage.length;i++)a=!1,l=localStorage.key(i),"last_cleanup"==l.substring(0,12)&&(a=!0),"archived-"==l.substring(0,9)&&(a=!0),"fallback-"==l.substring(0,9)&&(a=!0),"listCache-"==l.substring(0,10)&&(a=!0),"font-"==l.substring(0,5)&&(a=!0),"image_displayed-"==l.substring(0,16)&&(a=!0),"weather-loc-"==l.substring(0,12)?a=!0:"ddl-bg-"==l.substring(0,7)?localStorage.getItem(l)<o&&(a=!0):"ddl-qt-"==l.substring(0,7)&&localStorage.getItem(l)<o&&(a=!0),a&&s.push(l);for(var i=0;i<s.length;i++)localStorage.removeItem(s[i])}catch(n){}}};e(),m.utils.captionFormatter=function(e){return e},m.utils.setMomentumAuthHeader=setMomentumAuthHeader,m.utils.validateEmail=validateEmail,m.utils.getQueryParameter=getQueryParameter,m.utils.getActiveDateString=getActiveDateString,m.utils.activeDateStringForDate=activeDateStringForDate,m.utils.twoDigit=twoDigit,m.utils.mergeObjects=function(e,t,i){e=e||{};for(var n in t)e[n]=i?e[n]||t[n]:t[n];return e},m.utils.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},m.utils.toTodaysTime=function(e){var t=new Date,i=e.indexOf(":"),n=e.substring(0,i);return n=12==n?0:n,t.setHours(parseInt(n)+("p"===e[e.length-2].toLowerCase()?12:0)),t.setMinutes(parseInt(e.substring(i+1,e.length-2))),t},m.utils.memberwiseCompareObject=function(e,t,i){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if((!i||!_.contains(i,n))&&e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!Object.equals(e[n],t[n]))return!1}}for(n in t)if((!i||!_.contains(i,n))&&t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0},m.models.date=new m.models.Date;var t=function(){var e="installed-"+m.globals.version;localStorage.getItem(e)||localStorage.setItem(e,!0),window.onblur=function(){m.trigger("globalEvent:windowBlur")},$(document).click(function(e){m.trigger("globalEvent:click",e)}),$(document).keyup(function(e){27==e.keyCode&&m.trigger("globalEvent:esc",e),32==e.keyCode&&this.focusingOnBg&&(this.focusingOnBg=!1,m.views.backgroundInfo.unfocusBg(),$(".background-info-title, .background-info-source").removeClass("hotkey-hover"))}),$(document).keydown(function(e){if(8==e.keyCode&&e.shiftKey&&e.metaKey&&m.trigger("globalEvent:metaBackspace",e),13==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaEnter",e),219==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketLeft",e),221==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketRight",e),78==e.keyCode&&e.ctrlKey&&m.trigger("globalEvent:ctrlN",e),!(e.ctrlKey||e.metaKey||e.altKey&&78!=e.keyCode||"INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName||1==document.activeElement.isContentEditable)){if(76==e.keyCode)var t="Quick Links";else if(70==e.keyCode)var t="Focus";else if(84==e.keyCode)var t="Todo";else if(83==e.keyCode)var t="Search";else if(188==e.keyCode){if(e.metaKey)return;var t="Settings"}else{if(67==e.keyCode){var t="Chrome Tab";return m.sendEvent(t,"Hotkey"),void chrome.tabs.update({url:"chrome-search://local-ntp/local-ntp.html"})}if(8==e.keyCode)m.trigger("globalEvent:key:backspace",e);else if(13==e.keyCode)m.trigger("globalEvent:key:enter",e);else if(32==e.keyCode){if(m.trigger("globalEvent:spacebar",e),m.views.todoPane&&m.views.todoPane.isHovered)return;this.focusingOnBg=!0,m.views.backgroundInfo.focusOnBg(),$(".background-info-title, .background-info-source").addClass("hotkey-hover")}else 38==e.keyCode?m.trigger("globalEvent:arrowUp",e):40==e.keyCode?m.trigger("globalEvent:arrowDown",e):37==e.keyCode?m.trigger("globalEvent:arrowLeft",e):39==e.keyCode?m.trigger("globalEvent:arrowRight",e):78==e.keyCode?m.trigger("globalEvent:key:N",e):e.shiftKey&&191==e.keyCode&&m.commandManager.execute("settings.toggle",null,{section:"help"})}t&&(m.trigger("globalEvent:toggle"+t.replace(/\s+/g,"")),m.sendEvent(t,"Toggle Show","Hotkey"),e.preventDefault())}}),"safari"==m.globals.platform&&$("a").on("click",function(e){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})}),m.addinManager=new m.models.AddinManager,m.commandManager=new m.CommandManager,m.settingsManager=new m.models.SettingsManager,m.widgetManager=new m.models.WidgetManager,m.appView=new m.views.Dashboard,$(window).resize(function(){m.trigger("globalEvent:window:resize")}),localStorage.client_uuid||$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!=e.client_uuid&&(localStorage.client_uuid=e.client_uuid,m.trigger("client:id_created"))}).fail(function(e,t){}),m.syncCoordinator=new m.models.SyncCoordinator,window.addEventListener("storage",function(e){if("activeDate"==e.key&&e.oldValue!=e.newValue){var t=9e3*Math.random()+1e3;setTimeout(function(){m.trigger("newDay")},t)}}),localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),function(){var e={sampleRate:1};ga("create",m.globals.googleAnalyticsCode,"auto",e),ga("set","checkProtocolTask",function(){}),ga("require","displayfeatures"),ga("send","pageview","/dashboard.html?v="+m.globals.version)}(),m.syncCoordinator.syncSettings()};m.models.customization=new m.models.ComputedSettings({id:1}),m.listenToOnce(m.models.customization,"initialized",t),m.models.customization.initializeSettings()}),function(e,t,i,n,o,s,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,s=t.createElement(i),a=t.getElementsByTagName(i)[0],s.async=1,s.src=n,a.parentNode.insertBefore(s,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga");